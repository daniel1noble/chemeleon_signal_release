---
title: "Evolution of a conspicuous dynamic visual signal in an introduced chameleon"
author: Whiting et al. 
date: "`r Sys.Date()`"
bibliography: refs.bib
csl: science.csl
output: 
  bookdown::word_document2:
    toc: no
    toc_depth: 6
    number_sections: true
    reference_docx: template.docx
  bookdown::html_document2:
    code_folding: hide
    number_sections: no
    toc: yes
    toc_depth: 6
    toc_float: yes
    bibliography: refs.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, message = FALSE, warning = FALSE, tidy = TRUE, fig.width = 10)
## numbers >= 10^5 will be denoted in scientific notation,      ## numbers >= 10^5 will be denoted in scientific notation,
  ## and rounded to 2 digits      ## and rounded to 2 digits
  options(digits = 2)
```

```{r getlibrary, echo = FALSE, results = "hide"}
# load libraries
devtools::install_github("karthik/wesanderson")
pacman::p_load(lme4, lmerTest, ggplot2, lsmeans, emmeans, multcomp, dplyr, wesanderson, patchwork, latex2exp, png, cowplot, magick, jpeg, clubSandwich)

p_value <- function(x){
  if(x <= 0.0001) {tmp = "< 0.0001"}
  if(x <= 0.001 & x >= 0.0001) {tmp ="< 0.001"}
  if(x <= 0.01 & x >= 0.001) {tmp ="< 0.01"}
  if(x >= 0.01) {tmp =x}
  return(tmp)
}

```

```{r Models, echo = FALSE, results = "hide"}
#########################################################
# Social Context: Male-male Competition Displays
#########################################################
#Load data and clean a bit
Display_1 <- read.table("./data/Display_1.csv", 
                          header=TRUE, sep=",", dec=".", strip.white=TRUE)

# Center SVL to make intercept interpretable
Display_1$sc_SVL <- with(Display_1, scale(SVL, scale=FALSE))

#exclude bottom flank.
Display_1 <- Display_1 %>% 
              filter(!BodyRegion == "botflank") %>% as.data.frame() 

# create as factor
    Display_1$BodyRegion <- factor(Display_1$BodyRegion)

##########
## Achromatic Contrast - dL
##########
      
    # Fit the model
    ConspicDisplayAC <- lmer(dL ~ sc_SVL + Population + (1|ID), data=Display_1)
      summary(ConspicDisplayAC)
     
    # Get the coefficients, and ANOVA statistics for the paper
          coefAIC_display <- fixef(ConspicDisplayAC)[3]
            CI_AC_display <- data.frame(confint(ConspicDisplayAC))
    anovaConspicDisplayAC <- anova(ConspicDisplayAC)
    
    # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
    Display_1_IDs <- Display_1 %>% filter(!is.na(sc_SVL), !is.na(Population)) # filter out misssing data
    robust_ConspicDisplayAC <- coef_test(ConspicDisplayAC, cluster = Display_1_IDs$ID, vcov = "CR2")
    
##########
# Chromatic contrast - dS
##########
    #Fit the model
         ConspicDisplayCC <- lmer(dS ~ sc_SVL + Population + (1|ID), data=Display_1)
         summary(ConspicDisplayCC)
    
    # Get ANOVA statistics for model for the paper
         anovaConspicDisplayCC <- anova(ConspicDisplayCC)
    
    # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
    Display_1_IDs <- Display_1 %>% filter(!is.na(sc_SVL), !is.na(Population)) # filter out misssing data
    robust_ConspicDisplayCC <- coef_test(ConspicDisplayCC, cluster = Display_1_IDs$ID, vcov = "CR2")
    
#########################################################
# Social Context: Courtship Displays
#########################################################

# Load data
Courtship <- read.table("./data/Courtship_1.2.csv", 
                          header=TRUE, sep=",", dec=".", strip.white=TRUE)
    
# Center SVL do intercept is at the mean body size
Courtship$sc_SVL <- with(Courtship, scale(SVL, scale=FALSE))
    
##########
## Achromatic Contrast - dL
##########

  # Fit the model
    ConspicCourtshipAC <- lmer(dL ~ sc_SVL + Population  + (1|ID), data=Courtship)
    summary(ConspicCourtshipAC)

  # Get model stats for ppaer
       coefAIC_court <- fixef(ConspicCourtshipAC)[3]
         CI_AC_court <- data.frame(confint(ConspicCourtshipAC))
    courship_anovaAC <- anova(ConspicCourtshipAC)
    
 # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
    Courtship_IDs <- Courtship %>% filter(!is.na(sc_SVL), !is.na(Population)) # filter out misssing data
    robust_ConspicCourtshipAC <- coef_test(ConspicCourtshipAC, cluster = Courtship_IDs$ID, vcov = "CR2")

##########
# Chromatic contrast - dS
##########
    
  # Fit the model
  ConspicCourtshipCC <- lmer(dS ~ sc_SVL + Population  + (1|ID), data=Courtship)
    summary(ConspicCourtshipCC)
    
  # Get the ANOVA stats for paper
    courship_anovaCC <- anova(ConspicCourtshipCC)
 
  # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
    Courtship_IDs <- Courtship %>% filter(!is.na(sc_SVL), !is.na(Population)) # filter out misssing data
    robust_ConspicCourtshipCC <- coef_test(ConspicCourtshipCC, cluster = Courtship_IDs$ID, vcov = "CR2")
    
 #########################################################
# Predator Context: Birds and snakes
#########################################################
 Predator <- read.table("./data/Predator_2_3.csv", 
                       header=TRUE, sep=",", dec=".", strip.white=TRUE)
 
# Clean up
 Predator <- Predator %>% filter(!BodyRegion == "botflank" & !BodyRegion =='gularbot') %>% as.data.frame() #exclude bottom flank.
Predator$BodyRegion <- factor(Predator$BodyRegion) #updates levels for the variable BodyRegion

##########
## Achromatic Contrast - dL
##########

# First, if predator type varies across populations then we would predcit that whether snake and bird actually are different would depend on the population. For example, if, say, in Hawaii and Kenya birds were equally likely as predators then dL would not vary for birds across populations, but would so for snakes. This is an interaction.

  # Fit model testing this idea above
  PredatorAC_inter <- lmer(dL ~ Predator + Population + Predator:Population + (1|ID), data = Predator) 
  summary(PredatorAC_inter)
  
  # Get ANOVA stats for reporting in the paper of interaction
  anova_predators_inter <- anova(PredatorAC_inter)

# No support for an interaction. Drop interaction and fit the main effects model. Tells us that predation, regardless of whether we are talking about snakes or birds is just low in Hawaii, otherwise, we would predict that signals would evolve to match the predatory system 
  
  # Fit main effects model
    PredatorAC <- lmer(dL ~ Predator + Population + (1|ID), data = Predator) 
    summary(PredatorAC)
  
  # Grab the ANOVA summary stats
    anova_predators <- anova(PredatorAC)

  # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
    Predator_IDs <- Predator %>% filter(!is.na(Predator), !is.na(Population)) # filter out misssing data
    robust_PredatorAC <- coef_test(PredatorAC, cluster = Predator_IDs$ID, vcov = "CR2")

##########
# Chromatic contrast - dS
##########

    # First, if predator type varies across populations then we would predcit that whether snake and bird actually are different would depend on the population. For example, if, say, in Hawaii and Kenya birds were equally likely as predators then dL would not vary for birds across populations, but would so for snakes. This is an interaction.
    
    # Fit the interaction model.
    PredatorCC <- lmer(dS ~ Predator + Population + Predator:Population + (1|ID), data = Predator) 
    summary(PredatorCC)

    # Get ANOVA statistics for the paper
    anova_predators_interCC <- anova(PredatorCC)

    # Support for an interaction between predator type and population in the chromatic realm. Planned comparisons. First re-fit model
      Predator$pred_pop <- with(Predator, interaction(Predator, Population))
    PredatorCC_pred_pop <- lmer(dS ~ pred_pop + (1|ID), data = Predator) 
    summary(PredatorCC_pred_pop)
    
    # Conduct hypothesis tests of interest
    hypthesis_test <- glht(PredatorCC_pred_pop, df = 101-1, # df to get t-distribution, use number of lizards not data points
             linfct = mcp(pred_pop = c("snake.Hawaii - snake.Kenya = 0",
                                       "bird.Hawaii  - bird.Kenya = 0",
                                       "snake.Hawaii - bird.Hawaii = 0",
                                    "snake.Kenya  - bird.Kenya = 0")))
    # Get the contrasts, and statistical data for these plannned comparions.
      summary(hypthesis_test)
      CI_hyp_test <- as.data.frame(confint(hypthesis_test)$confint)

    # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
    Predator_IDs <- Predator %>% filter(!is.na(Predator), !is.na(Population)) # filter out misssing data
    robust_PredatorCC <- coef_test(PredatorCC, cluster = Predator_IDs$ID, vcov = "CR2")
      
#########################################################
# Local Adaptation: Testing for local adaptation
#########################################################
##################
# Social Context: Male-male competition
##################
DisplayBgrd <- read.table("./data/Display_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

DisplayBgrd <- DisplayBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
DisplayBgrd$BodyRegion <- factor(DisplayBgrd$BodyRegion) #updates levels for the variable BodyRegion

##########
# Achromatic Contrast - dL
##########

  # Here, we want to test if the conspicuousness of lizard signals is locally adapted to the specific background of the Kenyan and Hawaiian population. The predcition is simply that, if we were to place a Hawaiian animal against the Kenyan background that it would be far more conspicuous compared to if we place a Kenyan animal in a Hawaiian background. 

  # Fit the interaction model
  DispBgrdAC_inter <- lmer(dL ~ Population  + Background_pop + Population:Background_pop + (1|ID), data=DisplayBgrd)
  summary(DispBgrdAC_inter)
  
  # Fit the main effect model
  DispBgrdAC <- lmer(dL ~ Population  + Background_pop  + (1|ID), data=DisplayBgrd)
  summary(DispBgrdAC)
  
  # Doesn't look like an interaction, so test.
  anova(DispBgrdAC_inter, DispBgrdAC)

  # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
  robust_localAdapt <- clubSandwich::coef_test(DispBgrdAC, cluster = DisplayBgrd$ID, vcov =  "CR2")

  # Planned contrast. Fit the model in a slightly different way
  DisplayBgrd$pop_back <- with(DisplayBgrd, interaction(Population, Background_pop))
  DisplayBgrd_pop_back <- lmer(dL ~ pop_back + (1|ID), data = DisplayBgrd) 
  
  # df to get t-distribution, use number of lizards not data points
  hypthesis_test_preppop <- glht(DisplayBgrd_pop_back, df = 69-1, 
               linfct = mcp(pop_back = c("Hawaii.Kenya  -Hawaii.Hawaii = 0")))
  
  # Grab contrast stats for paper
  summary(hypthesis_test_preppop)
  p_displ_AC <- as.numeric(summary(hypthesis_test_preppop)$test$pvalues)
   CI_dis_AC <- as.data.frame(confint(hypthesis_test_preppop)$confint)
##########
# Chromatic Contrast - dS
##########

 # Here, we want to test if the conspicuousness of lizard signals is locally adapted to the specific background of the Kenyan and Hawaiian population. The predcition is simply that, if we were to place a Hawaiian animal against the Kenyan background that it would be far more conspicuous compared to if we place a Kenyan animal in a Hawaiian background. 

   # Fit the interaction model
    DispBgrdCC_inter <- lmer(dS ~ Population  + Background_pop + Population:Background_pop + (1|ID), data=DisplayBgrd)
    summary(DispBgrdCC_inter)
   
    # Fit the main effect model
          DispBgrdCC <- lmer(dS ~ Population  + Background_pop  + (1|ID), data=DisplayBgrd)
          summary(DispBgrdCC)
          
    # Looks like weak evidence for interaction    
        anova(DispBgrdCC_inter, DispBgrdCC)

    # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
      robust_DispBgrdCC <- clubSandwich::coef_test(DispBgrdCC, cluster = DisplayBgrd$ID, vcov =  "CR2")

    # Planned contrasts. Refit model in slight different form
      DisplayBgrd$pop_back <- with(DisplayBgrd, interaction(Population, Background_pop))
    DisplayBgrd_pop_backCC <- lmer(dS ~ pop_back + (1|ID), data = DisplayBgrd) 

    # Conduct hypothesis test, df to get t-distribution, use number of lizards not data points
      hypthesis_test_preppop_CC <- glht(DisplayBgrd_pop_backCC, df = 69-1, 
             linfct = mcp(pop_back = c("Hawaii.Kenya  -Hawaii.Hawaii = 0")))

    # Grab the statistics for the paper
      summary(hypthesis_test_preppop_CC)
      p_displ_CC <- as.numeric(summary(hypthesis_test_preppop_CC)$test$pvalues)
      CI_Disp_CC <- as.data.frame(confint(hypthesis_test_preppop_CC)$confint)

###################
# Social Context: Courtship
##################
CourtshipBgrd <- read.table("./data/Courtship_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

CourtshipBgrd <- CourtshipBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
CourtshipBgrd$BodyRegion <- factor(CourtshipBgrd$BodyRegion)

##########
## Achromatic Contrast - dL
##########

 # Here, we want to test if the conspicuousness of lizard signals is locally adapted to the specific background of the Kenyan and Hawaiian population. The predcition is simply that, if we were to place a Hawaiian animal against the Kenyan background that it would be far more conspicuous compared to if we place a Kenyan animal in a Hawaiian background. 

  # Fit the interaction model
    CourtshipAC_inter <- lmer(dL ~ Population  + Background_pop + Population:Background_pop + (1|ID), data=CourtshipBgrd)

  # Fit main effects model
    CourtshipAC <- lmer(dL ~ Population  + Background_pop  + (1|ID), data=CourtshipBgrd)
    summary(CourtshipAC)

  # Interaction needed? No
    anova(CourtshipAC_inter, CourtshipAC)

   # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
   robust_CourtshipAC <- clubSandwich::coef_test(CourtshipAC, cluster = CourtshipBgrd$ID, vcov =  "CR2")

  # Planned contrasts / hypothesis tests. Need to fit model a little differently
    CourtshipBgrd$pop_back <- with(CourtshipBgrd, interaction(Population, Background_pop))
    CourtshipBgrd_pop_back <- lmer(dL ~ pop_back + (1|ID), data = CourtshipBgrd) 
    
  # Hypothesis tests
      hypthesis_test_preppopCourtship <- glht(CourtshipBgrd_pop_back, df = 69-1, 
                                        # df to get t-distribution, use number of lizards not data points
             linfct = mcp(pop_back = c("Hawaii.Kenya  -Hawaii.Hawaii = 0")))

      summary(hypthesis_test_preppopCourtship)
 
  # Grab the stats for paper
      p_courtship_AC <- as.numeric(summary(hypthesis_test_preppopCourtship)$test$pvalues)
CI_AC_Courtship <- data.frame(confint(hypthesis_test_preppopCourtship)$confint)

##########
# Chromatic - dS
##########
 # Here, we want to test if the conspicuousness of lizard signals is locally adapted to the specific background of the Kenyan and Hawaiian population. The predcition is simply that, if we were to place a Hawaiian animal against the Kenyan background that it would be far more conspicuous compared to if we place a Kenyan animal in a Hawaiian background. 

  # Fit interaction model
    CourtshipCC_inter <- lmer(dS ~ Population  + Background_pop + Population:Background_pop + (1|ID), data=CourtshipBgrd)

  # Fit main effect model
      CourtshipCC <- lmer(dS ~ Population  + Background_pop  + (1|ID), data=CourtshipBgrd)
      summary(CourtshipCC)
      anova(CourtshipCC)

  # Test whether interaction is supported
    anova(CourtshipCC_inter, CourtshipCC)

  # Robust variance esatimation to correct SE's for fixed effects given spectral curves are used multiple times for generating JNDs for each individuals data. 
  robust_CourtshipCC <- clubSandwich::coef_test(CourtshipCC, cluster = CourtshipBgrd$ID, vcov =  "CR2")

  # Planned comparions
    CourtshipBgrd$pop_back <- with(CourtshipBgrd, interaction(Population, Background_pop))
  CourtshipBgrd_pop_backCC <- lmer(dS ~ pop_back + (1|ID), data = CourtshipBgrd) 

  # Specific planned comparisons, # df to get t-distribution, use number of lizards not data points
      hypthesis_test_preppopCourtshipCC <- glht(CourtshipBgrd_pop_backCC, df = 69-1, 
             linfct = mcp(pop_back = c("Hawaii.Kenya - Hawaii.Hawaii = 0")))

  # Grab summary stats for paper
    summary(hypthesis_test_preppopCourtshipCC)
    p_courtship_CC <- as.numeric(summary(hypthesis_test_preppopCourtshipCC)$test$pvalues)
    CI_CC_Courtship <- data.frame(confint(hypthesis_test_preppopCourtshipCC)$confint)
```

Martin J. Whiting $^1,*$, Brenden S. Holland $^2$, J. Scott Keogh$^3$, Daniel W.A.Noble$^3$, Katrina J. Rankin$^4$ and Devi M. Stuart-Fox$^4$

$^1$ Department of Biological Sciences, Macquarie University, Sydney, NSW 2109, Australia

# Abstract
Rapid evolution frequently follows a significant change to an organism’s environment, such as during colonization of a novel habitat. Vertebrates, including Caribbean Anolis lizards and Galapagos finches, have demonstrated a remarkable capacity for morphological change of functional traits (limb length, beak size) on ecological time scales. Traits that are sexually selected can be similarly affected, although well-documented examples from wild populations are rare. The Jackson’s chameleon (*Chamaeleo x. jacksonii*) from East Africa was inadvertently introduced to the Hawaiian island of Oahu in 1972. In its native range, Jackson’s chameleons are preyed upon by a wide range of predators, including snakes and birds, which are thought to shape the dynamics of color change in chameleons. We took advantage of the Hawaiian introduction, an environment with only a few potential predators and therefore, very low predation pressure, to test for character release of conspicuous social color signals. To test this hypothesis, we measured color change in response to multiple social and predator stimuli in wild chameleons in both Hawai’i and Kenya. We used visual modelling of colour signals to estimate signal conspicuousness to both the chameleon and predator (bird, snake) visual systems. The Hawai’i and Kenya backgrounds were a similar color, but the major difference was in brightness: the Hawai’i background was darker. As a result, chameleons from both Kenya and Hawai’i were brighter against the Hawai’i background. However, Hawai’i males were more conspicuous (courtship, display) against their own background for some body regions (mainly gular), providing evidence for character release. Also, Hawai’i males were more conspicuous (courtship, display) to snake and bird predators against their own background. We suggest that relaxing natural selection can result in signal release in systems experiencing strong sexual selection.

# Introduction

When Darwin tackled the joint problems of speciation and evolutionary change through natural selection, he was of the view that evolution was a gradual process that took place over extended time periods. This view understandably persisted for at least another 120 years following the publication of On the Origin of Species (Darwin, 1859). We now have numerous examples of evolutionary change following natural selection in both the laboratory and wild, and not only in invertebrates with short generation times. Vertebrates, including Caribbean Anolis lizards and Galapagos finches, have demonstrated a remarkable capacity for morphological change of functional traits (limb length, beak size) on ecological time scales (e.g. @losos97). Furthermore, a far more recent development since Darwin’s seminal work on natural selection is the recognition that sexual selection can also drive significant changes in phenotype over short time intervals. 

Conspicuous colour signals evolve because of the fitness advantage conferred to the signaller, and frequently becomes increasingly elaborate through a combination of male contest competition and female preference (e.g. runaway selection). However, trait exaggeration is typically halted by natural selection because there is a threshold beyond which conspicuousness is too costly. Evolution can respond to this selection pressure in a variety of ways that include shifting conspicuous signals to areas of the body that might be concealed to predators. For example, many conspicuous lizards have colourful throats and venters that they flash at conspecific receivers but which are not easily visible to raptors, which are a significant predator of lizards. Conversely, many species will balance the costs of sexual and natural selection and this is the case in Trinidadian guppies where populations living in predator-free streams are far more conspicuous than in predator-dense streams. These examples are from animals with static colour signals. A parallel solution that reduces the risk of exposure to predators is dynamic colour change because signals can be switched on and off relatively rapidly through neural or endocrine control. A wide range of invertebrates (e.g. cephalopods) and vertebrates (e.g. lizards and frogs) have convergently evolved this ability.  

Unlike animals with static colour signals, we have a poor understanding of how animals with dynamic colour change respond to predation pressure and whether relaxing predation pressure will result in an increasingly conspicuous signal. Tackling this question in the wild is particularly difficult unless we can take advantage of unplanned changes to an organism’s environment such as during colonization of a novel habitat. Living organisms are occasionally translocated great distances by human action to environments far removed from their native range. These novel environments typically have a completely different suite of organisms, including predators, and offer a unique opportunity to study signal evolution in founder populations. Jackson’s chameleons (*Chamaeleo j. xanthopholus*) are just such a case. In 1972, a shipment of chameleons was sent from Kenya to the Hawaiian island of Oahu, destined for the pet trade. The animals arrived in poor condition and were left outdoors to recover, at which point they dispersed and became established on the island. On Oahu, the number of potential predators of chameleons is few (see methods), while in Kenya they are preyed upon by a wide range bird, snake and occasionally, mammal, predators.  This accidental introduction represents a unique opportunity to study the evolution of a dynamic visual signal by comparing native (Kenya) and introduced (Oahu) chameleons. 

# Results

We manipulated both the social and predatory context chameleons encountered, in both their native Kenyan range and their introduced Hawaiian range, to test three hypotheses about colour signal evolution. Using spectrophotometry and visual modelling that relied on our understanding of the known chameleon visual system we quntified chromatic and achromatic contrast against the backgrounds in each environment (i.e., leaves and stems in Kenya and Hawaii).

Sexual selection is expected to favour more conspicuous dymamic sexual signals in Hawaii under relaxed predation because higher predation should favour cryptic signals whereas greater conspicuousness of sexual signals should be selected in social contexts. In support of this prediction, male display colouration exhibited in social contexts (i.e., male-male contests and courtship) was more conspicuous to a conspecific in Hawaii compared with Kenya (Male-Male Contests: Acromatic contrast ($dl$); $F_{`r anovaConspicDisplayAC$NumDF[2]`,`r anovaConspicDisplayAC$DenDF[2]`}$ = `r anovaConspicDisplayAC[5][2,]`, p = `r p_value(anovaConspicDisplayAC[6][2,])`; Chromatic contrast ($dS$): $F_{`r anovaConspicDisplayCC$NumDF[2]`,`r anovaConspicDisplayCC$DenDF[2]`}$ = `r anovaConspicDisplayCC[5][2,]`, p = `r p_value(anovaConspicDisplayCC[6][2,])`; Courtship displays: Acromatic contrast ($dl$); $F_{`r courship_anovaAC$NumDF[2]`,`r courship_anovaAC$DenDF[2]`}$ = `r courship_anovaAC[5][2,]`, p = `r p_value(courship_anovaAC[6][2,])`; Chromatic contrast ($dS$): $F_{`r courship_anovaCC$NumDF[2]`,`r courship_anovaCC$DenDF[2]`}$ = `r courship_anovaCC[5][2,]`, p = `r p_value(courship_anovaCC[6][2,])`), and this was  true across all body regions measured (See Supplemental Materials, table S1). Kenyan chameleons were significantly more crypic compared to introduced Hawaiian counterparts (Acromatic Contrast between Hawaiian and Kenyan Populations, Male-male contests: $\beta$ = `r coefAIC_display`, 95% CI = `r CI_AC_display[5,1]` to  `r CI_AC_display[5,2]`, df = `r summary(ConspicDisplayAC)$coefficients[3, "df"]`, t =  `r summary(ConspicDisplayAC)$coefficients[3, "t value"]`, p = `r p_value(summary(ConspicDisplayAC)$coefficients[3, "Pr(>|t|)"])`, Courtship: $\beta$ = `r coefAIC_court`, 95% CI = `r CI_AC_court[5,1]` to  `r CI_AC_court[5,2]`, df = `r summary(ConspicCourtshipAC)$coefficients[3, "df"]`, t =  `r summary(ConspicCourtshipAC)$coefficients[3, "t value"]`, p = `r p_value(summary(ConspicCourtshipAC)$coefficients[3, "Pr(>|t|)"])`, see figure 1a & b). 

As a consequence of signal release, sexual signals are expected to be more easily detected by predators (i.e., snakes and birds) in Hawaii. Differential predation pressure resulting from snake and bird predation varying would also result in populations varying in their conspicuousness to different predators.  In support of these predictions, Hawaiian chameleons were significantly more conspicous to both snake and bird predators (figure 1b & c; Achromatic Contrast: ($dl$); $F_{`r anova_predators$NumDF[2]`,`r anova_predators$DenDF[2]`}$ = `r anova_predators[5][2,]`, p = `r p_value(anova_predators[6][2,])`). Differences in chromatic contrast between populations, however,  depended on the predator (significant predator by population interaction: $F_{`r anova_predators_interCC$NumDF[3]`,`r anova_predators_interCC$DenDF[3]`}$ = `r anova_predators_interCC[5][3,]`, p = `r p_value(anova_predators_interCC[6][3,])`). Interestingly, Kenyan and Hawaiian lizards were equally detectable by snakes, but Kenyan chameleons were significantly more cryptic from birds compared to Hawaiian chamleons (figure 1c; Snakes (Hawaii-Kenya): `r CI_hyp_test[1,1]`, 95% CI = `r CI_hyp_test[1,2]` to `r CI_hyp_test[1,3]`, p = 1; Birds (Hawaii-Kenya): `r CI_hyp_test[2,1]`, 95% CI = `r CI_hyp_test[2,2]` to `r CI_hyp_test[2,3]`, p = < 0.001).

Local adaptation of sexual signals would result in Hawaiian chameleons being more conspicous to conspecifics in the Hawaiian environment compared to their native Kenyan environment. While it was not possible to conduct common garden experiments to provide definitive tests of local adaptation, our results support the local adaptation hypothesis given that Hawaiian chameleons were more conspicous to other chamleeons in the Hawaiian environment compared to the same chameleons in a Kenyan environment in both social contexts (figure 2; Contrast between Hawaiian lizard on Kenyan vs Hawaiian on Hawaiin background - Male-male contests: Achromatic ($dl$), $\beta$ = `r CI_dis_AC[1,1]`, 95% CI = `r CI_dis_AC[1,2]` to `r CI_dis_AC[1,3]`, p = `r p_value(p_displ_AC)`, Chromatic ($dS$) $\beta$ = `r CI_Disp_CC[1,1]`, 95% CI = `r CI_Disp_CC[1,2]` to `r CI_Disp_CC[1,3]`, p = `r p_value(p_displ_CC)`; Courtship: Achromatic ($dl$), $\beta$ = `r CI_AC_Courtship[1,1]`, 95% CI = `r CI_AC_Courtship[1,2]` to `r CI_AC_Courtship[1,3]`, p = `r p_value(p_courtship_AC)`, Chromatic ($dS$) $\beta$ = `r CI_CC_Courtship[1,1]`, 95% CI = `r CI_CC_Courtship[1,2]` to `r CI_CC_Courtship[1,3]`, p = `r p_value(p_courtship_CC)`).



```{r Figure1, fig.width = 14, fig.height= 14, fig.cap= "Chromatic and achromatic contrast in Just Noticiable Differences (JND), of Hawaiian and Kenyan chameleons against their respective backgrounds (i.e., average environment of stems and leaves). A & B) Contrast of male chameleons during male-male contests and courtship. JNDs are calculated based on the chameleon visual system. NS denotes non-significant contasts, whereas astericks indicates significant differences is < 0.001."}
rerun = FALSE
if(rerun){
## Make figures that average across body regions, but display Social Context

courtship_data <- Courtship %>% 
                  select(ID, Population, Colour, SVL, BodyRegion, Background, dS, dL)
  display_data <- Display_1 %>%
                  select(ID, Population, Colour, SVL, BodyRegion, Background, dS, dL)
combined_data <- rbind(courtship_data, display_data)

# Now calculate the averages for each population and Colour (i.e., context) / predation

summary_data_pred <- Predator %>%
                group_by(Predator, Population) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) 


summary_data <- combined_data %>%
                group_by(Population, Colour) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>%
                mutate(Colour = if_else(Colour == "Courtship", "Courtship", "Male-male contest"))


#Grab photos
  males <- readPNG("./photos/male_fight.png", native = TRUE)
females <- readPNG("./photos/courtship.png",  native = TRUE)
  snake <- readPNG("./photos/snake_cham.png", native = TRUE)
   bird <- readPNG("./photos/bird_cham.png",  native = TRUE)

#plots
p1 <- ggplot(summary_data, aes(x = Population, y = Mean_dS, group = Colour, color = Colour)) +
    ylim(2.5, 6.5) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Chromatic contrast (JND)") +
  annotate("segment", x = 0.85, xend = 1.85, y = 6.1, yend = 6.1, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 5.7, yend = 5.7, colour = "black") + 
  annotate("text", x = 0.85+(1.85-0.85)/2,  y = 6.2, label = "NS",  size = 6) + 
  annotate("text", x = 1.12+(2.12-1.12)/2, y = 5.8, label = "NS", size = 6) + 
  theme_bw() +
  labs(colour = "Social Context") +
  theme(legend.position = c(0.18, 0.08),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
   inset_element(males,
                left = 0.45,
                right = 0.90,
                bottom = 0.58,
                top = 0.75, ignore_tag = TRUE) + 
    inset_element(females,
                left = 0.30,
                right = 0.75,
                bottom = 0.15,
                top = 0.28, ignore_tag = TRUE) 
      #annotation_raster(males, xmin = 1.2, xmax = 1.9, ymin = 4.8, ymax = 5.3) + 
      #annotation_raster(females, xmin = 1, xmax = 1.7, ymin = 3.5, ymax = 4)

p2 <- ggplot(summary_data, aes(x = Population, y = Mean_dL, group = Colour, color = Colour)) +
  ylim(15, 45) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Achromatic contrast (JND)") +
   annotate("segment", x = 0.90, xend = 1.90, y = 40, yend = 40, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 42, yend = 42, colour = "black") + 
  annotate("text", x = 0.9+((1.90 - 0.90)/2), y = 41, label = "**",  size = 6) + 
  annotate("text", x = 1.12+((2.12 - 1.12)/ 2), y = 43, label = "**", size = 6) + 
  theme_bw() +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
    inset_element(males,
                left = 0.45,
                right = 0.90,
                bottom = 0.60,
                top = 0.75, ignore_tag = TRUE) + 
    inset_element(females,
                left = 0.05,
                right = 0.50,
                bottom = 0.25,
                top = 0.38, ignore_tag = TRUE)


p3 <- ggplot(summary_data_pred, aes(x = Population, y = Mean_dL, group = Predator, color = Predator)) +
  ylim(10, 30) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Achromatic contrast (JND)") +
   annotate("segment", x = 0.90, xend = 1.90, y = 28, yend = 28, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 26, yend = 26, colour = "black") + 
  annotate("text", x = 0.9+((1.90 - 0.90)/2), y = 28.5, label = "**",  size = 6) + 
  annotate("text", x = 1.12+((2.12 - 1.12)/ 2), y = 26.5, label = "**", size = 6) + 
  theme_bw() +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
    inset_element(snake,
                left = 0.45,
                right = 0.75,
                bottom = 0.60,
                top = 0.70, ignore_tag = TRUE) + 
    inset_element(bird,
                left = 0.05,
                right = 0.50,
                bottom = 0.25,
                top = 0.38, ignore_tag = TRUE)

p4 <- ggplot(summary_data_pred, aes(x = Population, y = Mean_dS, group = Predator, color = Predator)) +
  ylim(1, 9) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Chromatic contrast (JND)") +
   annotate("segment", x = 0.88, xend = 1.88, y = 8.8, yend = 8.8, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y =2.5, yend = 2.5, colour = "black") + 
  annotate("text", x = 0.9+((1.90 - 0.90)/2), y = 8.9, label = "**",  size = 6) + 
  annotate("text", x = 1.12+((2.12 - 1.12)/ 2), y = 2.7, label = "NS", size = 6) + 
  theme_bw() +
  theme(legend.position = c(0.10, 0.08),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
    inset_element(bird,
                left = 0.30,
                right = 0.60,
                bottom = 0.45,
                top = 0.60, ignore_tag = TRUE) + 
    inset_element(snake,
                left = 0.02,
                right = 0.32,
                bottom = 0.20,
                top = 0.35, ignore_tag = TRUE)

#pdf(file = "./output/figures/Figure1.1.pdf", width = 14, height = 14)
plot_grid(p1, p2, p4, p3, labels = c("A", "B", "C", "D"), label_size = 16,
  label_fontface = "bold", rel_widths=c(1,1))
#dev.off()
} else {
  plot(image_read_pdf("./output/figures/Figure1.pdf"))
}
```


```{r Figure2, fig.width = 14, fig.height= 9, fig.cap= "Local adaptation of chromatic and acromatic contrast for Hawaiian chameleons against Hawaiian and Kenyan backgrounds."}
rerun=FALSE

if(rerun){
##########
# Data
##########
courtship_summary <- CourtshipBgrd %>% 
                    group_by(Population, Background_pop) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>% filter(Population == "Hawaii") %>% as.data.frame() %>% mutate(Social_Context = "Courtship")

display_summary <- DisplayBgrd %>%
                group_by(Population, Background_pop) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>% filter(Population == "Hawaii") %>% as.data.frame() %>% mutate(Social_Context = "Male-male contest")

summary_data_localAdap <- rbind(courtship_summary, display_summary)

##########
# Plots
##########
#Grab photos
  males <- readPNG("./photos/male_fight.png", native = TRUE)
females <- readPNG("./photos/courtship.png",  native = TRUE)

#plots
p1.2 <- ggplot(summary_data_localAdap, aes(x = Background_pop, y = Mean_dS, group = Social_Context, color = Social_Context)) +
    ylim(2.5, 6.5) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Chromatic contrast (JND)") +
  annotate("segment", x = 0.85, xend = 1.85, y = 6.1, yend = 6.1, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 5.7, yend = 5.7, colour = "black") + 
  annotate("text", x = 0.85+(1.85-0.85)/2,  y = 6.2, label = "NS",  size = 6) + 
  annotate("text", x = 1.12+(2.12-1.12)/2, y = 5.8, label = "NS", size = 6) + 
  theme_bw() +
  labs(colour = "Social Context") +
  theme(legend.position = c(0.15, 0.08),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
   inset_element(males,
                left = 0.45,
                right = 0.90,
                bottom = 0.58,
                top = 0.75, ignore_tag = TRUE) + 
    inset_element(females,
                left = 0.30,
                right = 0.75,
                bottom = 0.15,
                top = 0.28, ignore_tag = TRUE) 

p2.2 <- ggplot(summary_data_localAdap, aes(x = Background_pop, y = Mean_dL, group = Social_Context, color = Social_Context)) +
  ylim(15, 45) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Achromatic contrast (JND)") +
   annotate("segment", x = 0.90, xend = 1.90, y = 40, yend = 40, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 42, yend = 42, colour = "black") + 
  annotate("text", x = 0.9+((1.90 - 0.90)/2), y = 41, label = "**",  size = 6) + 
  annotate("text", x = 1.12+((2.12 - 1.12)/ 2), y = 43, label = "**", size = 6) + 
  theme_bw() +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
    inset_element(males,
                left = 0.45,
                right = 0.90,
                bottom = 0.60,
                top = 0.75, ignore_tag = TRUE) + 
    inset_element(females,
                left = 0.05,
                right = 0.50,
                bottom = 0.25,
                top = 0.38, ignore_tag = TRUE)
#pdf(file="./output/figures/Figure2.pdf", height = 10, width = 18)
plot_grid(p1.2, p2.2, labels = c("A", "B"), label_size = 16,
  label_fontface = "bold", rel_widths=c(1,1))
#dev.off()
} else {
  plot(image_read_pdf("./output/figures/Figure2.pdf"))
}


```



