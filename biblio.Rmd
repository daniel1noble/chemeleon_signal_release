---
title: "Invasive chameleons released from predation display more conspicuous colors"
bibliography: supp_refs.bib
csl: science.csl
output: 
  bookdown::word_document2:
    toc: no
    toc_depth: 6
    number_sections: false
    reference_docx: template.docx
  bookdown::html_document2:
    code_folding: hide
    number_sections: no
    toc: yes
    toc_depth: 6
    toc_float: yes
    bibliography: refs.bib
---

```{r setup, include=FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, message = FALSE, warning = FALSE, tidy = TRUE, fig.width = 10)
## numbers >= 10^5 will be denoted in scientific notation,      ## numbers >= 10^5 will be denoted in scientific notation,
  ## and rounded to 2 digits      ## and rounded to 2 digits
  options(digits = 2)
```

```{r getlibrary, echo = FALSE, results = "hide"}
# load libraries
devtools::install_github("karthik/wesanderson")
pacman::p_load(lme4, lmerTest, ggplot2, lsmeans, emmeans, multcomp, dplyr, wesanderson, patchwork, latex2exp, png, cowplot, magick, jpeg, clubSandwich, flextable, readxl)
source("./R/func.R")

```

```{r Models, echo = FALSE, results = "hide"}
source("./R/func.R")
#########################################################
# Social Context: Male-male Competition Displays
#########################################################
#Load data and clean a bit
Display_1 <- read.table("./data/Display_1.csv", 
                          header=TRUE, sep=",", dec=".", strip.white=TRUE)

# Sample sizes
N_display <- data.frame(Display_1 %>% group_by(Population) %>% summarise(n = length(unique(ID))))

# Center SVL to make intercept interpretable
Display_1$sc_SVL <- with(Display_1, scale(SVL, scale=FALSE))

#exclude bottom flank.
Display_1 <- Display_1 %>% 
              filter(!BodyRegion == "botflank") %>% as.data.frame() 

# create as factor
    Display_1$BodyRegion <- factor(Display_1$BodyRegion)

##########
## Achromatic Contrast - dL
##########
      
    # Fit the model
    ConspicDisplayAC <- lmer(dL ~ sc_SVL + Population + (1|ID), data=Display_1)
      summary(ConspicDisplayAC)
     
    # Check robustness of results to non-independence using Robust Variance Estimator (RVE)
    Display_1_IDs <- Display_1 %>% filter(!is.na(sc_SVL), !is.na(Population)) # filter out missing data
       robust_ConspicDisplayAC <- coef_test(ConspicDisplayAC, 
                                            cluster = Display_1_IDs$ID, vcov = "CR2")  
    robust_ConspicDisplayAC_CI <- conf_int(ConspicDisplayAC, 
                                           cluster = Display_1_IDs$ID, vcov = "CR2")
    
     # Wald test
            Population_ConspicDisplayAC <- Wald_test(ConspicDisplayAC, 
                                             constraints = constrain_zero(3),
                                            cluster = Display_1_IDs$ID, vcov = "CR2")
    
##########
# Chromatic contrast - dS
##########
    #Fit the model
         ConspicDisplayCC <- lmer(dS ~ sc_SVL + Population + (1|ID), data=Display_1)
         summary(ConspicDisplayCC)
    
    # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
    Display_1_IDs <- Display_1 %>% filter(!is.na(sc_SVL), !is.na(Population)) # filter out misssing data
    robust_ConspicDisplayCC <- coef_test(ConspicDisplayCC, cluster = Display_1_IDs$ID, vcov = "CR2")
 robust_ConspicDisplayCC_CI <- conf_int(ConspicDisplayCC, cluster = Display_1_IDs$ID, vcov = "CR2")
    
  # Wald test
            Population_ConspicDisplayCC <- Wald_test(ConspicDisplayCC, 
                                             constraints = constrain_zero(3),
                                            cluster = Display_1_IDs$ID, vcov = "CR2")
#########################################################
# Social Context: Courtship Displays
#########################################################

# Load data
Courtship <- read.table("./data/Courtship_1.2.csv", 
                          header=TRUE, sep=",", dec=".", strip.white=TRUE)

# Sample sizes
N_Courtship <- data.frame(Courtship %>% group_by(Population) %>% summarise(n = length(unique(ID))))

# Center SVL do intercept is at the mean body size
Courtship$sc_SVL <- with(Courtship, scale(SVL, scale=FALSE))
    
##########
## Achromatic Contrast - dL
##########

  # Fit the model
    ConspicCourtshipAC <- lmer(dL ~ sc_SVL + Population  + (1|ID), data=Courtship)
    summary(ConspicCourtshipAC)
    
 # Check robustness of results to non-independence using Robust Variance Estimator (RVE)
    Courtship_IDs <- Courtship %>% filter(!is.na(sc_SVL), !is.na(Population)) # filter out missing data
    robust_ConspicCourtshipAC <- coef_test(ConspicCourtshipAC, 
                                           cluster = Courtship_IDs$ID, vcov = "CR2")
 robust_ConspicCourtshipAC_CI <- conf_int(ConspicCourtshipAC, 
                                          cluster = Courtship_IDs$ID, vcov = "CR2")
 
    # Wald test
            Population_ConspicCourtshipAC <- Wald_test(ConspicCourtshipAC, 
                                             constraints = constrain_zero(3),
                                            cluster = Courtship_IDs$ID, vcov = "CR2")

##########
# Chromatic contrast - dS
##########
    
  # Fit the model
  ConspicCourtshipCC <- lmer(dS ~ sc_SVL + Population  + (1|ID), data=Courtship)
    summary(ConspicCourtshipCC)
 
  # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
    Courtship_IDs <- Courtship %>% filter(!is.na(sc_SVL), !is.na(Population)) # filter out misssing data
       robust_ConspicCourtshipCC <- coef_test(ConspicCourtshipCC, cluster = Courtship_IDs$ID, vcov = "CR2")
    robust_ConspicCourtshipCC_CI <- conf_int(ConspicCourtshipCC, cluster = Courtship_IDs$ID, vcov = "CR2")
    
    # Wald test
            Population_ConspicCourtshipCC <- Wald_test(ConspicCourtshipCC, 
                                             constraints = constrain_zero(3),
                                            cluster = Courtship_IDs$ID, vcov = "CR2")
    
 #########################################################
# Predator Context: Birds and snakes
#########################################################
 Predator <- read.table("./data/Predator_2_3.csv", 
                       header=TRUE, sep=",", dec=".", strip.white=TRUE)
 
# Sample sizes
N_Pred <- data.frame(Predator %>% group_by(Population, Predator) %>% summarise(n = length(unique(ID)))) %>% arrange(Predator)
            
# Clean up
 Predator <- Predator %>% filter(!BodyRegion == "botflank" & !BodyRegion =='gularbot') %>% as.data.frame() #exclude bottom flank.
Predator$BodyRegion <- factor(Predator$BodyRegion) #updates levels for the variable BodyRegion

##########
## Achromatic Contrast - dL
##########

# First, if predator type varies across populations then we would predcit that whether snake and bird actually are different would depend on the population. For example, if, say, in Hawaii and Kenya birds were equally likely as predators then dL would not vary for birds across populations, but would so for snakes. This is an interaction.

  # Fit model testing this idea above
    PredatorAC_inter <- lmer(dL ~ Predator + Population + Predator:Population + (1|ID), 
                             data = Predator) 
    summary(PredatorAC_inter)
    
  #Refit main effects so we can test main effects on own.
         PredatorAC <- lmer(dL ~ Predator + Population + (1|ID), data = Predator) 
        summary(PredatorAC)
  
     # Wald tests
            back_pred_AC_Pred <- Wald_test(PredatorAC_inter, constraints = constrain_zero(4), 
                                   cluster = Predator$ID, vcov = "CR2")
           
             Predator_AC_Pred <- Wald_test(PredatorAC, constraints = constrain_zero(2), 
                                  cluster = Predator$ID, vcov = "CR2")
  
           Population_AC_Pred <- Wald_test(PredatorAC, constraints = constrain_zero(3), 
                                  cluster = Predator$ID, vcov = "CR2")
     
  # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
    Predator_IDs <- Predator %>% filter(!is.na(Predator), !is.na(Population)) # filter out misssing data
              robust_PredatorAC <- coef_test(PredatorAC, cluster = Predator_IDs$ID, vcov = "CR2")
           robust_PredatorAC_CI <-  conf_int(PredatorAC, cluster = Predator_IDs$ID, vcov = "CR2")
     robust_PredatorAC_CI_inter <-  conf_int(PredatorAC_inter, cluster = Predator_IDs$ID, vcov = "CR2")
     
  # Model allows us to get bird in Hwaii compared to bird in Kenya (contrast 3)
      Predator$pred_pop <- with(Predator, interaction(Predator, Population))
    
      PredatorAC_pred_pop1 <- lmer(dL ~  pred_pop + (1|ID), data = Predator) 
      summary(PredatorAC_pred_pop1)
      PredatorAC_pred_pop2 <- lmer(dL ~  relevel(pred_pop, ref = "snake.Hawaii") + (1|ID), data = Predator) 
      summary(PredatorAC_pred_pop2)
      
      # Fit the models so we get the estimate and corrected robust standard error for the contrasts we want to make
      robust_PredatorAC_pred_pop1 <- conf_int(PredatorAC_pred_pop1, cluster = Predator$ID, vcov="CR2")
      robust_PredatorAC_pred_pop2 <- conf_int(PredatorAC_pred_pop2, cluster = Predator$ID, vcov="CR2")
      
     # Contrasts hypothesis tests, but use RVE 
      
      PredatorAC_pred_pop <- lmer(dL ~  0+ pred_pop + (1|ID), data = Predator) 
    result_pred <- Wald_test(PredatorAC_pred_pop, constraints = constrain_pairwise(c(1:4)), 
                             vcov="CR2", tidy = TRUE)
    result_pred$p_val_bonfer <- sapply(p.adjust(result_pred$p_val, "bonferroni"), function(x) p_value(x))
    
    
    # Get the contrasts and Wald stats for comparions
     CI_hyp_testAC <- data.frame(
              comparison = c("Snake (Hawaii-Kenya)", "Birds (Hawaii-Kenya)"), 
                Estimate = c(robust_PredatorAC_pred_pop2[4,1], robust_PredatorAC_pred_pop1[3, 1]),
                lwr = c(robust_PredatorAC_pred_pop2[4,4], robust_PredatorAC_pred_pop1[3, 4]),
                upr = c(robust_PredatorAC_pred_pop2[4,5], robust_PredatorAC_pred_pop1[3, 5]),
              Fstat = c(result_pred[5,3], result_pred[2,3]),
              df = c(result_pred[5,5], result_pred[2,5]),
              p_val = c(result_pred[5,7], result_pred[2,7]),
              p_bonf = c(result_pred[5,8], result_pred[2,8]))

##########
# Chromatic contrast - dS
##########

    # First, if predator type varies across populations then we would predcit that whether snake and bird actually are different would depend on the population. For example, if, say, in Hawaii and Kenya birds were equally likely as predators then dL would not vary for birds across populations, but would so for snakes. This is an interaction.
    
    # Fit the interaction model.
    PredatorCC <- lmer(dS ~ Predator + Population + Predator:Population + (1|ID), 
                       data = Predator) 
    summary(PredatorCC)
  
    #Refit main effects so we can test main effects on own.
      PredatorCC_main <- lmer(dS ~ Predator + Population + (1|ID), data = Predator) 

     # Wald tests
            back_pred_CC_Pred <- Wald_test(PredatorCC, constraints = constrain_zero(4), 
                                   cluster = Predator$ID, vcov = "CR2")
           
             Predator_CC_Pred <- Wald_test(PredatorCC_main, constraints = constrain_zero(2), 
                                  cluster = Predator$ID, vcov = "CR2")
  
           Population_CC_Pred <- Wald_test(PredatorCC_main, constraints = constrain_zero(3), 
                                  cluster = Predator$ID, vcov = "CR2")
           
    # Support for an interaction between predator type and population in the chromatic realm. Planned comparisons. First re-fit model
      Predator$pred_pop <- with(Predator, interaction(Predator, Population))
    PredatorCC_pred_pop <- lmer(dS ~ -1 + pred_pop + (1|ID), data = Predator) 
    summary(PredatorCC_pred_pop)
    
    # Present full model
         robust_PredatorCC_CI_inter <-  conf_int(PredatorCC, cluster = Predator_IDs$ID, vcov = "CR2")
    
    # Fit RVE, we want contrast effects because annoyingly RVE doesn't provide them so will relevel to get them in the context of RVE
      
    # Model allows us to get bird in Hwaii compared to bird in Kenya (contrast 3)
      PredatorCC_pred_pop1 <- lmer(dS ~  pred_pop + (1|ID), data = Predator) 
      summary(PredatorCC_pred_pop1)
      PredatorCC_pred_pop2 <- lmer(dS ~  relevel(pred_pop, ref = "snake.Hawaii") + (1|ID), data = Predator) 
      summary(PredatorCC_pred_pop2)
      
      # Fit the models so we get the estimate and corrected robust standard error for the contrasts we want to make
      robust_PredatorCC_pred_pop1 <- conf_int(PredatorCC_pred_pop1, cluster = Predator$ID, vcov="CR2")
      robust_PredatorCC_pred_pop2 <- conf_int(PredatorCC_pred_pop2, cluster = Predator$ID, vcov="CR2")
      
     # Contrasts hypothesis tests, but use RVE 
    result_pred <- Wald_test(PredatorCC_pred_pop, constraints = constrain_pairwise(c(1:4)), vcov="CR2", tidy = TRUE)
    result_pred$p_val_bonfer <- sapply(p.adjust(result_pred$p_val, "bonferroni"), function(x) p_value(x))
    
    
    # Get the contrasts and Wald stats for comparions
     CI_hyp_test <- data.frame(
              comparison = c("Snake (Hawaii-Kenya)", "Birds (Hawaii-Kenya)"), 
                Estimate = c(robust_PredatorCC_pred_pop2[4,1], robust_PredatorCC_pred_pop1[3, 1]),
                lwr = c(robust_PredatorCC_pred_pop2[4,4], robust_PredatorCC_pred_pop1[3, 4]),
                upr = c(robust_PredatorCC_pred_pop2[4,5], robust_PredatorCC_pred_pop1[3, 5]),
              Fstat = c(result_pred[5,3], result_pred[2,3]),
              df = c(result_pred[5,5], result_pred[2,5]),
              p_val = c(result_pred[5,7], result_pred[2,7]),
              p_bonf = c(result_pred[5,8], result_pred[2,8]))

      
#########################################################
# Local Adaptation: Testing for local adaptation
#########################################################
##################
# Social Context: Male-male competition
##################
DisplayBgrd <- read.table("./data/Display_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)
svl_dat <- read.csv("./data/SVL2.csv")

DisplayBgrd <- DisplayBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
DisplayBgrd$BodyRegion <- factor(DisplayBgrd$BodyRegion) #updates levels for the variable BodyRegion

# Filter out only Hawaiian and add in SVL for IDs
DisplayBgrd <- DisplayBgrd %>% 
               filter(Population == "Hawaii") %>% 
               left_join(select(svl_dat, ID, SVL), by = "ID", keep = FALSE) %>% 
               mutate(sc_svl = scale(SVL, scale = FALSE)) %>% 
                filter(!is.na(SVL))

##########
# Achromatic Contrast - dL
##########

  # Here, we want to test if the conspicuousness of lizard signals is locally adapted to the specific background of the Kenyan and Hawaiian population. The predcition is simply that, if we were to place a Hawaiian animal against the Kenyan background that it would be far more conspicuous compared to if we place a Kenyan animal in a Hawaiian background. 

  # Fit the main effect model
  DispBgrdAC <- lmer(dL ~ sc_svl  + Background_pop  + (1|ID), data=DisplayBgrd)
  summary(DispBgrdAC)
  

  # Check robustness of results to non-independence using Robust Variance Estimator (RVE)
  robust_localAdapt_DispBgrdAC <- clubSandwich::conf_int(DispBgrdAC, cluster = DisplayBgrd$ID, vcov =  "CR2")

  # Add Wald test to test signifiacnce of each factor, background and population using roust variance
  
  background_AC_Disp <- Wald_test(DispBgrdAC, constraints = constrain_zero(3), 
                                  cluster = DisplayBgrd$ID, vcov = "CR2")
  
  svl_AC_Disp <- Wald_test(DispBgrdAC, constraints = constrain_zero(2), 
                                  cluster = DisplayBgrd$ID, vcov = "CR2")
  
 ##########
# Chromatic Contrast - dS
##########

 # Here, we want to test if the conspicuousness of lizard signals is locally adapted to the specific background of the Kenyan and Hawaiian population. The predcition is simply that, if we were to place a Hawaiian animal against the Kenyan background that it would be far more conspicuous compared to if we place a Kenyan animal in a Hawaiian background. 
   
    # Fit the main effect model
          DispBgrdCC <- lmer(dS ~ sc_svl + Background_pop  + (1|ID), data=DisplayBgrd)
          summary(DispBgrdCC)
 
    # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
      robust_DispBgrdCC <- clubSandwich::conf_int(DispBgrdCC, cluster = DisplayBgrd$ID, vcov =  "CR2")
      
    # Check significance of each factor
        background_CC_Disp <- Wald_test(DispBgrdCC, constraints = constrain_zero(3), 
                                  cluster = DisplayBgrd$ID, vcov = "CR2")
  
        svl_CC_Disp <- Wald_test(DispBgrdCC, constraints = constrain_zero(2), 
                                  cluster = DisplayBgrd$ID, vcov = "CR2")

###################
# Social Context: Courtship
##################
CourtshipBgrd <- read.table("./data/Courtship_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

CourtshipBgrd <- CourtshipBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
CourtshipBgrd$BodyRegion <- factor(CourtshipBgrd$BodyRegion)

# Filter out only Hawaiian and add in SVL for IDs
CourtshipBgrd <- CourtshipBgrd %>% 
               filter(Population == "Hawaii") %>% 
               left_join(select(svl_dat, ID, SVL), by = "ID", keep = FALSE) %>% 
               mutate(sc_svl = scale(SVL, scale = FALSE)) %>% 
               filter(!is.na(SVL))

##########
## Achromatic Contrast - dL
##########

 # Here, we want to test if the conspicuousness of lizard signals is locally adapted to the specific background of the Kenyan and Hawaiian population. The predcition is simply that, if we were to place a Hawaiian animal against the Kenyan background that it would be far more conspicuous compared to if we place a Kenyan animal in a Hawaiian background. 

  # Fit main effects model
    CourtshipAC <- lmer(dL ~ sc_svl  + Background_pop  + (1|ID), data=CourtshipBgrd)
    summary(CourtshipAC)

   # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
   robust_CourtshipAC <- clubSandwich::conf_int(CourtshipAC, cluster = CourtshipBgrd$ID, vcov =  "CR2")
   
   # Wald tests
           background_AC_Court <- Wald_test(CourtshipAC, constraints = constrain_zero(3), 
                                  cluster = CourtshipBgrd$ID, vcov = "CR2")
  
           svl_AC_Court <- Wald_test(CourtshipAC, constraints = constrain_zero(2), 
                                  cluster = CourtshipBgrd$ID, vcov = "CR2")


##########
# Chromatic - dS
##########
 # Here, we want to test if the conspicuousness of lizard signals is locally adapted to the specific background of the Kenyan and Hawaiian population. The predcition is simply that, if we were to place a Hawaiian animal against the Kenyan background that it would be far more conspicuous compared to if we place a Kenyan animal in a Hawaiian background. 


  # Fit main effect model
      CourtshipCC <- lmer(dS ~ sc_svl  + Background_pop  + (1|ID), data=CourtshipBgrd)
      summary(CourtshipCC)

  # Robust variance esatimation to correct SE's for fixed effects given spectral curves are used multiple times for generating JNDs for each individuals data. 
  robust_CourtshipCC <- clubSandwich::conf_int(CourtshipCC, cluster = CourtshipBgrd$ID, vcov =  "CR2")
  
  
   # Wald tests
           background_CC_Court <- Wald_test(CourtshipCC, constraints = constrain_zero(3), 
                                  cluster = CourtshipBgrd$ID, vcov = "CR2")
  
           svl_CC_Court <- Wald_test(CourtshipCC, constraints = constrain_zero(2), 
                                  cluster = CourtshipBgrd$ID, vcov = "CR2")

#########################################################
# Comparing displays
#########################################################
 # Load data from Devi
       Display_bird_diff <- read_excel("data/Display_bird_diff.xlsx")
       
       Diff <- Display_bird_diff 

      names(Diff) # header rows R is reading

    Diff$BodyRegion <- factor(Diff$BodyRegion) #updates levels for the variable BodyRegion
    str(diff.difftime) #how R is reading the stucture of the object, double checking the levels for body region after updating levels
    Diff$ID <- factor(Diff$ID) #updates levels for the variable ID
    str(diff.difftime) #how R is reading the stucture of the object, double checking the levels for body region after updating levels

# Center SVL to make intercept interpretable
    Diff$sc_SVL <- with(Diff, scale(SVL, scale=FALSE))

# Filter missing SVL data
  Diff <- Diff %>% filter(!is.na(SVL)) # filter out misssing SVL data

# create as factor
    Diff$BodyRegion <- factor(Diff$BodyRegion)

# Sample sizes
    N_diff <- data.frame(Diff %>% group_by(Population) %>% summarise(n = length(unique(ID))))
    
##################
# Achromatic contrast
##################
    
# Fit model testing this idea above. First just test for body region interaction. But, needs RVE
    Diff_dL_BR_int <- lmer(dL_diff_abs ~ sc_SVL + Population + BodyRegion + BodyRegion:Population + (1|ID), data=Diff)
    summary(Diff_dL_BR_int)
    
    # Refit mdoel using robust standard errors
  robust_Diff_dL_BR_int <- clubSandwich::conf_int(Diff_dL_BR_int, cluster = Diff$ID, vcov =  "CR2") 
  
    # Significance of interaction
      robust_Diff_dl_int <- Wald_test(Diff_dL_BR_int, constraints = constrain_zero(7:9), 
                                    cluster = Diff$ID, vcov = "CR2")
# Main effects BR
    Diff_dL_BR_me <- lmer(dL_diff_abs ~ sc_SVL + Population + BodyRegion  + (1|ID), data=Diff)
    summary(Diff_dL_BR_me)
    
    # Sig of Body Region
        robust_Diff_dL_BR_me <- Wald_test(Diff_dL_BR_me, constraints = constrain_zero(4:6), 
                                    cluster = Diff$ID, vcov = "CR2")
  
# Then fit marginalised model so that body regions are averaged
  Diff_dL <- lmer(dL_diff_abs ~ sc_SVL + Population + (1|ID), data=Diff)
  summary(Diff_dL)

# Check residuals of model
 # hist(residuals(Diff_dL))
 # plot(Diff_dL) # Some patterns in residuals, but likely driven by the absolute. Note that results are essentially the same if using absolute or raw, signed values. 
  
# Refit mdoel using robust standard errors
  robust_Diff_dl_BR <- clubSandwich::conf_int(Diff_dL_BR_me, cluster = Diff$ID, vcov =  "CR2") 

# Wald tests - Test significance of pop dofferences and SVL differences averaging over body regions
   
  robust_Diff_dl_pop <- Wald_test(Diff_dL, constraints = constrain_zero(3), 
                                  cluster = Diff$ID, vcov = "CR2")
   robust_Diff_dl_svl <- Wald_test(Diff_dL, constraints = constrain_zero(2), 
                                  cluster = Diff$ID, vcov = "CR2")

##################
# Chromatic contrast
##################  
   
  # Fit model testing this idea above. First just test for body region interaction. But, needs RVE
    Diff_dS_BR_int <- lmer(dS_diff_abs ~ sc_SVL + Population + BodyRegion + BodyRegion:Population + (1|ID), data=Diff)
    summary(Diff_dS_BR_int)
    
        # Refit mdoel using robust standard errors
     robust_Diff_dS_BR_int <- clubSandwich::conf_int(Diff_dS_BR_int, cluster = Diff$ID, vcov =  "CR2") 
    
     # Significance of interaction
      robust_Diff_dS_int <- Wald_test(Diff_dS_BR_int, constraints = constrain_zero(7:9), 
                                    cluster = Diff$ID, vcov = "CR2")
  # Main effects BR
    Diff_dS_BR_me <- lmer(dS_diff_abs ~ sc_SVL + Population + BodyRegion  + (1|ID), data=Diff)
    summary(Diff_dS_BR_me)
    
    # Sig of Body Region
      robust_Diff_dS_BR_me <- Wald_test(Diff_dS_BR_me, constraints = constrain_zero(4:6), 
                                    cluster = Diff$ID, vcov = "CR2")
   
# Fit model testing this idea above
  Diff_dS <- lmer(dS_diff_abs ~  SVL + Population + (1|ID), data=Diff)
  summary(Diff_dS)

# Check residuals of model
  #hist(residuals(Diff_dS))
  #plot(Diff_dS) # Some patterns in residuals, but likely driven by the absolute. Note that results are essentially the same if using absolute or raw, signed values. 
  
# Refit mdoel using robust standard errors
  robust_Diff_dS <- clubSandwich::conf_int(Diff_dS_BR_me, cluster = Diff$ID, vcov =  "CR2") 

# Wald tests - Test significance of pop dofferences and SVL differences averaging over body regions
   robust_Diff_dS_pop <- Wald_test(Diff_dS, constraints = constrain_zero(3), 
                                  cluster = Diff$ID, vcov = "CR2")
   robust_Diff_dS_svl <- Wald_test(Diff_dS, constraints = constrain_zero(2), 
                                  cluster = Diff$ID, vcov = "CR2")
   
```

Martin J. Whiting^1^, Brenden S. Holland^2^, J. Scott Keogh^3^, Daniel W.A.Noble^3^, Katrina J. Rankin^4^ and Devi Stuart-Fox^4^

^1^ Department of Biological Sciences, Macquarie University, Sydney, NSW 2109, Australia

^2^ Department of Natural Sciences, Hawaii Pacific University, Honolulu, Hawaii, USA

^3^ Division of Ecology and Evolution, Research School of Biology, The Australian National University, Canberra, ACT 2602, Australia

^4^ School of BioSciences, The University of Melbourne, Parkville, Victoria 3010, Australia

# Abstract
Colonization of novel environments can free invasive populations from the constraints imposed by native-range predators and promote rapid evolutionary change. We demonstrate such character release for color signals in Jackson’s chameleons (*Trioceros j. xanthopholus*) inadvertently introduced from Kenya to Hawaii (Oahu) where there are few lizard predators. Hawaiian chameleons displayed more conspicuous color signals than Kenyan chameleons during male contests and courtship, were less cryptic in response to bird and snake predators and showed greater change between display and anti-predator color states. Consistent with local adaptation, the display colors of Hawaiian chameleons were more conspicuous in their local than ancestral habitats. These results demonstrate that relaxed predation pressure can result in character release of dynamic social signals in introduced species experiencing strong sexual selection.

When species encounter novel environments, such as during human-mediated introductions, evolutionary change can occur more rapidly than Darwin ever thought possible [@RN1ms; @RN2ms; @RN3ms; @RN4ms]. In particular, release from predation by native-range predators enables evolutionary exploration of entirely new regions of the adaptive landscape [@RN4ms; @RN5ms]. Such character release should be most evident for social and sexual signals; released from constraints on conspicuousness imposed by predation risk, signals could elaborate in many directions [e.g., @RN4ms; @RN6ms; @RN7ms; @RN8ms]. However, we are only beginning to understand how social and sexual signals change in response to rapid environmental change and there remain very few empirical examples from natural populations [but see @RN7ms; @RN9ms; @RN10ms]. This is especially true for species with dynamic color change, for which we are not aware of any examples. Here, we examine character release of a dynamic color signal by taking advantage of an unintended evolutionary ‘experiment’: accidental translocation of chameleons to a novel, low predation environment.  

In 1972, a shipment of Jackson’s chameleons (*Trioceros jacksonii xanthopholus*; Fig. \@ref(fig:figure1) and fig. S1; thought to be 36 or fewer individuals) was sent from Kenya to the Hawaiian island of Oahu, destined for the pet trade. The animals arrived in poor condition and were left outdoors to recover, at which point they dispersed and became established on the island [@RN11ms]. Jackson’s chameleons have a high intrinsic population growth rate (9--12 month generation time and live birth of up to 50 young @RN24ms), enabling their rapid establishment and potentially rapid evolution (approx. 50 -- 65 generations). On Oahu, the number of potential predators of chameleons is very few (no snakes or lizard-eating raptors, other potential bird predators absent or rare, supplementary text), while in Kenya they are preyed upon by a wide range of bird, snake and occasionally, mammal, predators @Measey2014ms. This accidental introduction enables us to test whether relaxed predation results in character release of a dynamic visual signal and whether this might be explained by local adaptation.

Chameleons are famous for their rapid color change [@RN12ms; @RN13ms; @RN14ms]. When presented with another chameleon, male Jackson’s chameleons adopt a characteristic display posture and become intensely yellow-green during courtship or to signal dominance (Fig. 1, figs. S1 and S3). At other times, they are a duller green and can darken to brown or become mottled green and brown, particularly in response to perceived predation risk (Fig. \@ref(fig:figure1) and fig. S4A). Their different color states can appear more or less conspicuous depending on the context, background, and viewer (e.g., conspecific or predator). If introduced chameleons in Hawaii experience character release from reduced predation, we expect Hawaiian chameleons to have more conspicuous male display colors in response to conspecifics as well as less cryptic coloration in response to bird and snake predators. We should also see evidence of local adaptation: color signals should be more conspicuous to conspecifics against the local than ancestral background. 

To test these predictions, we presented wild-caught male chameleons in both Hawaii and Kenya with either a male chameleon, a female chameleon, a bird predator (stuffed African cuckoo-hawk, *Aviceda cuculoides*) or a snake predator (replica boomslang, *Dispholidus typus*) (fig. S4). We measured the spectral reflectance of male color states during male-male display (dominant in male-male contests, *n* = `r N_display[1,2]` Hawaii, *n* = `r N_display[2,2]` Kenya), courtship (*n* = `r N_Courtship[1,2]` Hawaii, *n* = `r N_Courtship[2,2]` Kenya) and in response to bird (*n* = `r N_Pred[1,3]` Hawaii, *n* = `r N_Pred[2,3]` Kenya) and snake (*n* = `r N_Pred[3,3]` Hawaii, *n* = `r N_Pred[4,3]` Kenya) predators (Fig. \@ref(fig:figure2) and fig. S5). We then modelled how conspicuous these colors would appear to the relevant receiver’s visual system (chameleon, bird, or snake), estimated as chromatic or luminance contrast (Just Noticeable Differences, JNDs; @RN25ms) against the background vegetation of each environment (Hawaii or Kenya; supplementary text).

In support of predictions of character release, male display coloration of Hawaiian chameleons had higher luminance contrast against the local background than those of Kenyan chameleons (Fig. \@ref(fig:figure2), Fig. \@ref(fig:figure3)A and table S2) (male-male contests: luminance contrast ($dl$); $F_{`r Population_ConspicDisplayAC$df_num`,`r Population_ConspicDisplayAC$df_denom`}$ = `r Population_ConspicDisplayAC$Fstat`, *P* = `r p_value(Population_ConspicDisplayAC$p_val)`; courtship displays: luminance contrast ($dl$); $F_{`r Population_ConspicCourtshipAC$df_num`,`r Population_ConspicCourtshipAC$df_denom`}$ = `r Population_ConspicCourtshipAC$Fstat`, *P* = `r p_value(Population_ConspicCourtshipAC$p_val)`). This result was consistent for all body regions measured (supplementary text). However, Hawaiian chameleons did not differ from Kenyan chameleons in the chromatic contrast of color signals (Fig. \@ref(fig:figure3)B and table S2, male-male contests: $F_{`r Population_ConspicDisplayCC$df_num`,`r Population_ConspicDisplayCC$df_denom`}$ = `r Population_ConspicDisplayCC$Fstat`, *P* = `r p_value(Population_ConspicDisplayCC$p_val)`; courtship: $F_{`r Population_ConspicCourtshipCC$df_num`,`r Population_ConspicCourtshipCC$df_denom`}$ = `r Population_ConspicCourtshipCC$Fstat`, *P* = `r p_value(Population_ConspicCourtshipCC$p_val)`).

The importance of luminance contrast is consistent with the nature and mechanism of rapid color change in individual chameleons, which usually involves much greater luminance than chromatic change (Fig. \@ref(fig:figure1)). Specifically, color change is caused by dispersion or concentration of melanin within melanophore pigment cells @RN15ms or changes in the spacing of guanine crystals within iridophores @RN14, both of which strongly affect luminance. Accordingly, character release was observed in the overall luminance of signals rather than their hue.

Released from predation, Hawaiian chameleons were less cryptic than Kenyan chameleons when threatened by both bird and snake predators. Hawaiian chameleons had higher luminance contrast against the local background to the visual system of the corresponding predator (Fig. \@ref(fig:figure3)C; main effect of population; $F_{`r Population_AC_Pred$df_num`,`r Population_AC_Pred$df_denom`}$ = `r Population_AC_Pred$Fstat`, *P* = `r p_value(Population_AC_Pred$p_val)`, no interaction between population and predator type, table S3). Differences between populations in chromatic contrast against the background, however, depended on the predator (significant predator by population interaction, table S3: $F_{`r back_pred_CC_Pred$df_num`,`r back_pred_CC_Pred$df_denom`}$ = `r back_pred_CC_Pred$Fstat`, *P* = `r p_value(back_pred_CC_Pred$p_val)`). Hawaiian chameleons were significantly more conspicuous to birds compared to Kenyan chameleons (Fig. \@ref(fig:figure3)D and table S4; Birds (Hawaii-Kenya): $\beta$ = `r CI_hyp_test[2,2]`, 95% CI = `r CI_hyp_test[2,3]` to `r CI_hyp_test[2,4]`, *P* = `r CI_hyp_test[2,8]`, JND values > 5). By comparison, chameleons from both populations had very low and similar chromatic contrast to the visual system of snakes (Fig. \@ref(fig:figure3)D and table S4; Snakes (Hawaii-Kenya): $\beta$ = `r CI_hyp_test[1,2]`, 95% CI = `r CI_hyp_test[1,3]` to `r CI_hyp_test[1,4]`, *P* = 1; JND values ~ 2). The much lower chromatic contrast of chameleons to the visual system of snakes than birds reflects the much poorer chromatic discrimination of trichromatic snakes compared to tetrachromatic birds [@RN18ms]. The poor color discrimination of snakes may also explain why chameleons from Hawaii show little change relative to their Kenyan counterparts in their chromatic response to snakes, despite the absence of snakes on Hawaii.

Character release may reflect rapid evolutionary change, phenotypic plasticity or a combination of these processes [@RN19ms; @RN20ms]. Rapid evolutionary change results in local adaptation, whereby signals should become more conspicuous to conspecifics in their local environment than in ancestral environments. Consistent with local adaptation, we found that Hawaiian chameleons were more conspicuous to other chameleons against their own (Hawaiian) background than against their ancestral Kenyan background, in both social contexts, although effect sizes for luminance were much larger than for chromatic contrast (Fig. \@ref(fig:figure4) and table S5; male-male contests: luminance ($dl$), $\beta$ = `r robust_localAdapt_DispBgrdAC[3,1]`, 95% CI = `r robust_localAdapt_DispBgrdAC[3,4]` to `r robust_localAdapt_DispBgrdAC[3,5]`, $F_{`r background_AC_Disp$df_num`,`r background_AC_Disp$df_denom`}$ = `r background_AC_Disp$Fstat`, *P* = `r p_value(background_AC_Disp[,6])`, chromatic ($dS$), $\beta$ = `r robust_DispBgrdCC[3,1]`, 95% CI = `r robust_DispBgrdCC[3,4]` to `r robust_DispBgrdCC[3,5]`, $F_{`r background_CC_Disp$df_num`,`r background_CC_Disp$df_denom`}$ = `r background_CC_Disp$Fstat`, *P* = `r p_value(background_CC_Disp[,6])`; courtship: luminance ($dl$), $\beta$ = `r robust_CourtshipAC[3,1]`, 95% CI = `r robust_CourtshipAC[3,4]` to `r robust_CourtshipAC[3,5]`, $F_{`r background_AC_Court$df_num`,`r background_AC_Court$df_denom`}$ = `r background_AC_Court$Fstat`, *P* = `r p_value(background_AC_Court[,6])`, chromatic ($dS$) $\beta$ = `r robust_CourtshipCC[3,1]`, 95% CI = `r robust_CourtshipCC[3,4]` to `r robust_CourtshipCC[3,5]`, $F_{`r background_CC_Court$df_num`,`r background_CC_Court$df_denom`}$ = `r background_CC_Court$Fstat`, *P* = `r p_value(background_CC_Court[,6]) `). Although these results are consistent with local adaptation, this does not exclude a role for phenotypic plasticity, which can also evolve rapidly [@RN26ms].

To gauge the extent of color plasticity, we examined individual change between display (male-male contest) and anti-predator (bird) color states (absolute difference in JNDs between states; *n* = `r N_diff[1,2]` Hawaii, *n* = `r N_diff[2,2]` Kenya). While there was evidence for differences between body regions (see supplementary text, fig. S9, tables S12 and S13), overall, Hawaiian chameleons showed greater chromatic but not luminance change compared to Kenyan chameleons (chromatic: $F_{`r robust_Diff_dS_pop$df_num`,`r robust_Diff_dS_pop$df_denom`}$ = `r robust_Diff_dS_pop$Fstat`, *P* = `r p_value(robust_Diff_dS_pop[,6])`; luminance: $F_{`r robust_Diff_dl_pop$df_num`,`r robust_Diff_dl_pop$df_denom`}$ = `r robust_Diff_dl_pop$Fstat`, *P* = `r p_value(robust_Diff_dl_pop[,6])`); although luminance change showed similar trends across body regions (fig. S9). Together, these results indicate that chameleons introduced to Hawaii only 50 years ago have evolved signals that are locally adapted, more conspicuous to conspecifics, and show greater changes between display and anti-predator color states. While it is possible that differences between Hawaiian and Kenyan chameleons could reflect a founder effect, the observed differences are all in the predicted direction of adaptive change, whereas founder effects are expected to be random with respect to the local environment.

We have documented a surprisingly strong effect of recent release from predation on a conspicuous, dynamic visual signal. Oahu has no snakes or raptors that feed on lizards. The main threat for Oahu chameleons is domestic and feral cats, and cats have very limited color vision [@RN22ms]. In the absence of the usual suite of predators they would experience in their native range of Kenya -- a diverse community of snake and bird predators @Measey2014ms -- the conditions were highly favorable for character release of social signals. Jackson’s chameleons likely experience strong sexual selection given their polygynous mating system, elaborate courtship displays and intense male contest competition (Fig. \@ref(fig:figure1)) in which males lock and twist their three horns into rivals during intense bouts that sometimes result in physical injury. Consequently, a ‘perfect storm’ of conditions set the stage for what we have demonstrated -- character release of a dynamic social signal over a short ecological time scale. To the best of our knowledge, this is also the first example of character release in a dynamic color signal.

Rapid color change enables animals to be highly conspicuous during social interactions and highly cryptic at other times [@RN12ms]. Our results suggest that even for species capable of dynamic color change there is an upper threshold to signal intensity that is constrained by natural selection. This novel finding raises the question of whether other animals that have convergently evolved dynamic color signals, such as cephalopods, frogs, other lizards, and fishes, may be likewise constrained. More generally, our study highlights the opportunities provided by translocations and invasions, which are often otherwise detrimental, to study natural and sexual selection in the wild.

# Figures

```{r figure1, cache=FALSE, fig.cap = "**Chameleon color signal change in response to different social and predatory stimuli. Male chameleons experience intense sexual selection**. During the breeding season they change from a neutral state (green) to a highly conspicuous bright yellow display signal. They also readily fight by locking horns and sometimes pierce their rival’s skin with their horns. **(A)** A typical dominant male in display coloration. **(B)** A subordinate male that lost a contest and turned from bright yellow to brown. **(C)** Two males fighting, both are in display coloration and at a stage where they are relatively even matched. **(D)** A male courting female in full display color while the female has turned to a contrasting color, which suggests rejection of the male."}
library(magick)

img65 <- image_read("./output/figures/fig1.pdf")
img65
  
```

```{r figure2, fig.width = 14, fig.height= 14, fig.cap="**Mean spectral reflectance curves for male chameleons for representative body regions (gular, top flank) and background (leaves) for Hawaii and Kenya**. The context for measurement was **(A)** male contest displays; **(B)** courtship; **(C)** bird predator; and **(D)** snake predator. More details in online supplementary text and Fig. S5."}
library(magick)
img <- image_read("./output/figures/Figure3.png")
img

```

```{r figure3, cache = FALSE, fig.width = 14, fig.height= 14, fig.cap= "**Chromatic and luminance contrast in Just Noticeable Differences (JND), of Hawaiian and Kenyan chameleons against their respective backgrounds (i.e., average environment of stems and leaves)**. Luminance and chromatic contrast of male chameleons during male-male contests **(A)** and female courtship **(B)**. JNDs are calculated based on the chameleon visual system. Luminance and chromatic contrasts of male chameleons during snake **(C)** and bird **(D)** predator encounters. JNDs are calculated based on the snake and bird visual systems. Contrasts between means, ‘Beta’, that are bold indicate significant effects."}
rerun = FALSE
if(rerun){
## Make figures that average across body regions, but display Social Context

courtship_data <- Courtship %>% 
                  select(ID, Population, Colour, SVL, BodyRegion, Background, dS, dL)
  display_data <- Display_1 %>%
                  select(ID, Population, Colour, SVL, BodyRegion, Background, dS, dL)
combined_data <- rbind(courtship_data, display_data)

# Now calculate the averages for each population and Colour (i.e., context) / predation

summary_data_pred <- Predator %>%
                group_by(Predator, Population) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) 


summary_data <- combined_data %>%
                group_by(Population, Colour) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>%
                mutate(Colour = if_else(Colour == "Courtship", "Courtship", "Male-male contest"))


#Grab photos
  males <- readPNG("./photos/male_fight.png", native = TRUE)
females <- readPNG("./photos/courtship.png",  native = TRUE)
  snake <- readPNG("./photos/snake_cham.png", native = TRUE)
   bird <- readPNG("./photos/bird_cham.png",  native = TRUE)

#plots
p1 <- ggplot(summary_data, aes(x = Population, y = Mean_dS, group = Colour, color = Colour)) +
    ylim(2.5, 6.5) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Chromatic contrast (JND)") +
  annotate("segment", x = 0.85, xend = 1.85, y = 6.1, yend = 6.1, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 5.7, yend = 5.7, colour = "black") + 
  annotate("text", x = 0.85+(1.85-0.85)/2,  y = 6.2, label = "NS",  size = 6) + 
  annotate("text", x = 1.12+(2.12-1.12)/2, y = 5.8, label = "NS", size = 6) + 
  theme_bw() +
  labs(colour = "Social Context") +
  theme(legend.position = c(0.18, 0.08),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
   inset_element(males,
                left = 0.45,
                right = 0.90,
                bottom = 0.58,
                top = 0.75, ignore_tag = TRUE) + 
    inset_element(females,
                left = 0.30,
                right = 0.75,
                bottom = 0.15,
                top = 0.28, ignore_tag = TRUE) 
      #annotation_raster(males, xmin = 1.2, xmax = 1.9, ymin = 4.8, ymax = 5.3) + 
      #annotation_raster(females, xmin = 1, xmax = 1.7, ymin = 3.5, ymax = 4)

p2 <- ggplot(summary_data, aes(x = Population, y = Mean_dL, group = Colour, color = Colour)) +
  ylim(15, 45) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Luminance contrast (JND)") +
   annotate("segment", x = 0.90, xend = 1.90, y = 40, yend = 40, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 42, yend = 42, colour = "black") + 
  annotate("text", x = 0.9+((1.90 - 0.90)/2), y = 41, label = "**",  size = 6) + 
  annotate("text", x = 1.12+((2.12 - 1.12)/ 2), y = 43, label = "**", size = 6) + 
  theme_bw() +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
    inset_element(males,
                left = 0.45,
                right = 0.90,
                bottom = 0.60,
                top = 0.75, ignore_tag = TRUE) + 
    inset_element(females,
                left = 0.05,
                right = 0.50,
                bottom = 0.25,
                top = 0.38, ignore_tag = TRUE)


p3 <- ggplot(summary_data_pred, aes(x = Population, y = Mean_dL, group = Predator, color = Predator)) +
  ylim(10, 30) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Luminance contrast (JND)") +
   annotate("segment", x = 0.90, xend = 1.90, y = 28, yend = 28, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 26, yend = 26, colour = "black") + 
  annotate("text", x = 0.9+((1.90 - 0.90)/2), y = 28.5, label = "**",  size = 6) + 
  annotate("text", x = 1.12+((2.12 - 1.12)/ 2), y = 26.5, label = "**", size = 6) + 
  theme_bw() +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
    inset_element(snake,
                left = 0.45,
                right = 0.75,
                bottom = 0.60,
                top = 0.70, ignore_tag = TRUE) + 
    inset_element(bird,
                left = 0.05,
                right = 0.50,
                bottom = 0.25,
                top = 0.38, ignore_tag = TRUE)

p4 <- ggplot(summary_data_pred, aes(x = Population, y = Mean_dS, group = Predator, color = Predator)) +
  ylim(1, 9) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Chromatic contrast (JND)") +
   annotate("segment", x = 0.88, xend = 1.88, y = 8.8, yend = 8.8, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y =2.5, yend = 2.5, colour = "black") + 
  annotate("text", x = 0.9+((1.90 - 0.90)/2), y = 8.9, label = "**",  size = 6) + 
  annotate("text", x = 1.12+((2.12 - 1.12)/ 2), y = 2.7, label = "NS", size = 6) + 
  theme_bw() +
  theme(legend.position = c(0.10, 0.08),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
    inset_element(bird,
                left = 0.30,
                right = 0.60,
                bottom = 0.45,
                top = 0.60, ignore_tag = TRUE) + 
    inset_element(snake,
                left = 0.02,
                right = 0.32,
                bottom = 0.20,
                top = 0.35, ignore_tag = TRUE)

#pdf(file = "./output/figures/Figure1.1.pdf", width = 14, height = 14)
plot_grid(p1, p2, p4, p3, labels = c("A", "B", "C", "D"), label_size = 16,
  label_fontface = "bold", rel_widths=c(1,1))
#dev.off()
} else {
  
  img2 <- image_read("./output/figures/Figure1.png")
  img2
}
```

```{r figure4, cache = FALSE, fig.width = 14, fig.height= 9, fig.cap= "**Evidence for local adaptation of color signals in both (A) chromatic- and (B) luminance contrast for Hawaiian chameleons**. For local adaptation, signals are predicted to be more conspicuous against their own background. In this case, Hawaiian chameleons were both significantly more chromatic and brighter (luminance contrast) against their own background compared to the Kenyan background suggesting that selection has acted on increasing local signal conspicuousness."}
rerun=FALSE

if(rerun){
##########
# Data
##########
courtship_summary <- CourtshipBgrd %>% 
                    group_by(Population, Background_pop) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>% filter(Population == "Hawaii") %>% as.data.frame() %>% mutate(Social_Context = "Courtship")

display_summary <- DisplayBgrd %>%
                group_by(Population, Background_pop) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>% filter(Population == "Hawaii") %>% as.data.frame() %>% mutate(Social_Context = "Male-male contest")

summary_data_localAdap <- rbind(courtship_summary, display_summary)

##########
# Plots
##########
#Grab photos
  males <- readPNG("./photos/male_fight.png", native = TRUE)
females <- readPNG("./photos/courtship.png",  native = TRUE)

#plots
p1.2 <- ggplot(summary_data_localAdap, aes(x = Background_pop, y = Mean_dS, group = Social_Context, color = Social_Context)) +
    ylim(2.5, 6.5) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Chromatic contrast (JND)") +
  annotate("segment", x = 0.85, xend = 1.85, y = 6.1, yend = 6.1, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 5.7, yend = 5.7, colour = "black") + 
  annotate("text", x = 0.85+(1.85-0.85)/2,  y = 6.2, label = "NS",  size = 6) + 
  annotate("text", x = 1.12+(2.12-1.12)/2, y = 5.8, label = "NS", size = 6) + 
  theme_bw() +
  labs(colour = "Social Context") +
  theme(legend.position = c(0.15, 0.08),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
   inset_element(males,
                left = 0.45,
                right = 0.90,
                bottom = 0.58,
                top = 0.75, ignore_tag = TRUE) + 
    inset_element(females,
                left = 0.30,
                right = 0.75,
                bottom = 0.15,
                top = 0.28, ignore_tag = TRUE) 

p2.2 <- ggplot(summary_data_localAdap, aes(x = Background_pop, y = Mean_dL, group = Social_Context, color = Social_Context)) +
  ylim(15, 45) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Luminance contrast (JND)") +
   annotate("segment", x = 0.90, xend = 1.90, y = 40, yend = 40, colour = "black") +
  annotate("segment", x = 1.12, xend = 2.12, y = 42, yend = 42, colour = "black") + 
  annotate("text", x = 0.9+((1.90 - 0.90)/2), y = 41, label = "**",  size = 6) + 
  annotate("text", x = 1.12+((2.12 - 1.12)/ 2), y = 43, label = "**", size = 6) + 
  theme_bw() +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) +
    inset_element(males,
                left = 0.45,
                right = 0.90,
                bottom = 0.60,
                top = 0.75, ignore_tag = TRUE) + 
    inset_element(females,
                left = 0.05,
                right = 0.50,
                bottom = 0.25,
                top = 0.38, ignore_tag = TRUE)
#pdf(file="./output/figures/Figure2.pdf", height = 10, width = 18)
plot_grid(p1.2, p2.2, labels = c("A", "B"), label_size = 16,
  label_fontface = "bold", rel_widths=c(1,1))
#dev.off()
} else {
  img3 <- image_read("./output/figures/Figure2.png")
  img3
}


```

```{r table4, results='hide'}
#Section will create and write Tables for Supplement. It is not spit out in the main MS. Exported then imported for the supp

# Table S1
    table1 <- as.data.frame(rbind(robust_ConspicDisplayAC_CI,
                    robust_ConspicDisplayCC_CI,
                    robust_ConspicCourtshipAC_CI,
                    robust_ConspicCourtshipCC_CI))
    table1$Parameter <- rownames(table1)
    rownames(table1) <- NULL
    # Clean
     final_T1 <- table1 %>% 
                 mutate(SocialContext = c("Male-Male Display", rep("", 5), "Courtship Display", rep("", 5)),
                        VisualRealm = c("Luminance  Contrast", rep("", 2), "Chromatic Contrast", rep("", 2), 
                                        "Luminance Contrast", rep("", 2), "Chromatic Contrast", rep("", 2))) %>%
                  select(SocialContext, VisualRealm, Parameter, beta, SE, df, CI_L, CI_U)
     write.csv(final_T1, file = "./output/tables/Table1_MS.csv", row.names = FALSE)
 
# Table S2
    table2 <- as.data.frame(rbind(robust_PredatorAC_CI_inter,
                                  robust_PredatorCC_CI_inter))
    table2$Parameter <- rownames(table2)
    rownames(table2) <- NULL
    
    # Clean
     final_T2 <- table2 %>% 
                 mutate(JND = c("Luminance Contrast", rep("", 3), "Chromatic Contrast", rep("", 3))) %>%
                  select(JND, Parameter, beta, SE, df, CI_L, CI_U)
     write.csv(final_T2, file = "./output/tables/Table2_MS.csv", row.names = FALSE)

 #Table S3
    contrast <- rbind(CI_hyp_test,
                     CI_hyp_testAC)
    
    contrast <- contrast %>% mutate(VisualSpec = c("Chromatic Contrast", "", "Luminance Contrast", ""),
                                    p_val = sapply(p_val, function(x) p_value(x))) %>% 
                select(VisualSpec, comparison, Estimate, lwr, upr, Fstat, df, p_val, p_bonf)
    
    write.csv(contrast, file = "./output/tables/Table3_MS.csv", row.names = FALSE)


#TableS4
    tb4 <- data.frame(rbind(robust_localAdapt_DispBgrdAC,
                 robust_DispBgrdCC,
                 robust_CourtshipAC,
                 robust_CourtshipCC))
    tb4$parameter <- rownames(tb4)
    rownames(tb4) <- NULL
    
    tb4 <- tb4 %>% mutate(SocialContext = c("Male-Male Display", rep("", 5), 
                                            "Courtship Display", rep("", 5)),
                        VisualRealm = c("Luminance Contrast", rep("", 2), "Chromatic Contrast", 
                                        rep("", 2), "Luminance Contrast", rep("", 2), 
                                        "Chromatic Contrast", rep("", 2))) %>%
                  select(SocialContext, VisualRealm, parameter, beta, SE, df, CI_L, CI_U)
    
    write.csv(tb4, file = "./output/tables/Table4_MS.csv", row.names = FALSE)


# Table S5
    tb5 <- data.frame(rbind(robust_Diff_dL_BR_int,
                            robust_Diff_dS_BR_int))
    tb5$parameter <- rownames(tb5)
    rownames(tb5) <- NULL
    
  tb5 <- tb5 %>% mutate(VisualRealm = c("Luminance Contrast", rep("", 8), "Chromatic Contrast", 
                                        rep("", 8))) %>%
                  select(VisualRealm, parameter, beta, SE, df, CI_L, CI_U)
     write.csv(tb5, file = "./output/tables/Table5_MS.csv", row.names = FALSE)
    
```

```{r setup, include=FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, message = FALSE, warning = FALSE, tidy = TRUE)
## numbers >= 10^5 will be denoted in scientific notation,      ## numbers >= 10^5 will be denoted in scientific notation,
  ## and rounded to 2 digits      ## and rounded to 2 digits
  options(digits = 2)
```

```{r getlibrary, echo = FALSE, results = "hide"}
# load libraries
devtools::install_github("karthik/wesanderson")
pacman::p_load(flextable, lme4, lmerTest, ggplot2, lsmeans, emmeans, multcomp, dplyr, wesanderson, patchwork, latex2exp, png, cowplot, magick, jpeg, clubSandwich, readxl, pavo)
source("./R/func.R")
```

```{r display_supp, results = "hide"}
source("./R/func.R")
#########################################################
# Male-male Competition Displays
#########################################################
  # Load data and clean a bit
  Display_1 <- read.table("./data/Display_1.csv", 
                            header=TRUE, sep=",", dec=".", strip.white=TRUE)
  
  # Exclude bottom flank.
  Display_1 <- Display_1 %>% 
                filter(!BodyRegion == "botflank") %>% as.data.frame() 
  
  # Create as factor
      Display_1$BodyRegion <- factor(Display_1$BodyRegion)
      
  # Center SVL to make intercept interpretable
  Display_1$sc_SVL <- with(Display_1, scale(SVL, scale=FALSE))


##########
## Achromatic Contrast - dL
##########

    # Fit the model that estimates changes across body regions
    ConspicDisplayAC <- lmer(dL ~ sc_SVL + Population + BodyRegion + 
                               Population:BodyRegion + (1|ID), data=Display_1)
    summary(ConspicDisplayAC)
    ConspicDisplayAC_main <- lmer(dL ~ sc_SVL + Population + BodyRegion +  (1|ID), data=Display_1)
    
    # Wald Table - Test for interaction, plus refit model and test sig of each factor. Uses RVEs
    wald_table_ConspicDisplayAC <-  wald_table(model_main =  ConspicDisplayAC_main , model_inter = ConspicDisplayAC)

    # Robust variance estimators (RVE). Mostly all consistent
    Display_subset <- Display_1 %>% filter(!is.na(sc_SVL), !is.na(Population), !is.na(BodyRegion))
    robust_ConspicDisplayAC <- coef_test(ConspicDisplayAC, cluster = Display_subset$ID, vcov="CR2")
    
    # Fit model for linear hypothesis tests
           Display_1$PopBRInt <- interaction(Display_1$Population,Display_1$BodyRegion)
            ConspicDisplayAC2 <- lmer(dL ~ -1 + sc_SVL + PopBRInt + (1|ID), data=Display_1)
            summary(ConspicDisplayAC2)
    
     # Fit RVE
      robust_ConspicDisplayAC2 <- coef_test(ConspicDisplayAC2, cluster = Display_subset$ID, vcov="CR2")
      
     # Contrasts hypothesis tests, but use RVE 
    result1 <- Wald_test(ConspicDisplayAC2, constraints = constrain_pairwise(c(2:9)), vcov="CR2", tidy = TRUE)
    result1$p_val_bonfer <- sapply(p.adjust(result1$p_val, "bonferroni"), function(x) p_value(x))

##########
## Chromatic Contrast - dL
##########

 # Fit the model that esatimtes changes across body regions
    ConspicDisplayCC <- lmer(dS ~ sc_SVL + Population + BodyRegion + Population:BodyRegion + (1|ID), data=Display_1)
    ConspicDisplayCC_main <- lmer(dS ~ sc_SVL + Population + BodyRegion + (1|ID), data=Display_1)
    
    
# Wald Table - Test for interaction, plus refit model and test sig of each factor. Uses RVEs
    wald_table_ConspicDisplayCC <-  wald_table(model_main =  ConspicDisplayCC_main, model_inter = ConspicDisplayCC)
    
 # Robust variance estimators (RVE). Mostly all consistent
             Display_subset <- Display_1 %>% filter(!is.na(sc_SVL), !is.na(Population), !is.na(BodyRegion))
    robust_ConspicDisplayCC <- coef_test(ConspicDisplayCC, cluster = Display_subset$ID, vcov="CR2")    

  # Fit model for linear hypothesis tests
    Display_1$PopBRInt <- interaction(Display_1$Population,Display_1$BodyRegion)
     ConspicDisplayCC2 <- lmer(dS ~ -1 + sc_SVL + PopBRInt + (1|ID), data=Display_1)
     summary(ConspicDisplayCC2)
 
 # Contrasts hypothesis tests, but use RVE 
                 result2 <- Wald_test(ConspicDisplayCC2, constraints = constrain_pairwise(c(2:9)), vcov="CR2", tidy = TRUE)
    result2$p_val_bonfer <- sapply(p.adjust(result2$p_val, "bonferroni"), function(x) p_value(x))

#########################################################
# Courtship Displays
#########################################################

Courtship <- read.table("./data/Courtship_1.2.csv", 
                          header=TRUE, sep=",", dec=".", strip.white=TRUE)

# Center SVL to make intercept interpretable
Courtship$sc_SVL <- with(Courtship, scale(SVL, scale=FALSE))


##########
## Achromatic Contrast - dL
##########
  # Fit model
    ConspicCourtshipAC <- lmer(dL ~ sc_SVL + Population + BodyRegion + 
                                 Population:BodyRegion + (1|ID), data=Courtship)
    summary(ConspicCourtshipAC)
    
  # Main effects Model
    ConspicCourtshipAC_main <- lmer(dL ~ sc_SVL + Population + BodyRegion + (1|ID), data=Courtship)

   # Wald Table - Test for interaction, plus refit model and test sig of each factor. Uses RVEs
    wald_table_ConspicCourtshipAC <-  wald_table(model_main =  ConspicCourtshipAC_main, model_inter = ConspicCourtshipAC)  
  # Robust variance estimators (RVE). Mostly all consistent
             Courtship_subset <- Courtship %>% filter(!is.na(sc_SVL), !is.na(Population), !is.na(BodyRegion))
    robust_ConspicCourtshipAC <- coef_test(ConspicCourtshipAC, cluster = Courtship_subset$ID, vcov="CR2")    
      
  # Refit model for contrasts
     Courtship$PopBRInt <- interaction(Courtship$Population,Courtship$BodyRegion)
    ConspicCourtshipAC2 <- lmer(dL ~ -1 + sc_SVL + PopBRInt + (1|ID), data=Courtship)

  # Contrasts hypothesis tests, but use RVE 
                 result3 <- Wald_test(ConspicCourtshipAC2, constraints = constrain_pairwise(c(2:9)), vcov="CR2", tidy = TRUE)
    result3$p_val_bonfer <- sapply(p.adjust(result3$p_val, "bonferroni"), function(x) p_value(x))

##########
## Chromatic Contrast - dL
#########
    
    # Fit model, interaction
        ConspicCourtshipCC <- lmer(dS ~ sc_SVL + Population + BodyRegion + Population:BodyRegion + (1|ID), data=Courtship)
    
    # Fit main effects
    ConspicCourtshipCC_main <- lmer(dS ~ sc_SVL + Population + BodyRegion + (1|ID), data=Courtship)
    
    # Wald Table - Test for interaction, plus refit model and test sig of each factor. Uses RVEs
    wald_table_ConspicCourtshipCC <-  wald_table(model_main =  ConspicCourtshipCC_main, model_inter = ConspicCourtshipCC)

    # Robust variance estimators (RVE). Mostly all consistent
             Courtship_subset <- Courtship %>% filter(!is.na(sc_SVL), !is.na(Population), !is.na(BodyRegion))
    robust_ConspicCourtshipCC <- coef_test(ConspicCourtshipCC, cluster = Courtship_subset$ID, vcov="CR2")    
    
    # Refit model to get the contrasts between coefficienst we want
     Courtship$PopBRInt <- interaction(Courtship$Population,Courtship$BodyRegion)
    ConspicCourtshipCC2 <- lmer(dS ~ -1 + sc_SVL + PopBRInt + (1|ID), data=Courtship)
    
    # Contrasts hypothesis tests, but use RVE 
            result4 <- Wald_test(ConspicCourtshipCC2, 
                                 constraints = constrain_pairwise(c(2:9)), 
                                 vcov="CR2", tidy = TRUE)
      string <- c("PopBRIntKenya.gular - PopBRIntHawaii.gular|PopBRIntKenya.midflank - PopBRIntHawaii.midflank|PopBRIntKenya.tailbase - PopBRIntHawaii.tailbase|PopBRIntKenya.topflank - PopBRIntHawaii.topflank")
      result4 <- result4[grep(string, result4$hypothesis),]
    result4$p_val_bonfer <- sapply(p.adjust(result4$p_val, "bonferroni"), function(x) p_value(x))
    

#########################################################
# Displays to Predators, birds and snake
#########################################################
   Predator <- read.table("./data/Predator_2_3.csv", 
                         header=TRUE, sep=",", dec=".", strip.white=TRUE)
   
  # Clean up
             Predator <- Predator %>% filter(!BodyRegion == "botflank" & !BodyRegion =='gularbot') %>% as.data.frame() #exclude bottom flank.
  Predator$BodyRegion <- factor(Predator$BodyRegion) #updates levels for the variable BodyRegion

##########
## Achromatic Contrast - dL
##########

   # Fit model
      PredatorAC <- lmer(dL ~ Predator + Population + BodyRegion + Predator:BodyRegion + Predator:Population + 
                           (1|ID), data=Predator)
      summary(PredatorAC)
  
  PredatorAC_main <- lmer(dL ~ Predator + Population + BodyRegion  + (1|ID), data=Predator)
      
  # Wald table RVE
    
    Wald_table_PredatorAC <- wald_table_p(PredatorAC_main, PredatorAC)
  

   # Robust variance estimators (RVE). Mostly all consistent
             Predator_subset <- Predator %>% filter(!is.na(Population), !is.na(BodyRegion))
           robust_PredatorAC <- coef_test(PredatorAC, cluster = Predator_subset$ID, vcov="CR2")    

  # Fit model for linear hypothesis tests
    Predator$PopBRInt <- interaction(Predator$Population,Predator$Predator, Predator$BodyRegion)
     PredatorAC2 <- lmer(dL ~ -1 + PopBRInt + (1|ID), data=Predator)
     summary(PredatorAC2)
 
 # Contrasts hypothesis tests, but use RVE 
                 result5 <- Wald_test(PredatorAC2, constraints = constrain_pairwise(c(1:16)), vcov="CR2", tidy = TRUE)
 string <- c("PopBRIntKenya.snake.midflank - PopBRIntHawaii.snake.midflank|PopBRIntKenya.snake.gular - PopBRIntHawaii.snake.gular|PopBRIntKenya.snake.tailbase - PopBRIntHawaii.snake.tailbase|PopBRIntKenya.snake.topflank - PopBRIntHawaii.snake.topflank|PopBRIntKenya.bird.midflank - PopBRIntHawaii.bird.midflank|PopBRIntKenya.bird.gular - PopBRIntHawaii.bird.gular|PopBRIntKenya.bird.tailbase - PopBRIntHawaii.bird.tailbase|PopBRIntKenya.bird.topflank - PopBRIntHawaii.bird.topflank")
    result5 <- result5[grep(string, result5$hypothesis),]
    result5$p_val_bonfer <- sapply(p.adjust(result5$p_val, "bonferroni"), function(x) p_value(x))
    

##########
## Chromatic Contrast - dS
########

  # Fit Model
        PredatorCC <- lmer(dS ~ Predator + Population + BodyRegion + Predator:BodyRegion + Predator:Population + (1|ID), data=Predator)
        summary(PredatorCC)
          anova(PredatorAC)
          
    PredatorCC_main <- lmer(dS ~ Predator + Population + BodyRegion  + (1|ID), data=Predator)            
  
  # Wald table RVE
    
    Wald_table_PredatorCC <- wald_table_p(PredatorCC_main, PredatorCC)
  
  # Robust variance estimators (RVE). Mostly all consistent
             Predator_subset <- Predator %>% filter(!is.na(Population), !is.na(BodyRegion))
           robust_PredatorCC <- coef_test(PredatorCC, cluster = Predator_subset$ID, vcov="CR2")    
  
  # Fit model for linear hypothesis tests
    Predator$PopBRInt <- interaction(Predator$Population,Predator$Predator, Predator$BodyRegion)
          PredatorCC2 <- lmer(dS ~ -1 + PopBRInt + (1|ID), data=Predator)
          summary(PredatorCC2)
 
 # Contrasts hypothesis tests, but use RVE 
                 result6 <- Wald_test(PredatorCC2, constraints = constrain_pairwise(c(1:16), with_zero = TRUE), vcov="CR2", tidy = TRUE)
                   string <- c("PopBRIntKenya.snake.midflank - PopBRIntHawaii.snake.midflank|PopBRIntKenya.snake.gular - PopBRIntHawaii.snake.gular|PopBRIntKenya.snake.tailbase - PopBRIntHawaii.snake.tailbase|PopBRIntKenya.snake.topflank - PopBRIntHawaii.snake.topflank|PopBRIntKenya.bird.midflank - PopBRIntHawaii.bird.midflank|PopBRIntKenya.bird.gular - PopBRIntHawaii.bird.gular|PopBRIntKenya.bird.tailbase - PopBRIntHawaii.bird.tailbase|PopBRIntKenya.bird.topflank - PopBRIntHawaii.bird.topflank")
    result6 <- result6[grep(string, result6$hypothesis),]
    result6$p_val_bonfer <- sapply(p.adjust(result6$p_val, "bonferroni"), function(x) p_value(x))
    
  
  
#########################################################
# Testing local adaptation contrasting backgrounds between hawaii and Kenya
#########################################################
##################
# Social Context: Male-male competition
##################
DisplayBgrd <- read.table("./data/Display_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)
svl_dat <- read.csv("./data/SVL2.csv")

DisplayBgrd <- DisplayBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
DisplayBgrd$BodyRegion <- factor(DisplayBgrd$BodyRegion) #updates levels for the variable BodyRegion

# Filter out only Hawaiian and add in SVL for IDs
DisplayBgrd$pop_back_region <- with(DisplayBgrd, interaction(Background_pop, BodyRegion))
DisplayBgrd_Hawaii <- DisplayBgrd %>% 
               filter(Population == "Hawaii") %>% 
               left_join(select(svl_dat, ID, SVL), by = "ID", keep = FALSE) %>% 
               mutate(sc_svl = scale(SVL, scale = FALSE)) %>% 
                filter(!is.na(SVL))

##########
# Achromatic Contrast - dL
##########

  # Main effercts
   DispBgrdAC_main <- lmer(dL ~  sc_svl + Background_pop + BodyRegion + (1|ID), data=DisplayBgrd_Hawaii)
    summary(DispBgrdAC_main)
  
  # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE). Given that there is no interaction, we can just present the main effects model with teh figure. Plus wald tests
  robust_localAdapt_DispBgrdAC <- clubSandwich::conf_int(DispBgrdAC_main, cluster = DisplayBgrd_Hawaii$ID, vcov =  "CR2")

  # Add Wald test to test signifiacnce of each factor using roust variance 
  background_AC_Disp <- Wald_test(DispBgrdAC_main, constraints = constrain_zero(3), 
                                  cluster = DisplayBgrd_Hawaii$ID, vcov = "CR2")
  
  BodyRegion_AC_Disp <- Wald_test(DispBgrdAC_main, constraints = constrain_zero(4:6), 
                                  cluster = DisplayBgrd_Hawaii$ID, vcov = "CR2")

   
##########
# Chromatic Contrast - dS
##########
   
     # Fit the inetarction model
          DispBgrdCC_inter <- lmer(dS ~ sc_svl + Background_pop  + BodyRegion + Background_pop:BodyRegion + (1|ID), data=DisplayBgrd_Hawaii)
          summary(DispBgrdCC_inter)
  
    # Fit the main effect model
          DispBgrdCC_main <- lmer(dS ~ sc_svl + Background_pop  + BodyRegion + (1|ID), data=DisplayBgrd_Hawaii)
          summary(DispBgrdCC_main)
    
    # Wald test to see if interaction is important. Yes, body regions way in how they change from a Hawaiian and Kenyan population. Fig S4, this makes sense. 
        intearction_CC_Disp <- Wald_test(DispBgrdCC_inter, constraints = constrain_zero(7:9), 
                                  cluster = DisplayBgrd_Hawaii$ID, vcov = "CR2")

    # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
      robust_DispBgrdCC <- clubSandwich::conf_int(DispBgrdCC_inter, cluster = DisplayBgrd_Hawaii$ID, vcov =  "CR2")

 # Get contrasts to understand the specific changes better. Refit model in slight different form. This is essentially an interaction model anyway because it's estimating the mean for Hawaiian and Kenyan background for each body region. The model above is just a contrast-based model.
    DisplayBgrd_pop_back_regionCC <- lmer(dS ~ -1 + sc_svl + pop_back_region + (1|ID), data = DisplayBgrd_Hawaii) 
    # Fit Robust model
    robust_DisplayBgrd_pop_back_regionCC <- clubSandwich::conf_int(DisplayBgrd_pop_back_regionCC, 
                                                            cluster = DisplayBgrd_Hawaii$ID, 
                                                            vcov =  "CR2")
   
    # Contrasts hypothesis tests, but use RVE 
      result_DisplayBgrd_pop_back_regionCC <- Wald_test(DisplayBgrd_pop_back_regionCC, 
                                                 constraints = constrain_pairwise(c(1:9)), 
                                                 vcov="CR2", tidy = TRUE)
      
      result_DisplayBgrd_pop_back_regionCC$p_val_bonfer <- 
                                  sapply(p.adjust(result_DisplayBgrd_pop_back_regionCC$p_val, "bonferroni"), 
                                                                  function(x) p_value(x))
     # Grab contrasts that we need from the robust esatimtes
      string <- c("pop_back_regionKenya.gular - pop_back_regionHawaii.gular|pop_back_regionKenya.midflank - pop_back_regionHawaii.midflank|pop_back_regionKenya.tailbase - pop_back_regionHawaii.tailbase|pop_back_regionKenya.topflank - pop_back_regionHawaii.topflank")
      result_DisplayBgrd_pop_back_regionCC <- result_DisplayBgrd_pop_back_regionCC[grep(string, result_DisplayBgrd_pop_back_regionCC$hypothesis),]
###################
# Social Context: Courtship
##################
CourtshipBgrd <- read.table("./data/Courtship_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

CourtshipBgrd <- CourtshipBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
CourtshipBgrd$BodyRegion <- factor(CourtshipBgrd$BodyRegion)

# Filter out only Hawaiian and add in SVL for IDs
CourtshipBgrd$pop_back_region <- with(CourtshipBgrd, interaction(Background_pop, BodyRegion))
CourtshipBgrd_Hawaii <- CourtshipBgrd %>% 
               filter(Population == "Hawaii") %>% 
               left_join(select(svl_dat, ID, SVL), by = "ID", keep = FALSE) %>% 
               mutate(sc_svl = scale(SVL, scale = FALSE)) %>% 
               filter(!is.na(SVL))

##########
## Achromatic Contrast - dL
##########

  # Fit main effects model
    CourtshipAC_main <- lmer(dL ~ sc_svl + Background_pop + BodyRegion + (1|ID), data=CourtshipBgrd_Hawaii)
    summary(CourtshipAC_main)
    

  # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
   robust_CourtshipAC <- clubSandwich::conf_int(CourtshipAC_main, cluster = CourtshipBgrd_Hawaii$ID, vcov =  "CR2")
   
   # Wald tests
           background_AC_Court <- Wald_test(CourtshipAC_main, constraints = constrain_zero(3), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")
           
           BodyRegion_AC_Court <- Wald_test(CourtshipAC_main, constraints = constrain_zero(4:6), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")

   

##########
# Chromatic - dS
##########
  
  # Fit main effect model
      CourtshipCC_inter <- lmer(dS ~ sc_svl + Background_pop + BodyRegion + Background_pop:BodyRegion + (1|ID), data=CourtshipBgrd_Hawaii)
      summary(CourtshipCC_inter)         
  
  # Fit main effect model
      CourtshipCC_main <- lmer(dS ~ sc_svl + Background_pop + BodyRegion + (1|ID), data=CourtshipBgrd_Hawaii)
      summary(CourtshipCC_main)

  # Robust variance esatimation to correct SE's for fixed effects given spectral curves are used multiple times for generating JNDs for each individuals data. 
  robust_CourtshipCC <- clubSandwich::conf_int(CourtshipCC_inter, cluster = CourtshipBgrd_Hawaii$ID, vcov =  "CR2")
  
  # Wald test of interaction; Not important, so we'll simplify and assume just additive effects. This makes sense when we look at the raw data.
  intearction_CC_Court <- Wald_test(CourtshipCC_inter, constraints = constrain_zero(7:9), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")
  
   # Wald tests
           background_CC_Court <- Wald_test(CourtshipCC_main, constraints = constrain_zero(3), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")
  
           BodyRegion_CC_Court <- Wald_test(CourtshipCC_main, constraints = constrain_zero(4:6), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")

    # Get contrasts to understand the specific changes better. Refit model in slight different form. This is essentially an interaction model anyway because it's estimating the mean for Hawaiian and Kenyan background for each body region. The model above is just a contrast-based model.

          CourtshipBgrd_pop_back_BR_CC <- lmer(dS ~ -1 +  sc_svl + pop_back_region + (1|ID), data = CourtshipBgrd_Hawaii) 

     # Fit Robust model
          robust_CourtshipBgrd_pop_back_BR_CC <- clubSandwich::conf_int(CourtshipBgrd_pop_back_BR_CC, 
                                                              cluster = CourtshipBgrd_Hawaii$ID, vcov =  "CR2")
  
     # Contrasts hypothesis tests, but use RVE 
          result_CourtshipBgrd_pop_back_BR_CC <- Wald_test(CourtshipBgrd_pop_back_BR_CC, 
                                                   constraints = constrain_pairwise(c(1:9)),
                                                   cluster = CourtshipBgrd_Hawaii$ID,
                                                   vcov="CR2", tidy = TRUE)
             result_CourtshipBgrd_pop_back_BR_CC$p_val_bonfer <- sapply(p.adjust(result_CourtshipBgrd_pop_back_BR_CC$p_val, "bonferroni"), 
                                                                    function(x) p_value(x))
      
       # Grab contrasts that we need from the robust esatimtes
      string <- c("pop_back_regionKenya.gular - pop_back_regionHawaii.gular|pop_back_regionKenya.midflank - pop_back_regionHawaii.midflank|pop_back_regionKenya.tailbase - pop_back_regionHawaii.tailbase|pop_back_regionKenya.topflank - pop_back_regionHawaii.topflank")
      
         result_CourtshipBgrd_pop_back_BR_CC <- result_CourtshipBgrd_pop_back_BR_CC[
                                            grep(string, result_CourtshipBgrd_pop_back_BR_CC$hypothesis),]
    

```

Martin J. Whiting, Brenden S. Holland, J. Scott Keogh, Daniel W.A.Noble, Katrina J. Rankin and Devi Stuart-Fox

Correspondance: Martin J. Whiting  
Email: martin.whiting@mq.edu.au  

**The file includes**:

Supplementary text  
Figures S1 -- S9  
Tables S1 -- S13  
Supplementary References  



# Expanded Hypotheses and Predictions

We provide an expanded table of the key hypothesis and associated predictions. We also identify the data needed to test these predictions.

```{r tablehyp, tab.cap = "Hypothesis and associated predictions tested in this paper in relation to the population of interest, the receiver visual system used in visual modelling, and the background against which the contrast of the signal was calculated for chromatic and luminance contrast."}
  source("./R/func.R") 
  hyp <-  read.csv(file = "./output/tables/Table_hyp_pred.csv")

  # Table
  hyp2 <- flextable(hyp) %>% table_style12()

  hyp2
```

# Potential bird predators of chameleons on Oahu
We are not aware of any evidence of bird predation of chameleons on Oahu. We consulted with several ornithologists in Hawaii regarding feeding behavior of the few predatory bird species that consume vertebrate prey, and we examined the checklist of the birds of Oahu to determine if any species were potential predators of chameleons, and we examined the checklist of the birds of Oahu to determine if any species were potential predators of chameleons @RN1. Among the larger, predatory birds, two are owls (*Asio flammeus sandwichensis*, *Tyto alba*), which are extremely rare on Oahu. Both species are highly unlikely to feed on chameleons because they feed out in the open rather than in forest canopy where chameleons occur, and typically feed on rodents, birds and insects @RN2. Smaller to medium raptors include the Merlin (*Falco columbarius*) and the peregrine falcon (*Falco peregrinus*) which are both considered rare non-breeding vagrants in the Hawaiian Islands, and feed on small-medium birds in more open habitats @RN2. There are also eight species of egret and heron, which typically have generalist diets. Of these, six are considered rare or accidental @RN1, are associated with aquatic habitats, and are better known for eating fishes @RN3. The cattle egret (*Bubulcus ibis*) is a generalist predator that is mostly insectivorous but does eat lizards opportunistically [@RN4;@RN5]. However, it forages on the ground in more open habitats, often following domestic animals and agricultural or landscaping machinery @RN5 and therefore, is not found in forested habitats and is highly unlikely to encounter chameleons. Among other potential predators, the Hawaiian Hawk or ʻio (*Buteo solitarius*) is restricted to the Big Island, while the Hen Harrier (*Circus cyaneus*) is considered an accidental or rare visitor to the Hawaiian islands. Finally, among corvids, the Hawaiian Crow (*Corvus hawaiiensis*) is extinct in the wild while the Common Raven (*Corvus corax*) is extremely rare @RN1. In summary, we could not identify any bird species that could be regarded as a major predator of chameleons.

# Supplemental Materials and Methods
## Study area and collection of chameleons

We collected most chameleons (Fig. S\@ref(fig:Figcolsig2)) at night by spotlighting, and a small proportion of individuals during the day. When chameleons were beyond reach in the forest canopy, we used lightweight 6-m extensible graphite composite poles (South Bend Kwik Stix™ 20' Telescopic Fishing Pole), that chameleons could be encouraged to step on to, before lowering them to the ground. We then placed them in cotton bags with vegetation to cling to, before returning them to the lab. We measured snout-vent length (SVL), a standard measure of body size in lizards, from the tip of the snout to the posterior edge of the vent using a plastic ruler to the nearest 1 mm. Field work was conducted in Hawaii during January-February 2006 and in Kenya during 5-13 April 2006. In Hawaii, chameleons were collected from a single population in the forested Ko’olau Mountains north of Honolulu, between upper Makiki Valley and the summit of Tantalus Mountain, Oahu, accessible along Tantalus and Roundtop Drives at an elevation of ca. 400-600 m. The vegetation in this area consisted of closed-canopy, mid-elevation tropical rain forest, with extensive vines and undergrowth  (Fig. S\@ref(fig:Figcolsig2)C,D). Most of the plants in this area were non-native, and chameleons also occurred in hedge-grows and stands of bamboo. The area experiences high annual rainfall (mean: ca. 1500 mm) @RN6 and the mean annual temperature is 22-24°C @RN7. In Kenya, field work was conducted near the foothills of Mt. Kenya, close to the town of Runyenjes. The area is partially cleared for agriculture, leaving small stands of forest. The vegetation was a mix of native trees and shrubs interspersed with exotic species (Fig. S\@ref(fig:Figcolsig2)A,B). Mean annual temperature is 20.2°C (mean max: 24.8°C) and the mean annual rainfall is 121 mm @RN8.

```{r Figcolsig, fig.align = 'center', fig.cap = "**Additional examples of chameleon color signals and behavior in response to different social contexts**. **(A)** Two different males in conspicuous display color adopted at the start of a contest and retained by the dominant male. **(B)** Two examples of males engaged in horn locking. Males in the bottom panel are evenly matched at this stage and both are in full display color. In the top image, the male on the left is starting to change to a subordinate color. **(C)** Conspicuous yellow-green male courtship color. When females reject males, they develop a heavily contrasting pattern."}
figs1 <- image_read("./output/figures/FigS1.png")
figs1

```

```{r Figcolsig2, fig.align = 'center', fig.cap = "**Representative photos of habitat in Kenya (A, B) and Hawaii (C, D)**. In both sites, chameleons favored well-vegetated trees and bushes, often with lots of vines."}
figs2 <- image_read("./output/figures/FigS2.jpg")
figs2

```

## Behavioral trials
In order to quantify display coloration, we staged encounters between conspecifics (male-male and male-female) and model predators (bird and snake) and measured their subsequent display coloration (details below). All chameleons were used in both predator and social trials although in some cases we were unable to quantify all social signals for a particular individual. We conducted all conspecific-social trials first, in case anti-predator trials unduly influenced their social interactions. Behavioral trials were conducted during the chameleons’ natural activity period (09:00-16:00 h) beginning the day following capture and continuing over a 2-3 day period. We erected a frame consisting of branches from the chameleons’ environment that were tied together in a triangle and which sat atop three vertical branches that formed a stand (Fig. S\@ref(fig:Figcolsig3)). This structure was about 1.5 m high and each arm was approximately 60 cm. The triangular setup allowed chameleons to display at a comfortable distance, and if necessary, to escape from aggressive interactions, particularly during male-male trials (Fig. S\@ref(fig:Figcolsig3)). All trials were conducted outdoors, but in the shade under the cover of a roof, with vegetation nearby, to simulate their natural environment. The signaling environment was therefore the same for all animals.

```{r Figcolsig3, fig.align = 'center', fig.cap = "**The experimental setup for behavioral trials**. We constructed a platform of three connected horizontal perches in a triangle, thereby always allowing an individual to escape a rival or if a female, a courting male. The male on the left won this contest and is in full display color while the male on the right has lost this contest and turned brown (subordinate)."}
figs3 <- image_read("./output/figures/FigS3.jpg")
figs3

```

We staged trials between males to elicit dominant and subordinate displays and between males and females to elicit courtship displays. This consisted of placing two chameleons at a comfortable distance at which point they typically responded to the conspecific’s presence by rapidly changing color and behavior (Fig. S\@ref(fig:Figcolsig)A,B). In male-male trials both individuals would adopt a lemon-yellow display coloration and advance towards each other. This would be accompanied by head shakes and gapping, leading to horn-locking (Fig. S\@ref(fig:Figcolsig)B) if males were not obviously asymmetric. Once dominance was settled, the subordinate would turn brown (Fig. S\@ref(fig:Figcolsig)B and Fig. S\@ref(fig:Figcolsig3)) and flee. In male-female (courtship) trials, males would turn the same lemon-yellow and approach the female while head shaking and rocking (Fig. S\@ref(fig:Figcolsig)C). 

The day following social trials we presented each chameleon with a snake (Fig. S\@ref(fig:Figcolsig4)A) and bird (Fig. S\@ref(fig:Figcolsig4)B) model predator model (separately). Lizards were drawn at random and the order of presentation (snake or bird first) was random. Both trials were conducted on the same day but were separated by at least three hours. A trial began when a chameleon was removed from its cloth bag and placed on the triangular stand. In the case of the snake model, one of us slowly moved the model snake towards the chameleon from both above and below it, without ever contacting the chameleon, in a standardized fashion (Fig. S\@ref(fig:Figcolsig4)A). In the case of the bird trials, the bird was attached to an ca. 2 m wooden pole and was ‘flown’ past the chameleon from above and below it (Fig. S\@ref(fig:Figcolsig4)B). Trials lasted no more than 2-min and we scored whether the chameleon flipped to the opposite side of the branch, which is a classic anti-predator behavior by chameleons. Once chameleons changed color, we quantified their spectral reflectance (details below). We also conducted seven trials with a just a branch with no predator attached, as a control for the model predator. The snake model was molded from a dead boomslang (*Dispholidus typus*) and painted by a professional artist to resemble a typical green form of this species (previously used in [@RN9;@RN10]). The bird was a mounted African Cuckoo-hawk (*Aviceda cuculoides*).

```{r Figcolsig4, fig.align = 'center', fig.width = 12, fig.height = 12, fig.cap = "**We presented chameleons with model snake and bird predators to elicit an anti-predator response, particularly, color change, to test the hypothesis that character release in Hawaii would also result in a signal more conspicuous to a predator**. **(A)** A model snake (*Dispholidus typus*) causing a characteristic contrasting color change and **(B)** a model bird (*Aviceda cuculoides*) which was flown over the top of the chameleon."}
figs4 <- image_read("./output/figures/FigS4.jpg")
figs4

```

## Color measurement

During all behavior trials, we measured the color of each of three body regions: top flank, mid flank, tail base and gular region (Fig. S\@ref(fig:Figcolsig5)). We measured each body region once only, because chameleons change color rapidly and we had to reduce the handling stress to the animal. The four body regions were measured in random sequence to avoid any bias of order. When a chameleon had completely changed color (to a human observer) and was also performing typical behavior associated with their display (e.g., head shakes, swaying, gaping, rapid approach or flee) we lightly restrained it with one hand, without removing it from its perch, and measured spectral reflectance using a 1.2 m bifurcated probe connected to an Ocean Optics USB-2000 spectrophotometer and a PX2 light source. We used an Ocean Optics RPH-1 probe-holder which we placed in contact with the animal during measurement. The probe holder ensured that measurements were taken at a standard angle (45°) and distance (5 mm) for a 3 x 5 mm area and excluded all ambient light. All measurements were relative to a dark, and a certified 99% white reflectance standard (Labsphere, North Sutton, NH, U.S.A.). If chameleons started to change color in response to our handling, we returned them to the branch and allowed them to continue a social trial before measuring reflectance of remaining body regions. In the case of a predator trial, we would once again present them with the predator model until they returned to their anti-predator display. This system worked effectively because chameleons readily responded to social and anti-predator stimuli and quickly returned to natural behavior following handling.

We obtained spectral reflectance measurements of male dominant color state in male-male contests for 34 individuals from Hawaii and 35 from Kenya, courtship color state for 25 individuals from Hawaii and 32 from Kenya; color state in response to the bird for 56 individuals from Hawaii and 23 from Kenya and color state in response to the snake for 59 individuals from Hawaii and 38 from Kenya.

We quantified the background against which chameleons signal by measuring the spectral reflectance of vegetation in their signaling environment. We took 120 reflectance measures of the background at each location (Hawaii and Kenya), comprising 40 measurements of the top surface of leaves, 40 of the bottom surface of leaves and 40 stems and branches of suitable width for chameleons. To reduce the number of backgrounds, we averaged the reflectance of the 20 darker measurements and 20 lighter measurements for each of the top leaf and bottom leaf measurements and averaged brown stems and green stems. This resulted in 6 average background spectra for each location, representing the range of background colors.

```{r Figcolsig5, fig.align = 'center', fig.width = 12, fig.height = 12, fig.cap = "**Location of body regions we measured for spectral reflectance**. See details in text."}
figs5 <- image_read("./output/figures/FigS5.jpg")
figs5

```

## Visual modeling

We visualized and quality-checked all spectra, adjusted very minor negative reflectance values caused by electrical noise by lifting the curves by the maximum negative value, then smoothed all spectra with LOESS smoothing of 0.16 using the plotsmooth function in `Pavo` vers. 1.0 [@RN29]. We also took the median reflectance for all leaves (top, bottom) and stems (2 measures/stem) for each population (Hawaii, Kenya). 

We modelled how conspicuous a chameleon would appear to both a conspecific receiver and a predator (bird and snake) using the receptor-noise limited (RNL) model [@RN27; @RN28] implemented in the R package `pavo` @RN29. This model assumes that color discrimination is limited only by photoreceptor noise and does not account for potential effects of neural processing. Color contrasts are expressed in units of just-noticeable-differences (JND), where 1 JND is the theoretical threshold of color discrimination for stimuli viewed simultaneously under ideal viewing conditions @RN17. Under natural conditions, discrimination thresholds are likely to be >1 and vary depending on the species and conditions [@RN12;@RN13; @RN14]. Additionally, perceived conspicuousness may not scale linearly with color distance (JNDs) @RN15. Nevertheless, the models provide a reasonable approximation of relative conspicuousness that can be compared between populations and trial types (social and predator). 

We calculated JNDs for chromatic and luminance contrast against each of the relevant backgrounds for each body region and color state, based on the visual system of the relevant receiver (chameleon, bird, snake; see below). We first calculated the quantum catch of each photoreceptor under standard daylight illumination (D65; Commission internationale de l’éclairage – CIE) using the ‘vismodel’ function. We applied the von Kries chromatic adaptation (vonkries = TRUE) and used the average background reflectance of the relevant background (Hawaii or Kenya) as the adapting background. The signal in each photoreceptor class was proportional to the natural logarithm of the quantum catch, in accordance with Fechner's law (“fi” in pavo). Next, we calculated the chromatic contrast between pairs of spectra using the function ‘coldist’. 

The visual models require information on the spectral sensitivities and photoreceptor noise (Weber fraction), which is a function of the relative density of each photoreceptor type within the retina, for the relevant receiver. Chameleons have four spectral classes of single cone enabling tetrachromatic vision @RN16. We used spectral sensitivities for the congeneric flap-necked chameleon (*Chameleo dilepis*) @RN16 and a standard Weber fraction of 0.1 @RN17 to account for the receptor noise of the LWS photoreceptor. We calculated noise for the other photoreceptor classes using the relative photoreceptor ratio of 1: 1.6: 3.3: 3.2 for the four single cones (UVS, SWS, MWS, and LWS, respectively). *Chameleo dilepis* and other chameleons appear to have two populations of MWS cones ($\lambda_{max}$ 481 nm, 497 nm) and three populations of LWS cones ($\lambda_{max}$ 568 nm, 584 nm, 605 nm) so we used a combined sensitivity function for the MWS and LWS cones (Fig. S\@ref(fig:Figcolsig6SPec)).

```{r Figcolsig6SPec, fig.align = 'center', fig.width = 12, fig.height = 10, fig.cap = "**Spectral sensitivities of chameleons (A), bird (B) and snake (C) used for visual models (details in text)**."}
sens_cham_c_dilepis <- read_excel("./data/Spectral sensitivities.xls", sheet = "C_dilepis")[,1:6]
        sens_birdUV <- read_excel("./data/Spectral sensitivities.xls", sheet = "birdUV")
         sens_snake <- read_excel("./data/Spectral sensitivities.xls", sheet = "snake")[,1:4]

cham <- sens_cham_c_dilepis %>% pivot_longer(cols = c(2:6)) %>% select(wavelength, name, value) %>%  data.frame()
bird <- sens_birdUV %>% pivot_longer(cols = c(2:6)) %>% select(wavelength, name, value) %>%  data.frame()
snake <- sens_snake %>% pivot_longer(cols = c(2:4)) %>% select(wavelength, name, value) %>%  data.frame()

plot_spec <- function(data, tri = FALSE){
        data %>% ggplot(aes(x = wavelength, y = value)) + 
      geom_line(aes(color = name), size = 1.2) + 
      theme_bw() +
    scale_colour_manual(values = rev(c("#8D25CC", "#3770C9", "#93C572", "#FFA500", "#DBD8D6"))) +
      labs(x = "Wavelength (nm)", y = "Absorbance", color = "") + 
        theme(legend.position  = c(0.90, 0.65),
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(),
            axis.text = element_text(size = 16),
            axis.title = element_text(size = 24),
            legend.text = element_text(size = 16),
            legend.title = element_text(size = 20))}

p1 <- plot_spec(cham) + theme(legend.position  = "none")
p2 <- plot_spec(bird) 
p3 <- plot_spec(snake) + scale_colour_manual(values = rev(c("#8D25CC", "#93C572", "#FFA500"))) + theme(legend.position  = "none")

plot_grid(p1, p2,p3,nrow = 3, ncol = 1, labels = c("A", "B", "C"), label_size = 30,
  label_fontface = "bold", rel_widths=c(1,1))

```

For birds, we used an ultraviolet sensitive (UVS) visual system @RN18 characteristic of raptors and other birds of prey @RN19. A Weber fraction of 0.06 was used for the LWS photoreceptor based on the most recent empirical measurement @RN20. We used a relative photoreceptor ratio of 1:2:3.4:3 for the UVS, SWS, MWS, and LWS photoreceptors respectively, which represent average values for UVS birds @RN21 (Fig. S\@ref(fig:Figcolsig6SPec)B). 

For snakes, we assumed a trichromatic visual system characteristic of active diurnal snake species, represented by the spectral sensitivities for the garter snake @RN22. We used a Weber fraction of 0.1 for the LWS photoreceptor and a relative photoreceptor ratio of 1:1.6:7.3 for the UVS, SWS, MWS, and LWS photoreceptors, respectively @RN22 (Fig. S\@ref(fig:Figcolsig6SPec)C).

In each case, visual pigment absorbance curves were multiplied by the transmission spectra of ocular media (lens and cornea) and oil droplets associated with the corresponding photoreceptor class and normalized to equal area under the curve to satisfy the assumption of equal stimulation by white light @RN18.  

Luminance contrast was calculated using the sensitivity function for the LWS photoreceptor (with transmission of the oil droplet associated with the double cone in chameleons and birds) for each visual system, assuming a Weber fraction of 0.05 because double cones used for luminance perception in birds and chameleons are by far the most abundant photoreceptor type in the retina [@RN16; @RN23].

## Statistical Analysis

Chromatic and luminance contrast from visual models, measured in just noticeable differences (JNDs), were analyzed using linear mixed effects models in R using the `lme4` package @RN24 in combination with the package `clubSandwich` @RN25. For each individual, measurements for each body region (top flank, mid-flank, tail base and gular region) were contrasted against each of six average background spectra (i.e., average top and bottom of lighter leaves, average top and bottom of darker leaves, average green and average brown stems). While we present sensitivity analyses for all body regions (see below - *Additional Supplemental Results*), we were mainly interested in overall signal differences displayed by chameleons. As such, for our main analyses we averaged estimates (marginalized) across these body regions and background environments given that in many cases body regions showed remarkably similar effects (see *Additional Supplemental Results*). In all cases, our results and conclusions were not impacted (see supplementary code). Deriving multiple contrasts for each individual body region and background, however, resulted in a substantial number of comparisons, each of which were not completely independent of each other. To ensure that non-independence of data did not impact our inferences, we included individual ID as a random effect to account for repeated measures on each individual and used a Robust Variance Estimator (RVE) (using our final models to correct standard errors) and a Satterthwaite degrees of freedom correction.

First, we tested whether Hawaiian chameleons were more conspicuous (as perceived by chameleons) in social contexts than Kenyan chameleons. We ran separate linear models with chromatic and luminance contrast of male display or courtship coloration against the local background as the response variable. We included population of origin and z-transformed snout-vent length (SVL) as fixed effects. Next, we tested whether Kenyan chameleons were more cryptic (less conspicuous against the local background) in response to predators. For these models, chromatic or luminance contrast against the local background (as perceived by the corresponding predator type) was the response variable and predator type (i.e, snake or bird), population of origin (Hawaii or Kenya) and their interaction were fixed effects. Finally, to evaluate evidence for local adaptation, we tested whether the chromatic or luminance contrast of Hawaiian chameleons during social interactions (male-male and male-female) varied depending on whether contrast was against a native Kenyan background or their current introduced habitat background in Hawaii. For all models, interaction terms were first tested using Wald tests. If found to be non-significant (p > 0.1) we dropped the interaction and fitted a main effects model. We then tested the significance of the main effects using Wald tests with robust variance estimators and a Satterthwaite degrees of freedom correction. 

# Supplemental Results
## Body Size Comparisons between Hawaii and Kenya
```{r svl, results = "hide"}
SVLdat <- read.table("data/SVL2.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)
SVLdat$SVL2 <- with(SVLdat, scale(SVL))

# Fit the model
SVL_pop <- t.test(SVL ~ Population, data=SVLdat)
summary(SVL_pop)

# Body size
svl <- data.frame(SVLdat %>% group_by(Population) %>% summarise(mean = mean(SVL), sd = sd(SVL), n = n()))

```
Of the individuals used in social interactions (male-male display or male courtship), chameleons from Kenya were significantly larger than those from Hawaii (mean ± standard deviation Hawaii: `r svl[1,"mean"]`$\pm$ `r svl[1,"sd"]` mm, *n* = `r svl[1,"n"]`; Kenya `r svl[2,"mean"]`$\pm$ `r svl[2,"sd"]` mm, *n* = `r svl[2,"n"]`; t = `r SVL_pop$statistic`, *P* <0.001). SVL did not significantly predict luminance contrast against the background (Table S\@ref(tab:table1)); thus the higher luminance contrast of Hawaiian chameleons during male-male contests and courtship cannot be explained by body size differences between the population. Snout-vent length was a weak predictor of chromatic contrast (Table S\@ref(tab:table1)): larger chameleons had slightly higher chromatic contrast against the background. However, the populations did not differ in chromatic contrast during male displays (courtship and contests).

## Supporting Supplementary Tables for Main Text

```{r table1, fig.width = 8, fig.height = 1, fig.asp = 0.1136364, tab.cap = "Results of models comparing mean differences between Kenyan and Hawaiian lizards in luminance and chromatic contrast against the local background in two social contexts (male-male competition and courtship). Model estimates, standard errors (SE), Satterthwaite's degrees of freedom (df) and 95% confidence internals (95% CI). Standard errors are corrected by using robust variance estimators."}
source("./R/func.R")
final_T1 <-  read.csv(file = "./output/tables/Table1_MS.csv")
  
  # Table
 table1 <- flextable(final_T1) %>%  table_style6() %>% fit_to_width(max_width = 7)
 table1
 
```

```{r table2, fig.width = 8, fig.height = 1, fig.asp = 0.1136364, tab.cap = "Results of models comparing luminance and chromatic mean differences between Kenyan and Hawaiian lizards in response to snakes and birds. Model estimates, standard errors (SE), Satterthwaite's degrees of freedom (df) and 95% confidence internals (95% CI). Full models are provided and standard errors are corrected by using robust variance estimators."}
  final_T2 <- read.csv(file = "./output/tables/Table2_MS.csv")
  # Table
 table2 <- flextable(final_T2) %>%
            table_style7(.) %>% fit_to_width(max_width = 7)
  
 table2
```

```{r table3, fig.width = 9, fig.height = 1, fig.asp = 0.1136364, tab.cap = "Planned contrasts between mean luminance and chromatic contrast in Hawaii and Kenya for both predators (snakes and birds). Estimates of the mean difference ebtween Hawaii and Kenya propulations are provided along with their 95% confidence intervals (95% CI lower and upper). Wald tests of contrast significance are provided (F, degrees of freedom (df) and associated p-value).  We also applied a Bonferroni correction to p-values to control for multiple comparisons."}
 contrast <- read.csv(file = "./output/tables/Table3_MS.csv")
 table3 <- flextable(contrast) %>% table_style8() %>% fit_to_width(max_width = 7)
 table3
```

```{r table4, fig.width = 9, fig.height = 1, fig.asp = 0.1136364, tab.cap = "Results of models comparing luminance and chromatic contrast of Hawaiian lizards against their introduced Hawaiian background (intercept) and Hawaiian lizards against their native Kenyan background (background = Kenya) in both social contexts (male-male competition and courtship). Model estimates (mean and contrasts), standard error (SE), degrees of freedom (df) and 95% confidence intervals (95% CI) for models were fitted using robust variance estimators to correct standard errors for non-independence, and we used Satterthwaite's degrees of freedom. Significant parameter estimates are those where the 95% CIs do not include zero."}
 tb4 <- read.csv(file = "./output/tables/Table4_MS.csv")
 table4 <- flextable(tb4) %>% table_style9() %>% fit_to_width(max_width = 7)
 table4
```

# Additional Supplemental Results
## Body regions are perceived differently by predators but exhibited similar effect sizes

Chromatic contrast of color signals against the background varied by predator type, population and body region (Fig. S\@ref(fig:FigS3)A and Table S\@ref(tab:tableS3)). Whereas all body regions in Kenyan chameleons showed a reduced contrast against the background for birds there were small differences among populations in how snakes perceived color signals (Fig. S\@ref(fig:FigS3)A). There was no significant interaction between predator type ('bird' vs 'snake') and population was not significant for luminance contrast against the background, but there was a marginally non-significant population and body region effect (Fig. S\@ref(fig:FigS3)B and Table S\@ref(tab:tableS3)). Effects did not vary by predator type (Table S\@ref(tab:tableS3)). Nonetheless, effect sizes across body regions were generally in the same direction (Fig. S\@ref(fig:FigS3)B and Table S\@ref(tab:tableS4)). Overall, there were significant differences between Kenya and Hawaii in luminance contrast of the gular and tailbase regions, but not for mid- and top-flank (Table S\@ref(tab:tableS5)). In contrast, no significant differences between Kenya and Hawaii existed across any body region for snakes, whereas significant differences existed between gular, midflank and tailbase for birds (Table S\@ref(tab:tableS6)).

```{r FigS3, fig.align = 'center', fig.width = 12, fig.height = 12, fig.cap = "All four body regions (gular, mid-flank, tailbase and topflank) and their luminance (B) and chromatic contrast (A) to Hawaiian and Kenyan backgrounds (each population against their own background) are shown averaged across stems and leaves found in their habitat. Just noticable differences (JNDs) were calculated for both bird and snake predators. Mean JNDs are provided along with 95% confidence intervals."}

# Load the data
Predator <- read.table("./data/Predator_2_3.csv", 
                       header=TRUE, sep=",", dec=".", strip.white=TRUE)
 
# Clean up
 Predator <- Predator %>% filter(!BodyRegion == "botflank" & !BodyRegion =='gularbot') %>% as.data.frame() #exclude bottom flank.
Predator$BodyRegion <- factor(Predator$BodyRegion) #updates levels for the variable BodyRegion


# Calculate summary data
summary_data_pred <- Predator %>%
                group_by(Predator, Population, BodyRegion) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>%
                mutate(Predator = if_else(Predator == "bird", "Birds", "Snakes"))

# PLot 
p3 <- ggplot(summary_data_pred, aes(x = Population, y = Mean_dL, group = BodyRegion, color = BodyRegion)) + facet_wrap(~Predator) +
  ylim(8, 30) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Luminance contrast (JND)") +
  theme_bw() +
  labs(color = "Body Region") + 
  theme(legend.position = c(0.90, 0.85), 
        strip.background = element_blank(),
    strip.text.x = element_text(size = 24, face = "bold"),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 

p4 <- ggplot(summary_data_pred, aes(x = Population, y = Mean_dS, group = BodyRegion, color = BodyRegion)) + facet_wrap(~Predator) +
  ylim(1, 9) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Chromatic contrast (JND)") +
  labs(colour = "Body Region") + 
  theme_bw() +
  theme(legend.position = c(0.90, 0.85),
    strip.background = element_blank(),
    strip.text.x = element_text(size = 24, face = "bold"),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold"))

plot_grid(p4, p3, nrow = 2, ncol = 1, labels = c("A", "B"), label_size = 30,
  label_fontface = "bold", rel_widths=c(1,1))

```

```{r tableS3, tab.cap = "Wald F tests comparing the significance of model parameters for predator models. Wald F tests were computed using robust variance estimators with a Satterthwaite correction to the degrees of freedom. Interactions were first tested, and models refitted, to test the significance of main effects."}
source("./R/func.R")
fulltableP <- rbind(Wald_table_PredatorAC,
                    Wald_table_PredatorCC)

fulltableP <- fulltableP %>% mutate(JND = c("Luminance Contrast", rep("",4), "Chromatc Contrast", rep("",4)),
                                            p_val = sapply(p_val, function(x) p_value(x))) %>% 
                                      dplyr::select(JND, Variable, Fstat, df_num, df_denom, p_val)

S4 <- flextable(fulltableP) %>%
        table_style3(.) %>% fit_to_width(max_width = 7)
S4
```

```{r tableS4, tab.cap = "Estimated model parameters, standard errors (SE), degrees of freedom (df) along with 95% confidence interval for each parameter from linear mixed effects models. Standard errors were corrected using robust variance estimators and Satterthwaite's degrees of freedom correction was used for calculated significance."}
source("./R/func.R")
robust_sc_pred_table <- rbind(robust_PredatorAC,
                         robust_PredatorCC) %>% 
                    mutate(p_Satt = sapply(p_Satt, function(x) p_value(x)),
                           JND = c("Luminance Contrast", rep("", 9), 
                                   "Chromatic Contrast", rep("", 9)))

robust_sc_pred_table$parameter <- rownames(robust_sc_pred_table)

robust_sc_pred_table <- robust_sc_pred_table %>% select(JND, parameter, beta, SE, tstat, df, p_Satt)


tableS6 <- flextable(robust_sc_pred_table) %>%  table_style5() %>% fit_to_width(max_width = 7)
tableS6
```

```{r tableS5, tab.cap = "Pairwise comparisons of luminance contrast between Kenyan and Hawaiian chameleon displays to a snake and bird visual system. Four different body regions ('gular', 'midflank', 'tailbase', topflank') are provided along with pairwise Wald tests for contrast significance. The Wald test uses a robust variance correction on the standard errors."}
source("./R/func.R")
# Split snakes and birds
result5_snake <-  result5[grep("snake", result5$hypothesis), ] %>% mutate(Species = c("Snake", rep("",3)))
 result5_bird <- result5[grep("bird", result5$hypothesis), ] %>% mutate(Species = c("Bird", rep("",3)))

 # Bind together in order
  final_r5 <- rbind(result5_snake,result5_bird)
  
  
  # Clean
  final_r5 <- final_r5 %>% 
              select(-test, -delta, -df_num) %>%
              mutate(hypothesis = gsub("PopBRInt", "", hypothesis),
                     p_val = sapply(p_val, function(x) p_value(x))) %>%
              select(Species, hypothesis, Fstat, df_denom, p_val, p_val_bonfer)


ft5 <- flextable(final_r5) %>%
        table_style(.) %>% fit_to_width(max_width = 7)
  
 ft5

 
```

```{r tableS6, tab.cap = "Pairwise comparisons of chromatic contrast between Kenyan and Hawaiian chameleon displays to a snake and bird visual system. Four different body regions ('gular', 'midflank', 'tailbase', topflank') are provided along with a pairwise Wald test for contrast significance. The Wald test uses a robust variance correction on the standard errors."}
source("./R/func.R")
# Split snakes and birds

result6_snake <- result6[grep("snake", result6$hypothesis), ] %>% mutate(Species = c("Snake", rep("",3)))
 result6_bird <- result6[grep("bird", result6$hypothesis), ] %>% mutate(Species = c("Bird", rep("",3)))

# Bind together in order
 final_r6 <- rbind(result6_snake,result6_bird)

 
# Clean
 final_r6 <- final_r6 %>% 
              select(-test, -delta, -df_num) %>%
              mutate(hypothesis = gsub("PopBRInt", "", hypothesis),
                     p_val = sapply(p_val, function(x) p_value(x))) %>%
              select(Species, hypothesis, Fstat, df_denom, p_val, p_val_bonfer)
 
 # Table
 ft6 <- flextable(final_r6) %>%
        table_style(.) %>% fit_to_width(max_width = 7)
 
 ft6
```

## All body regions exhibit similar contrasts between Kenyan and Hawaiian backgrounds suggesting local adaptation of entire visual signal

We tested whether different body regions of Hawaiian chameleons exhibited different contrasts between Hawaiian habitat background compared to their ancestral, Kenyan background. We started off testing models comparing the interaction between background environment and body region for both chromatic and luminance contrast. However, for luminance contrast, these models had poor convergence. Based on the raw data (Fig. S\@ref(fig:FigS4)B and S\@ref(fig:FigS4)D) there was also weak evidence that body regions differed in how they changed when viewed by conspecifics against the Hawaiian and Kenyan backgrounds. As such, we simplified models and only present the main effects of body region and background environment for luminance contrast. However, inspection of the raw data (Fig. S\@ref(fig:FigS4)A and S\@ref(fig:FigS4)C) suggested that body regions may differ in how chromatically contrasting they were against the background environment of Hawaii and Kenya. In addition, our main results suggested that predators may deferentially drive chromatic signal conspicuousness, and given different body regions maybe more exposed to bird compared to snake, predators, we fitted an interaction and main effects model for chromatic contrast. 

The magnitude of chromatic contrast differences between Hawaiian chameleons against their own environment and a Kenyan enviroment did depend on the body region (Male-male display: $F_{`r intearction_CC_Disp$df_num`, `r intearction_CC_Disp$df_denom`}$ = `r intearction_CC_Disp$Fstat`, p = `r p_value(intearction_CC_Disp$p_val)`; Courtship Display: $F_{`r intearction_CC_Court$df_num`, `r intearction_CC_Court$df_denom`}$ = `r intearction_CC_Court$Fstat`, *P* = `r p_value(intearction_CC_Court$p_val)`, Fig. S\@ref(fig:FigS4)A, S\@ref(fig:FigS4)C and Table S\@ref(tab:tableS7)). However, in all cases there was a tendency for all body regions of Hawaiian populations to decrease in average contrast when viewed by a conspecific against a Hawaiian versus Kenyan background (Fig. S\@ref(fig:FigS4)A and S\@ref(fig:FigS4)C). Tailbase was the only body region that showed a non-significant change (Table S\@ref(tab:tableS8)). 

The magnitude of luminance contrast showed a significant overall decrease when viewed by conspecifics against a Kenyan background (Overall Background Effect: Male-male display, $F_{`r background_AC_Disp$df_num`, `r background_AC_Disp$df_denom`}$ = `r background_AC_Disp$Fstat`, *P* = `r p_value(background_AC_Disp$p_val)`, Courtship Display, $F_{`r background_AC_Court$df_num`, `r background_AC_Court$df_denom`}$ = `r background_AC_Court$Fstat`, *P* = `r p_value(background_AC_Court$p_val)`, Fig. S\@ref(fig:FigS4)B, S\@ref(fig:FigS4)D and Table S\@ref(tab:tableS7)), and there were significant differences among body regions (Overall Body Region Effect: Male-male display, $F_{`r BodyRegion_AC_Disp$df_num`, `r BodyRegion_AC_Disp$df_denom`}$ = `r BodyRegion_AC_Disp$Fstat`, *P* = `r p_value(BodyRegion_AC_Disp$p_val)`, Courtship Display, $F_{`r BodyRegion_AC_Court$df_num`, `r BodyRegion_AC_Court$df_denom`}$ = `r BodyRegion_AC_Court$Fstat`, *P* = `r p_value(BodyRegion_AC_Court$p_val)`, Fig. S\@ref(fig:FigS4)B, S\@ref(fig:FigS4)D and Table S\@ref(tab:tableS7)). 

```{r FigS4, fig.align = 'center', fig.width = 13, fig.height = 12, fig.cap = "Local adaptation. All four body regions (gular, mid-flank, tailbase and topflank) are shown averaged across stems and leaves found in their habitat. Mean JNDs are provided along with 95% confidence intervals. **(A & B)** represent male-male contest displays whereas **(C & D)** represent courtship displays."}
# Courship data

CourtshipBgrd <- read.table("./data/Courtship_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

CourtshipBgrd <- CourtshipBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
CourtshipBgrd$BodyRegion <- factor(CourtshipBgrd$BodyRegion)


# Display data
DisplayBgrd <- read.table("./data/Display_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

DisplayBgrd <- DisplayBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
DisplayBgrd$BodyRegion <- factor(DisplayBgrd$BodyRegion) #updates levels for the variable BodyRegion

##########
# Data
##########
courtship_summary <- CourtshipBgrd %>% 
                    group_by(Population, Background_pop, BodyRegion) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>% filter(Population == "Hawaii") %>% as.data.frame() %>% mutate(Social_Context = "Courtship")

display_summary <- DisplayBgrd %>%
                group_by(Population, Background_pop, BodyRegion) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>% filter(Population == "Hawaii") %>% as.data.frame() %>% mutate(Social_Context = "Male-male contest")


##########
# Plots
##########

#plots
pS4.1 <- ggplot(courtship_summary, aes(x = Background_pop, y = Mean_dS, color = BodyRegion, group = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Chromatic contrast (JND)") +
  theme_bw() +
  labs(colour = "Body Region") +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 


pS4.2 <- ggplot(courtship_summary, aes(x = Background_pop, y = Mean_dL, color = BodyRegion, group = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Luminance contrast (JND)") +
  theme_bw() +
  labs(colour = "Body Region") +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 

pS4.3 <- ggplot(display_summary, aes(x = Background_pop, y = Mean_dL, group = BodyRegion, color = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Luminance contrast (JND)") +
  theme_bw() +
  theme(legend.position = c(0.80, 0.85),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 

pS4.4 <- ggplot(display_summary, aes(x = Background_pop, y = Mean_dS, group = BodyRegion, color = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Chromatic contrast (JND)") +
  theme_bw() +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 

#pdf(file="./output/figures/Figure2.pdf", height = 10, width = 18)
plot_grid(pS4.4, pS4.3, pS4.1, pS4.2 , labels = c("A", "B", "C", "D"), label_size = 30,
  label_fontface = "bold", rel_widths=c(1,1))

```

```{r tableS7, tab.cap = "Estimated model parameters, standard errors (SE), degrees of freedom (df), and 95% confidence intervals for each parameter. Main effects and interaction models are presented. Only main effect models are presented for luminance contrast (see text for details), whereas interaction models are presented for chromatic contrast. Pairwise contrasts are presented for chromatic contrast models for ease of interpretation."}
source("./R/func.R")
table7 <- rbind(robust_localAdapt_DispBgrdAC,
                robust_DispBgrdCC,
                robust_CourtshipAC,
                robust_CourtshipCC) %>% as.data.frame()

table7$Paramater <- rownames(table7)
rownames(table7) <- NULL

table7 <- table7 %>% 
              mutate(Context = c("Male-Male Display", rep("", 14), "Courtship Display", rep("", 14)),
                     JND = c("Luminance Contrast", rep("", 5), "Chromatic Contrast", rep("", 8), 
                             "Luminance Contrast", rep("", 5), "Chromatic Contrast", rep("", 8))) %>% 
                      dplyr::select(Context, JND, Paramater, beta, SE, df, CI_L, CI_U)

Table7 <- flextable(table7) %>% table_style10() %>% fit_to_width(max_width = 7)
Table7
```

```{r tableS8, tab.cap = "Pairwise Wald F tests comparing changes in chromatic contrast between different body regions for Hawaiian lizards against both Hawaiian and Kenyan backgrounds during male-male and courtship displays. F statistic, degrees of freedom (DF) and p-values are provided (p). A Bonferroni correction to p-values is also provided to control for multiple testing."}

source("./R/func.R")
tab8 <- rbind(result_DisplayBgrd_pop_back_regionCC,
              result_CourtshipBgrd_pop_back_BR_CC) %>%  as.data.frame()

tab8 <- tab8 %>% mutate(Context = c("Male-Male Display", rep("",3), "Courtship Display", rep("",3)),
                        p_val = sapply(p_val, function(x) p_value(x))) %>% 
                        select(Context,c(1:8), -test, -delta, -df_num)

Table8 <- flextable(tab8) %>% table_style11() %>% fit_to_width(max_width = 7)
Table8
```

## Hawaiian chameleons show greater individual change between display and bird color states than Kenyan chameleons

```{r, results='hide'}
#########################################################
# Comparing displays
#########################################################
source("./R/func.R")
 # Load data from Devi
       Display_bird_diff <- read_excel("data/Display_bird_diff.xlsx")
       
       Diff <- Display_bird_diff 

      names(Diff) # header rows R is reading

    Diff$BodyRegion <- factor(Diff$BodyRegion) #updates levels for the variable BodyRegion
    str(diff.difftime) #how R is reading the stucture of the object, double checking the levels for body region after updating levels
    Diff$ID <- factor(Diff$ID) #updates levels for the variable ID
    str(diff.difftime) #how R is reading the stucture of the object, double checking the levels for body region after updating levels

# Center SVL to make intercept interpretable
    Diff$sc_SVL <- with(Diff, as.vector(scale(SVL, scale=FALSE)))

# Filter missing SVL data
  Diff <- Diff %>% filter(!is.na(SVL)) # filter out misssing SVL data

# create as factor
    Diff$BodyRegion <- factor(Diff$BodyRegion)
# Add interaction for contrasts
    Diff$Pop_BodReg <- with(Diff, interaction(Population, BodyRegion))
    
# Sample sizes
    N_diff <- data.frame(Diff %>% group_by(Population) %>% summarise(n = length(unique(ID))))
    
##################
# Achromatic contrast
##################
    
# Fit model testing this idea above. First just test for body region interaction. But, needs RVE
    Diff_dL_BR_int <- lmer(dL_diff_abs ~ sc_SVL + Population + BodyRegion + BodyRegion:Population + (1|ID), data=Diff)
    summary(Diff_dL_BR_int)
    
    # Significance of interaction
      robust_Diff_dl_int <- Wald_test(Diff_dL_BR_int, constraints = constrain_zero(7:9), 
                                    cluster = Diff$ID, vcov = "CR2")
# Main effects BR
    Diff_dL_BR_me <- lmer(dL_diff_abs ~ sc_SVL + Population + BodyRegion  + (1|ID), data=Diff)
    summary(Diff_dL_BR_me)
    
    # Sig of Body Region
        robust_Diff_dL_BR_me <- Wald_test(Diff_dL_BR_me, constraints = constrain_zero(4:6), 
                                    cluster = Diff$ID, vcov = "CR2")
  
# Then fit marginalised model so that body regions are averaged
  Diff_dL <- lmer(dL_diff_abs ~ sc_SVL + Population + (1|ID), data=Diff)
  summary(Diff_dL)

# Check residuals of model
 # hist(residuals(Diff_dL))
 # plot(Diff_dL) # Some patterns in residuals, but likely driven by the absolute. Note that results are essentially the same if using absolute or raw, signed values. 
  
# Refit mdoel using robust standard errors
  robust_Diff_dl_BR <- clubSandwich::conf_int(Diff_dL, cluster = Diff$ID, vcov =  "CR2") 

# Wald tests - Test significance of pop dofferences and SVL differences averaging over body regions
   
  robust_Diff_dl_pop <- Wald_test(Diff_dL, constraints = constrain_zero(3), 
                                  cluster = Diff$ID, vcov = "CR2")
   robust_Diff_dl_svl <- Wald_test(Diff_dL, constraints = constrain_zero(2), 
                                  cluster = Diff$ID, vcov = "CR2")

 # Get contrasts to understand the specific changes better. Refit model in slight different form. This is essentially an interaction model anyway because it's estimating the mean for Hawaiian and Kenyan background for each body region. The model above is just a contrast-based model.

          Diff_pop_back_BR_AC <- lmer(dL_diff_abs ~ -1 +  sc_SVL + Pop_BodReg + (1|ID), data = Diff) 

     # Fit Robust model
          robust_Diff_pop_back_BR_AC <- clubSandwich::conf_int(Diff_pop_back_BR_AC, 
                                                              cluster = Diff$ID, vcov =  "CR2")
  
     # Contrasts hypothesis tests, but use RVE 
          result_robust_Diff_pop_back_BR_AC <- Wald_test(Diff_pop_back_BR_AC, 
                                                   constraints = constrain_pairwise(c(2:9)),
                                                   cluster = Diff$ID,
                                                   vcov="CR2", tidy = TRUE)
             result_robust_Diff_pop_back_BR_AC$p_val_bonfer <- sapply(p.adjust(result_robust_Diff_pop_back_BR_AC$p_val, "bonferroni"), 
                                                                    function(x) p_value(x))
      
       # Grab contrasts that we need from the robust esatimtes
      string <- c("Pop_BodRegKenya.gular - Pop_BodRegHawaii.gular|Pop_BodRegKenya.midflank - Pop_BodRegHawaii.midflank|Pop_BodRegKenya.tailbase - Pop_BodRegHawaii.tailbase|Pop_BodRegKenya.topflank - Pop_BodRegHawaii.topflank")
      
         result_robust_Diff_pop_back_BR_AC <- result_robust_Diff_pop_back_BR_AC[
                                            grep(string, result_robust_Diff_pop_back_BR_AC$hypothesis),]
   
   
##################
# Chromatic contrast
##################  
   
  # Fit model testing this idea above. First just test for body region interaction. But, needs RVE
    Diff_dS_BR_int <- lmer(dS_diff_abs ~ sc_SVL + Population + BodyRegion + BodyRegion:Population + (1|ID), data=Diff)
    summary(Diff_dS_BR_int)
    
    # Significance of interaction
      robust_Diff_dS_int <- Wald_test(Diff_dS_BR_int, constraints = constrain_zero(7:9), 
                                    cluster = Diff$ID, vcov = "CR2")
  # Main effects BR
    Diff_dS_BR_me <- lmer(dS_diff_abs ~ sc_SVL + Population + BodyRegion  + (1|ID), data=Diff)
    summary(Diff_dS_BR_me)
    
    # Sig of Body Region
      robust_Diff_dS_BR_me <- Wald_test(Diff_dS_BR_me, constraints = constrain_zero(4:6), 
                                    cluster = Diff$ID, vcov = "CR2")
   
# Fit model testing this idea above
  Diff_dS <- lmer(dS_diff_abs ~  SVL + Population + (1|ID), data=Diff)
  summary(Diff_dS)

# Check residuals of model
  #hist(residuals(Diff_dS))
  #plot(Diff_dS) # Some patterns in residuals, but likely driven by the absolute. Note that results are essentially the same if using absolute or raw, signed values. 
  
# Refit mdoel using robust standard errors
  robust_Diff_dS <- clubSandwich::conf_int(Diff_dS, cluster = Diff$ID, vcov =  "CR2") 

# Wald tests - Test significance of pop dofferences and SVL differences averaging over body regions
   robust_Diff_dS_pop <- Wald_test(Diff_dS, constraints = constrain_zero(3), 
                                  cluster = Diff$ID, vcov = "CR2")
   robust_Diff_dS_svl <- Wald_test(Diff_dS, constraints = constrain_zero(2), 
                                  cluster = Diff$ID, vcov = "CR2")
   
   # Get contrasts to understand the specific changes better. Refit model in slight different form. This is essentially an interaction model anyway because it's estimating the mean for Hawaiian and Kenyan background for each body region. The model above is just a contrast-based model.

          Diff_pop_back_BR_CC <- lmer(dS_diff_abs ~ -1 +  sc_SVL + Pop_BodReg + (1|ID), data = Diff) 

     # Fit Robust model
          robust_Diff_pop_back_BR_CC <- clubSandwich::conf_int(Diff_pop_back_BR_CC, 
                                                              cluster = Diff$ID, vcov =  "CR2")
  
     # Contrasts hypothesis tests, but use RVE 
          result_robust_Diff_pop_back_BR_CC <- Wald_test(Diff_pop_back_BR_CC, 
                                                   constraints = constrain_pairwise(c(2:9)),
                                                   cluster = Diff$ID,
                                                   vcov="CR2", tidy = TRUE)
             result_robust_Diff_pop_back_BR_CC$p_val_bonfer <- sapply(p.adjust(result_robust_Diff_pop_back_BR_CC$p_val, "bonferroni"), 
                                                                    function(x) p_value(x))
      
       # Grab contrasts that we need from the robust esatimtes
      string <- c("Pop_BodRegKenya.gular - Pop_BodRegHawaii.gular|Pop_BodRegKenya.midflank - Pop_BodRegHawaii.midflank|Pop_BodRegKenya.tailbase - Pop_BodRegHawaii.tailbase|Pop_BodRegKenya.topflank - Pop_BodRegHawaii.topflank")
      
         result_robust_Diff_pop_back_BR_CC <- result_robust_Diff_pop_back_BR_CC[
                                            grep(string, result_robust_Diff_pop_back_BR_CC$hypothesis),]
   
   
```
To gauge the extent of individual color change, we calculated the absolute difference in JNDs between for each individual that had both display (male-male contest) and bird response data (*n* = `r N_diff[1,2]` individuals from Hawaii, *n* = `r N_diff[2,2]` Kenya). We chose these two color states to maximize sample size and because chameleons and birds have similar tetrachromatic visual systems. We tested whether the absolute difference in luminance or chromatic contrast between these two color states differed between populations and body regions. We included SVL, population, body region and the interaction between population and body region as fixed effects. ID was included as a random effect becasue we had measures for more than one body region per individual.

Body regions varied in their overall effects but mainly showed a decrease in absolute JND difference between display and antipredator color states in Kenya compared to Hawaii (Fig. S\@ref(fig:figDisplayPred)). While there was some evidence for an interaction between population and body region for luminance change (albeit weak) this was not the case for chromatic change (population by body region interaction: chromatic: $F_{`r robust_Diff_dS_int$df_num`,`r robust_Diff_dS_int$df_denom`}$ = `r robust_Diff_dS_int$Fstat`, *P* = `r p_value(robust_Diff_dS_int[,6])`; luminance: $F_{`r robust_Diff_dl_int$df_num`,`r robust_Diff_dl_int$df_denom`}$ = `r robust_Diff_dl_int$Fstat`, *P* = `r p_value(robust_Diff_dl_int[,6])`) (Fig. S\@ref(fig:figDisplayPred) and Table S\@ref(tab:tableS9)). However, the degree to which body regions varied within poplations was more apparent for luminance than for chromatic change (main effect of body region: chromatic: $F_{`r robust_Diff_dS_BR_me$df_num`,`r robust_Diff_dS_BR_me$df_denom`}$ = `r robust_Diff_dS_BR_me$Fstat`, *P* = `r p_value(robust_Diff_dS_BR_me[,6])`; luminance: $F_{`r robust_Diff_dL_BR_me$df_num`,`r robust_Diff_dL_BR_me$df_denom`}$ = `r robust_Diff_dL_BR_me$Fstat`, *P* = `r p_value(robust_Diff_dL_BR_me[,6])`) (Fig. S\@ref(fig:figDisplayPred); Table S\@ref(tab:tableS9) and Table S\@ref(tab:tableS10)).

```{r, figDisplayPred, fig.align = 'center', fig.width = 13, fig.height = 7, fig.cap = " Extent of color plasticity between display (male-male contest) and anti-predator (bird) color states (absolute difference in JNDs between states) for Hawaiian (*n* = 30) and Kenyan (*n* = 13) chameleons. **(A)** Average chromatic and **(B)** luminance contrast are provided for each body region"}
##########
# Data
##########
abs_display_pred <- Diff %>%
                group_by(Population, BodyRegion) %>%
                summarise( Mean_dS_abs = mean(dS_diff_abs, na.rm = T), 
                             SE_dS_abs = sd(dS_diff_abs)/sqrt(length(unique(ID))),
                             Upper_dS_abs = Mean_dS_abs + 1.96*SE_dS_abs,
                             Lower_dS_abs = Mean_dS_abs - 1.96*SE_dS_abs, 
                           Mean_dL_abs = mean(dL_diff_abs, na.rm = T), 
                             SE_dL_abs = sd(dL_diff_abs)/sqrt(length(unique(ID))),
                             Upper_dL_abs = Mean_dL_abs + 1.96*SE_dL_abs,
                             Lower_dL_abs = Mean_dL_abs - 1.96*SE_dL_abs) %>% as.data.frame()
##########
# Plots
##########

#plots
p1 <- ggplot(abs_display_pred, aes(x = Population, y = Mean_dS_abs, color = BodyRegion, group = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS_abs, ymax = Upper_dS_abs), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Population") + 
  ylab("Chromatic Change (absolute JND)") +
  theme_bw() +
  labs(colour = "Body Region") +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 


p2 <- ggplot(abs_display_pred, aes(x = Population, y = Mean_dL_abs, color = BodyRegion, group = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL_abs, ymax = Upper_dL_abs), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Population") + 
  ylab("Luminance Change (absolute JND)") +
  theme_bw() +
  labs(colour = "Body Region") +
  theme(legend.position = c(0.80, 0.85),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 

#pdf(file="./output/figures/Figure2.pdf", height = 10, width = 18)
plot_grid(p1, p2, labels = c("A", "B"), label_size = 30,
  label_fontface = "bold", rel_widths=c(1,1))
```

```{r tableS9, tab.cap = "Estimated model parameters, standard errors (SE), degrees of freedom (df) along with 95% confidence interval for each parameter. Full interaction models are presented for chromatic and luminance change (absolute JND)."}
source("./R/func.R")
tab9 <- read.csv("./output/tables/Table5_MS.csv")

Table9 <- flextable(tab9) %>% table_style13() %>% fit_to_width(max_width = 7)
Table9
```

```{r tableS10, tab.cap = "Pairwise Wald F tests for chromatic and luminance change between different body regions for color plasticity between display (male-male contest) and anti-predator (bird) color states (absolute difference in JNDs between states) for Hawaiian (*n* = 30) and Kenyan (*n* = 13) chameleons. F statistic, degrees of freedom (DF) and p-values are provided (p). A Bonferroni correction to p-values is also provided to control for multiple testing."}
source("./R/func.R")
tabS10 <- rbind(result_robust_Diff_pop_back_BR_AC, result_robust_Diff_pop_back_BR_CC)

tabS10 <- tabS10 %>% mutate(VisRealm = c("Luminance Change", rep("",3), "Chromatic Change", rep("",3))) %>% 
                        select(VisRealm, hypothesis, Fstat, df_denom, p_val, p_val_bonfer, -test, -delta, -df_num)

Tables10 <- flextable(tabS10) %>% table_style14() %>% fit_to_width(max_width = 7)
Tables10
```

# References




