---
title: "Supplemental Materials, Methods and Results"
author: Whiting et al. 
date: "`r Sys.Date()`"
bibliography: supp_refs.bib
csl: science.csl
output: 
  bookdown::word_document2:
    toc: no
    toc_depth: 6
    number_sections: false
    reference_docx: template.docx
  bookdown::html_document2:
    code_folding: hide
    number_sections: no
    toc: yes
    toc_depth: 6
    toc_float: yes
    bibliography: refs.bib
---
```{r setup, include=FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, message = FALSE, warning = FALSE, tidy = TRUE)
## numbers >= 10^5 will be denoted in scientific notation,      ## numbers >= 10^5 will be denoted in scientific notation,
  ## and rounded to 2 digits      ## and rounded to 2 digits
  options(digits = 2)
```

```{r getlibrary, echo = FALSE, results = "hide"}
# load libraries
devtools::install_github("karthik/wesanderson")
pacman::p_load(flextable, lme4, lmerTest, ggplot2, lsmeans, emmeans, multcomp, dplyr, wesanderson, patchwork, latex2exp, png, cowplot, magick, jpeg, clubSandwich)
source("./R/func.R")
```

```{r display, results = "hide"}
source("./R/func.R")
#########################################################
# Male-male Competition Displays
#########################################################
  # Load data and clean a bit
  Display_1 <- read.table("./data/Display_1.csv", 
                            header=TRUE, sep=",", dec=".", strip.white=TRUE)
  
  # Exclude bottom flank.
  Display_1 <- Display_1 %>% 
                filter(!BodyRegion == "botflank") %>% as.data.frame() 
  
  # Create as factor
      Display_1$BodyRegion <- factor(Display_1$BodyRegion)
      
  # Center SVL to make intercept interpretable
  Display_1$sc_SVL <- with(Display_1, scale(SVL, scale=FALSE))


##########
## Achromatic Contrast - dL
##########

    # Fit the model that estimates changes across body regions
    ConspicDisplayAC <- lmer(dL ~ sc_SVL + Population + BodyRegion + 
                               Population:BodyRegion + (1|ID), data=Display_1)
    summary(ConspicDisplayAC)
    ConspicDisplayAC_main <- lmer(dL ~ sc_SVL + Population + BodyRegion +  (1|ID), data=Display_1)
    
    # Wald Table - Test for interaction, plus refit model and test sig of each factor. Uses RVEs
    wald_table_ConspicDisplayAC <-  wald_table(model_main =  ConspicDisplayAC_main , model_inter = ConspicDisplayAC)

    # Robust variance estimators (RVE). Mostly all consistent
    Display_subset <- Display_1 %>% filter(!is.na(sc_SVL), !is.na(Population), !is.na(BodyRegion))
    robust_ConspicDisplayAC <- coef_test(ConspicDisplayAC, cluster = Display_subset$ID, vcov="CR2")
    
    # Fit model for linear hypothesis tests
           Display_1$PopBRInt <- interaction(Display_1$Population,Display_1$BodyRegion)
            ConspicDisplayAC2 <- lmer(dL ~ -1 + sc_SVL + PopBRInt + (1|ID), data=Display_1)
            summary(ConspicDisplayAC2)
    
     # Fit RVE
      robust_ConspicDisplayAC2 <- coef_test(ConspicDisplayAC2, cluster = Display_subset$ID, vcov="CR2")
      
     # Contrasts hypothesis tests, but use RVE 
    result1 <- Wald_test(ConspicDisplayAC2, constraints = constrain_pairwise(c(2:9)), vcov="CR2", tidy = TRUE)
    result1$p_val_bonfer <- sapply(p.adjust(result1$p_val, "bonferroni"), function(x) p_value(x))

##########
## Chromatic Contrast - dL
##########

 # Fit the model that esatimtes changes across body regions
    ConspicDisplayCC <- lmer(dS ~ sc_SVL + Population + BodyRegion + Population:BodyRegion + (1|ID), data=Display_1)
    ConspicDisplayCC_main <- lmer(dS ~ sc_SVL + Population + BodyRegion + (1|ID), data=Display_1)
    
    
# Wald Table - Test for interaction, plus refit model and test sig of each factor. Uses RVEs
    wald_table_ConspicDisplayCC <-  wald_table(model_main =  ConspicDisplayCC_main, model_inter = ConspicDisplayCC)
    
 # Robust variance estimators (RVE). Mostly all consistent
             Display_subset <- Display_1 %>% filter(!is.na(sc_SVL), !is.na(Population), !is.na(BodyRegion))
    robust_ConspicDisplayCC <- coef_test(ConspicDisplayCC, cluster = Display_subset$ID, vcov="CR2")    

  # Fit model for linear hypothesis tests
    Display_1$PopBRInt <- interaction(Display_1$Population,Display_1$BodyRegion)
     ConspicDisplayCC2 <- lmer(dS ~ -1 + sc_SVL + PopBRInt + (1|ID), data=Display_1)
     summary(ConspicDisplayCC2)
 
 # Contrasts hypothesis tests, but use RVE 
                 result2 <- Wald_test(ConspicDisplayCC2, constraints = constrain_pairwise(c(2:9)), vcov="CR2", tidy = TRUE)
    result2$p_val_bonfer <- sapply(p.adjust(result2$p_val, "bonferroni"), function(x) p_value(x))

#########################################################
# Courtship Displays
#########################################################

Courtship <- read.table("./data/Courtship_1.2.csv", 
                          header=TRUE, sep=",", dec=".", strip.white=TRUE)

# Center SVL to make intercept interpretable
Courtship$sc_SVL <- with(Courtship, scale(SVL, scale=FALSE))


##########
## Achromatic Contrast - dL
##########
  # Fit model
    ConspicCourtshipAC <- lmer(dL ~ sc_SVL + Population + BodyRegion + 
                                 Population:BodyRegion + (1|ID), data=Courtship)
    summary(ConspicCourtshipAC)
    
  # Main effects Model
    ConspicCourtshipAC_main <- lmer(dL ~ sc_SVL + Population + BodyRegion + (1|ID), data=Courtship)

   # Wald Table - Test for interaction, plus refit model and test sig of each factor. Uses RVEs
    wald_table_ConspicCourtshipAC <-  wald_table(model_main =  ConspicCourtshipAC_main, model_inter = ConspicCourtshipAC)  
  # Robust variance estimators (RVE). Mostly all consistent
             Courtship_subset <- Courtship %>% filter(!is.na(sc_SVL), !is.na(Population), !is.na(BodyRegion))
    robust_ConspicCourtshipAC <- coef_test(ConspicCourtshipAC, cluster = Courtship_subset$ID, vcov="CR2")    
      
  # Refit model for contrasts
     Courtship$PopBRInt <- interaction(Courtship$Population,Courtship$BodyRegion)
    ConspicCourtshipAC2 <- lmer(dL ~ -1 + sc_SVL + PopBRInt + (1|ID), data=Courtship)

  # Contrasts hypothesis tests, but use RVE 
                 result3 <- Wald_test(ConspicCourtshipAC2, constraints = constrain_pairwise(c(2:9)), vcov="CR2", tidy = TRUE)
    result3$p_val_bonfer <- sapply(p.adjust(result3$p_val, "bonferroni"), function(x) p_value(x))

##########
## Chromatic Contrast - dL
#########
    
    # Fit model, interaction
        ConspicCourtshipCC <- lmer(dS ~ sc_SVL + Population + BodyRegion + Population:BodyRegion + (1|ID), data=Courtship)
    
    # Fit main effects
    ConspicCourtshipCC_main <- lmer(dS ~ sc_SVL + Population + BodyRegion + (1|ID), data=Courtship)
    
    # Wald Table - Test for interaction, plus refit model and test sig of each factor. Uses RVEs
    wald_table_ConspicCourtshipCC <-  wald_table(model_main =  ConspicCourtshipCC_main, model_inter = ConspicCourtshipCC)

    # Robust variance estimators (RVE). Mostly all consistent
             Courtship_subset <- Courtship %>% filter(!is.na(sc_SVL), !is.na(Population), !is.na(BodyRegion))
    robust_ConspicCourtshipCC <- coef_test(ConspicCourtshipCC, cluster = Courtship_subset$ID, vcov="CR2")    
    
    # Refit model to get the contrasts between coefficienst we want
     Courtship$PopBRInt <- interaction(Courtship$Population,Courtship$BodyRegion)
    ConspicCourtshipCC2 <- lmer(dS ~ -1 + sc_SVL + PopBRInt + (1|ID), data=Courtship)
    
    # Contrasts hypothesis tests, but use RVE 
            result4 <- Wald_test(ConspicCourtshipCC2, 
                                 constraints = constrain_pairwise(c(2:9)), 
                                 vcov="CR2", tidy = TRUE)
      string <- c("PopBRIntKenya.gular - PopBRIntHawaii.gular|PopBRIntKenya.midflank - PopBRIntHawaii.midflank|PopBRIntKenya.tailbase - PopBRIntHawaii.tailbase|PopBRIntKenya.topflank - PopBRIntHawaii.topflank")
      result4 <- result4[grep(string, result4$hypothesis),]
    result4$p_val_bonfer <- sapply(p.adjust(result4$p_val, "bonferroni"), function(x) p_value(x))
    

#########################################################
# Displays to Predators, birds and snake
#########################################################
   Predator <- read.table("./data/Predator_2_3.csv", 
                         header=TRUE, sep=",", dec=".", strip.white=TRUE)
   
  # Clean up
             Predator <- Predator %>% filter(!BodyRegion == "botflank" & !BodyRegion =='gularbot') %>% as.data.frame() #exclude bottom flank.
  Predator$BodyRegion <- factor(Predator$BodyRegion) #updates levels for the variable BodyRegion

##########
## Achromatic Contrast - dL
##########

   # Fit model
      PredatorAC <- lmer(dL ~ Predator + Population + BodyRegion + Predator:BodyRegion + Predator:Population + 
                           (1|ID), data=Predator)
      summary(PredatorAC)
  
  PredatorAC_main <- lmer(dL ~ Predator + Population + BodyRegion  + (1|ID), data=Predator)
      
  # Wald table RVE
    
    Wald_table_PredatorAC <- wald_table_p(PredatorAC_main, PredatorAC)
  

   # Robust variance estimators (RVE). Mostly all consistent
             Predator_subset <- Predator %>% filter(!is.na(Population), !is.na(BodyRegion))
           robust_PredatorAC <- coef_test(PredatorAC, cluster = Predator_subset$ID, vcov="CR2")    

  # Fit model for linear hypothesis tests
    Predator$PopBRInt <- interaction(Predator$Population,Predator$Predator, Predator$BodyRegion)
     PredatorAC2 <- lmer(dL ~ -1 + PopBRInt + (1|ID), data=Predator)
     summary(PredatorAC2)
 
 # Contrasts hypothesis tests, but use RVE 
                 result5 <- Wald_test(PredatorAC2, constraints = constrain_pairwise(c(1:16)), vcov="CR2", tidy = TRUE)
 string <- c("PopBRIntKenya.snake.midflank - PopBRIntHawaii.snake.midflank|PopBRIntKenya.snake.gular - PopBRIntHawaii.snake.gular|PopBRIntKenya.snake.tailbase - PopBRIntHawaii.snake.tailbase|PopBRIntKenya.snake.topflank - PopBRIntHawaii.snake.topflank|PopBRIntKenya.bird.midflank - PopBRIntHawaii.bird.midflank|PopBRIntKenya.bird.gular - PopBRIntHawaii.bird.gular|PopBRIntKenya.bird.tailbase - PopBRIntHawaii.bird.tailbase|PopBRIntKenya.bird.topflank - PopBRIntHawaii.bird.topflank")
    result5 <- result5[grep(string, result5$hypothesis),]
    result5$p_val_bonfer <- sapply(p.adjust(result5$p_val, "bonferroni"), function(x) p_value(x))
    

##########
## Chromatic Contrast - dS
########

  # Fit Model
        PredatorCC <- lmer(dS ~ Predator + Population + BodyRegion + Predator:BodyRegion + Predator:Population + (1|ID), data=Predator)
        summary(PredatorCC)
          anova(PredatorAC)
          
    PredatorCC_main <- lmer(dS ~ Predator + Population + BodyRegion  + (1|ID), data=Predator)            
  
  # Wald table RVE
    
    Wald_table_PredatorCC <- wald_table_p(PredatorCC_main, PredatorCC)
  
  # Robust variance estimators (RVE). Mostly all consistent
             Predator_subset <- Predator %>% filter(!is.na(Population), !is.na(BodyRegion))
           robust_PredatorCC <- coef_test(PredatorCC, cluster = Predator_subset$ID, vcov="CR2")    
  
  # Fit model for linear hypothesis tests
    Predator$PopBRInt <- interaction(Predator$Population,Predator$Predator, Predator$BodyRegion)
          PredatorCC2 <- lmer(dS ~ -1 + PopBRInt + (1|ID), data=Predator)
          summary(PredatorCC2)
 
 # Contrasts hypothesis tests, but use RVE 
                 result6 <- Wald_test(PredatorCC2, constraints = constrain_pairwise(c(1:16), with_zero = TRUE), vcov="CR2", tidy = TRUE)
                   string <- c("PopBRIntKenya.snake.midflank - PopBRIntHawaii.snake.midflank|PopBRIntKenya.snake.gular - PopBRIntHawaii.snake.gular|PopBRIntKenya.snake.tailbase - PopBRIntHawaii.snake.tailbase|PopBRIntKenya.snake.topflank - PopBRIntHawaii.snake.topflank|PopBRIntKenya.bird.midflank - PopBRIntHawaii.bird.midflank|PopBRIntKenya.bird.gular - PopBRIntHawaii.bird.gular|PopBRIntKenya.bird.tailbase - PopBRIntHawaii.bird.tailbase|PopBRIntKenya.bird.topflank - PopBRIntHawaii.bird.topflank")
    result6 <- result6[grep(string, result6$hypothesis),]
    result6$p_val_bonfer <- sapply(p.adjust(result6$p_val, "bonferroni"), function(x) p_value(x))
    
  
  
#########################################################
# Testing local adaptation contrasting backgrounds between hawaii and Kenya
#########################################################
##################
# Social Context: Male-male competition
##################
DisplayBgrd <- read.table("./data/Display_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

DisplayBgrd <- DisplayBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
DisplayBgrd$BodyRegion <- factor(DisplayBgrd$BodyRegion) #updates levels for the variable BodyRegion

# We only really want to compar the Hawaiian population, so we can subset that data
  DisplayBgrd$pop_back_region <- with(DisplayBgrd, interaction(Population, Background_pop, BodyRegion))
           DisplayBgrd_Hawaii <- DisplayBgrd %>% filter(Population == "Hawaii")
##########
# Achromatic Contrast - dL
##########

  # Main effercts
   DispBgrdAC_main <- lmer(dL ~  Background_pop + BodyRegion + (1|ID), data=DisplayBgrd_Hawaii)
    summary(DispBgrdAC_main)
  
  # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE). Given that there is no interaction, we can just present the main effects model with teh figure. Plus wald tests
  robust_localAdapt_DispBgrdAC <- clubSandwich::conf_int(DispBgrdAC_main, cluster = DisplayBgrd_Hawaii$ID, vcov =  "CR2")

  # Add Wald test to test signifiacnce of each factor using roust variance 
  background_AC_Disp <- Wald_test(DispBgrdAC_main, constraints = constrain_zero(2), 
                                  cluster = DisplayBgrd_Hawaii$ID, vcov = "CR2")
  
  BodyRegion_AC_Disp <- Wald_test(DispBgrdAC_main, constraints = constrain_zero(3:5), 
                                  cluster = DisplayBgrd_Hawaii$ID, vcov = "CR2")

   
##########
# Chromatic Contrast - dS
##########
   
     # Fit the inetarction model
          DispBgrdCC_inter <- lmer(dS ~ Background_pop  + BodyRegion + Background_pop:BodyRegion + (1|ID), data=DisplayBgrd_Hawaii)
          summary(DispBgrdCC_inter)
  
    # Fit the main effect model
          DispBgrdCC_main <- lmer(dS ~ Background_pop  + BodyRegion + (1|ID), data=DisplayBgrd_Hawaii)
          summary(DispBgrdCC_main)
    
    # Wald test to see if interaction is important. Yes, body regions way in how they change from a Hawaiian and Kenyan population. Fig S4, this makes sense. 
        intearction_CC_Disp <- Wald_test(DispBgrdCC_inter, constraints = constrain_zero(6:8), 
                                  cluster = DisplayBgrd_Hawaii$ID, vcov = "CR2")

    # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
      robust_DispBgrdCC <- clubSandwich::conf_int(DispBgrdCC_inter, cluster = DisplayBgrd_Hawaii$ID, vcov =  "CR2")


    # Get contrasts to understand the specific changes better. Refit model in slight different form. This is essentially an interaction model anyway because it's estimating the mean for Hawaiian and Kenyan background for each body region. The model above is just a contrast-based model.
    DisplayBgrd_pop_back_regionCC <- lmer(dS ~ -1 + pop_back_region + (1|ID), data = DisplayBgrd_Hawaii) 

    # Fit Robust model
    robust_DisplayBgrd_pop_back_regionCC <- clubSandwich::conf_int(DisplayBgrd_pop_back_regionCC, 
                                                            cluster = DisplayBgrd_Hawaii$ID, 
                                                            vcov =  "CR2")
   
    # Contrasts hypothesis tests, but use RVE 
      result_DisplayBgrd_pop_back_regionCC <- Wald_test(DisplayBgrd_pop_back_regionCC, 
                                                 constraints = constrain_pairwise(c(1:8)), 
                                                 vcov="CR2", tidy = TRUE)
      
      result_DisplayBgrd_pop_back_regionCC$p_val_bonfer <- 
                                  sapply(p.adjust(result_DisplayBgrd_pop_back_regionCC$p_val, "bonferroni"), 
                                                                  function(x) p_value(x))
     # Grab contrasts that we need from the robust esatimtes
      string <- c("pop_back_regionHawaii.Kenya.gular - pop_back_regionHawaii.Hawaii.gular|pop_back_regionHawaii.Kenya.midflank - pop_back_regionHawaii.Hawaii.midflank|pop_back_regionHawaii.Kenya.tailbase - pop_back_regionHawaii.Hawaii.tailbase|pop_back_regionHawaii.Kenya.topflank - pop_back_regionHawaii.Hawaii.topflank")
      result_DisplayBgrd_pop_back_regionCC <- result_DisplayBgrd_pop_back_regionCC[grep(string, result_DisplayBgrd_pop_back_regionCC$hypothesis),]

###################
# Social Context: Courtship
##################
CourtshipBgrd <- read.table("./data/Courtship_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

CourtshipBgrd <- CourtshipBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
CourtshipBgrd$BodyRegion <- factor(CourtshipBgrd$BodyRegion)

# Just subset out the Hawaiian data as we are only intersted in Hawaii on different backgrounds
  CourtshipBgrd$pop_back_BR <- with(CourtshipBgrd, interaction(Population, Background_pop, BodyRegion))
         CourtshipBgrd_Hawaii <- CourtshipBgrd %>% filter(Population == "Hawaii")
##########
## Achromatic Contrast - dL
##########

  # Fit main effects model
    CourtshipAC_main <- lmer(dL ~ Background_pop + BodyRegion + (1|ID), data=CourtshipBgrd_Hawaii)
    summary(CourtshipAC_main)
    

  # Check robustness of results to non-indepenedence using Robust Variance Estimator (RVE)
   robust_CourtshipAC <- clubSandwich::conf_int(CourtshipAC_main, cluster = CourtshipBgrd_Hawaii$ID, vcov =  "CR2")
   
   # Wald tests
           background_AC_Court <- Wald_test(CourtshipAC_main, constraints = constrain_zero(3), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")
           
           BodyRegion_AC_Court <- Wald_test(CourtshipAC_main, constraints = constrain_zero(3:5), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")


##########
# Chromatic - dS
##########
  
  # Fit main effect model
      CourtshipCC_inter <- lmer(dS ~ Background_pop + BodyRegion + Background_pop:BodyRegion + (1|ID), data=CourtshipBgrd_Hawaii)
      summary(CourtshipCC_inter)         
  
  # Fit main effect model
      CourtshipCC_main <- lmer(dS ~ Background_pop + BodyRegion + (1|ID), data=CourtshipBgrd_Hawaii)
      summary(CourtshipCC_main)

  # Robust variance esatimation to correct SE's for fixed effects given spectral curves are used multiple times for generating JNDs for each individuals data. 
  robust_CourtshipCC <- clubSandwich::conf_int(CourtshipCC_inter, cluster = CourtshipBgrd_Hawaii$ID, vcov =  "CR2")
  
  # Wald test of interaction; Not important, so we'll simplify and assume just additive effects. This makes sense when we look at the raw data.
  intearction_CC_Court <- Wald_test(CourtshipCC_inter, constraints = constrain_zero(6:8), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")
  
   # Wald tests
           background_CC_Court <- Wald_test(CourtshipCC_main, constraints = constrain_zero(2), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")
  
           BodyRegion_CC_Court <- Wald_test(CourtshipCC_main, constraints = constrain_zero(3:5), 
                                  cluster = CourtshipBgrd_Hawaii$ID, vcov = "CR2")

    # Get contrasts to understand the specific changes better. Refit model in slight different form. This is essentially an interaction model anyway because it's estimating the mean for Hawaiian and Kenyan background for each body region. The model above is just a contrast-based model.

          CourtshipBgrd_pop_back_BR_CC <- lmer(dS ~ -1 + pop_back_BR + (1|ID), data = CourtshipBgrd_Hawaii) 

     # Fit Robust model
          robust_CourtshipBgrd_pop_back_BR_CC <- clubSandwich::conf_int(CourtshipBgrd_pop_back_BR_CC, 
                                                              cluster = CourtshipBgrd_Hawaii$ID, vcov =  "CR2")
  
     # Contrasts hypothesis tests, but use RVE 
          result_CourtshipBgrd_pop_back_BR_CC <- Wald_test(CourtshipBgrd_pop_back_BR_CC, 
                                                   constraints = constrain_pairwise(c(1:8)),
                                                   cluster = CourtshipBgrd_Hawaii$ID,
                                                   vcov="CR2", tidy = TRUE)
             result_CourtshipBgrd_pop_back_BR_CC$p_val_bonfer <- sapply(p.adjust(result_CourtshipBgrd_pop_back_BR_CC$p_val, "bonferroni"), 
                                                                    function(x) p_value(x))
      
       # Grab contrasts that we need from the robust esatimtes
      string <- c("pop_back_BRHawaii.Kenya.gular - pop_back_BRHawaii.Hawaii.gular|pop_back_BRHawaii.Kenya.midflank - pop_back_BRHawaii.Hawaii.midflank|pop_back_BRHawaii.Kenya.tailbase - pop_back_BRHawaii.Hawaii.tailbase|pop_back_BRHawaii.Kenya.topflank - pop_back_BRHawaii.Hawaii.topflank")
      
         result_CourtshipBgrd_pop_back_BR_CC <- result_CourtshipBgrd_pop_back_BR_CC[
                                            grep(string, result_CourtshipBgrd_pop_back_BR_CC$hypothesis),]
    

```

# Expanded Hypotheses and Predictions

We provided an expanded table of hypotheses and associated predictions. We also identify the data needed to test these predictions.

```{r tablehyp, tab.cap = "Hypotheses and associated predictions tested in this paper in relation to the population of interest, the receiver visual system used in visual modelling, and the background against which the contrast of the signal was calculated for chromatic and achromatic contrast."}
  source("./R/func.R") 
  hyp <-  read.csv(file = "./output/tables/Table_hyp_pred.csv")

  # Table
  hyp2 <- flextable(hyp) %>% table_style12()

  hyp2
```

# Supplemental Materials and Methods
## Study area and collection of chameleons

We collected most chameleons (Fig. \@ref(fig:Figcolsig)) at night by spotlighting, and a small proportion of individuals during the day. When chameleons were beyond reach, we used 4-m extensible poles that chameleons could be encouraged to step on to, before lowering them to the ground. We then placed them in cotton bags with vegetation to cling to, before returning them to the lab. Field work was conducted in Hawaii during January-February 2006 and in Kenya during 5-13 April 2006. In Hawaii, chameleons were collected from a single population in the Manoa Valley, Oahu, accessible along Tantalus and Roundtop Drives at an elevation of ca. 400-600m. The vegetation in this area consisted of closed-canopy, mid-elevation tropical rain forest, with extensive vines and undergrowth (Fig. \@ref(fig:Figcolsig2)A,B). Most of the plants in this area were nonnative, and chameleons also occurred in hedge-grows and stands of bamboo. The area experiences high annual rainfall (mean: ca. 1500 mm) @RN1 and the mean annual temperature is 22-24&deg;C @RN2. In Kenya, field work was conducted near the foothills of Mt. Kenya, close to the town of Runyenjes. The area is partially cleared for agriculture, leaving small stands of forest. The vegetation was a mix of native trees and shrubs interspersed with exotic species (Fig. \@ref(fig:Figcolsig2)C,D). Mean annual temperature is 20.2&deg;C (mean max: 24.8&deg;C) and the mean annual rainfall is 121 mm @RN3. 

```{r Figcolsig, fig.align = 'center', fig.cap = "Additional examples of chameleon color signals and behavior in response to different social contexts. (A) Two different males in conspicuous display color adopted at the start of a contest and retained by the dominant male. (B) Two examples of males engaged in horn locking. Males in the bottom plane are evenly matched at this stage and both are in full display colour. In the top image, the male on the left is starting to change to a subordinate color. (C) Conspicuous lemon-yellow male courtship color. In this case, the female is using a contrasting stress color consistent with rejection."}
figs1 <- image_read("./output/figures/FigS1.png")
figs1

```

```{r Figcolsig2, fig.align = 'center', fig.cap = "Representative photos of habitat in Hawaii (A, C) and Kenya (B, D). In both sites, chameleons favored well-vegetated trees and bushes, often with lots of vines."}
figs2 <- image_read("./output/figures/FigS2.png")
figs2

```

## Behavioral trials

In order to quantify display coloration we staged encounters between conspecifics (male-male and male-female) and model (bird and snake) predators and measured their subsequent display coloration (details below). All chameleons were used in both predator and social trials although in some cases we were unable to quantify all social signals for a particular individual. We conducted all conspecific-social trials first, in case anti-predator trials unduly influenced their social interactions. Behavioral trials were conducted during the chameleons’ natural activity period (09:00-16:00 h) beginning the day following capture and continuing over a 2-3 day period. We erected a frame consisting of branches from the chameleons’ environment that were tied together in a triangle and which sat atop three vertical branches that formed a stand. This structure was about 1.5 m high and each arm was approximately 60 cm. The triangular setup allowed chameleons to display at a comfortable distance and also to escape from aggressive interactions, particularly during male-male trials (Fig. \@ref(fig:Figcolsig4)). All trials were conducted outdoors, but in the shade under the cover of a roof, with vegetation nearby, to simulate their natural environment. The signalling environment was therefore the same for all animals.

```{r Figcolsig3, fig.align = 'center', fig.cap = "The experimental setup for behavioral trials. We constructed a platform of three connected horizontal perches in a triangle, thereby always allowing an individual to escape a rival or if a female, a courting male."}
figs3 <- image_read("./output/figures/FigS3.jpg")
figs3

```

We staged trials between males to elicit dominant and subordinate displays and between males and females to elicit courtship displays. This consisted of placing two chameleons at a comfortable distance at which point they typically responded to the conspecific’s presence by rapidly changing colour and behaviour (Fig. \@ref(fig:Figcolsig)A,B). In male-male trials both individuals would adopt a lemon-yellow display coloration and advance towards each other. This would be accompanied by head shakes and would lead to horn-locking (Fig. \@ref(fig:Figcolsig)B) if males were not obviously asymmetric. Once dominance was settled, the subordinate would turn brown (Fig. \@ref(fig:Figcolsig)B) and flee. In male-female (courtship) trials, males would turn the same lemon-yellow and approach the female while head shaking and rocking (Fig. \@ref(fig:Figcolsig)C). The day following social trials we presented each chameleon with a snake (Fig. \@ref(fig:Figcolsig4)A) and bird (Fig. \@ref(fig:Figcolsig4)B) model predator (separately). Lizards were drawn at random and the order of presentation (snake or bird first) was random. Both trials were conducted on the same day but were separated by at least three hours. A trial began when a chameleon was removed from its cloth bag and placed on the triangular stand. At this point the lizard was in a neutral color state. In the case of the snake model, one of us slowly moved the model snake towards the chameleon from both above and below it, without ever contacting the chameleon, in a standardized fashion (Fig. \@ref(fig:Figcolsig4)A). In the case of the bird trials, the bird was attached to an ca. 2 m wooden pole and was ‘flown’ past the chameleon from above and below it (Fig. \@ref(fig:Figcolsig4)B). Trials lasted no more than 2-min and we scored whether the chameleon flipped to the opposite side of the branch, which is a classic anti-predator behavior by chameleons. Once chameleons changed color, we quantified their spectral reflectance following the same procedure described for social trials. We also conducted seven trials with a just a branch with no predator attached, as a control for the model predator. The snake model was molded from a dead boomslang (*Dispholidus typus*) and painted by a professional artist to resemble a typical green form of this species (previously used in [@RN6;@RN7]). The bird was a mounted African cuckoo-hawk (*Aviceda cuculoides*).

```{r Figcolsig4, fig.align = 'center', fig.width = 12, fig.height = 12, fig.cap = "We presented chameleons with model snake and bird predators to elicit an anti-predator response, particularly, color change, to test the hypothesis that character release in Hawaii would also result in a signal more conspicuous to a predator. (A) A model snake (Dispholidus typus) causing a characteristic contrasting color change and (B) a model bird (Aviceda cuculoides) which was flown over the top of the chameleon."}
figs4 <- image_read("./output/figures/FigS4.jpg")
figs4

```

## Color measurements, habitat background and irradiance

During all behavior trials, we measured the color of each body region (Fig. \@ref(fig:Figcolsig5)) once only, because chameleons change color rapidly and we had to reduce the handling stress to the animal. Patches were measured in random sequence to avoid any bias of order. When a chameleon had completely changed color (to a human observer) and was also performing typical behavior associated with their display (e.g., head shakes, swaying, gaping, rapid approach or flee) we lightly restrained it with one hand, without removing it from its perch, and measured spectral reflectance using a 1.2 m bifurcated probe connected to an Ocean Optics USB-2000 optic spectrophotometer and a PX2 light source. We used a custom-made probe-holder which we placed in contact with the animal at a standard angle (45&deg; @RN2) and distance (5 mm), thereby excluding ambient light. All measurements were relative to a dark, and a certified 99% white reflectance standard. When chameleons started to change color in response to our handling we stopped measuring color and allowed them to continue a social trial before continuing to measure spectral reflectance. In the case of a predator trial we would once again present them with the predator model until they returned to their anti-predator display. This system worked effectively because chameleons readily responded to social and anti-predator stimuli and quickly returned to natural behavior following handling.

We quantified the background against which chameleons signal by measuring the spectral reflectance of vegetation in their signalling environment. This included 1.) the upper surface of leaves; 2.) the underside of leaves; and 3.) branches. We also measured the habitat light environment by recording irradiance in the chameleons environment.

```{r Figcolsig5, fig.align = 'center', fig.width = 12, fig.height = 12, fig.cap = "Location of body regions we measured for spectral reflectance. See details in text."}
figs5 <- image_read("./output/figures/FigS5.jpg")
figs5

```

## Visual modelling


## Statistical Analysis

Chromatic and achromatic contrast from visual models, measured in just noticeable differences (JNDs), were analyzed using linear mixed effects models in R using the `lme4` package @RN4 in combination with the package `clubSandwich` @RN5. For all individuals, we measured signals for multiple body regions, each of which were contrasted between multiple background measurements (i.e., top and bottoms of two leaves and two stems). While we present sensitivity analyses for all body regions (see below - *Additional Supplemental Results*), we were mainly interested in overall signal differences displayed by chameleons. As such, for our main analyses we averaged estimates (marginalized) across these body regions and background environments given that in many cases body regions showed remarkably similar effects (see *Additional Supplemental Results*). In all cases, our results and conclusions were not impacted (see supplementary code). Deriving multiple contrast for each individual body region and background, however, resulted in a substantial number of comparisons, each of which were not completely independent of each other. To ensure that non-independence of data did not impact our inferences we used a Robust Variance Estimator (RVE) (using our final models to correct standard errors) and a Satterthwaite degrees of freedom correction. Across the different contexts (i.e., social contexts, predation, and background environments), chromatic and achromatic contrasts were analyzed in separate models as response variables. For analyses involving social context, we included z-transformed snout-vent length (SVL), population of origin, and their interaction as fixed effects. For models involving predatory contexts and visual systems, we included the predator type (i.e, snake or bird), population of origin and their interaction as fixed effects. Finally, to test local adaptation, we used only chameleons from Hawaii and tested the extent to which chromatic and achromatic contrast varied depending on whether Hawaiian signals were observed on a native Kenyan background or their current introduced habitat background in Hawaii. Relevant model interactions were first tested using Wald tests. If found to be non-significant (p > 0.1) we dropped the interaction and fit a main effects model. We then tested the significance of the main effect of 'Population', 'Predator' or 'Background' (depending on the model) using Wald tests with robust variance estimators and a Satterthwaite degrees of freedom correction.  

# Supplemental Results
## Supporting Supplementary Tables for Main Text

```{r table1, fig.width = 8, fig.height = 1, fig.asp = 0.1136364, tab.cap = "Model estimates, standard errors (SE), Satterthwaite degrees of freedom (df) and 95% confidence internals (95% CI) comparing achromatic and chromatic mean differences between Kenyan and Hawaiian lizards in two social contexts (Male-Male Competition and Courtship). Standard errors are corrected by using robust variance estimators. "}
source("./R/func.R")
final_T1 <-  read.csv(file = "./output/tables/Table1_MS.csv")
  
  # Table
 table1 <- flextable(final_T1) %>%  table_style6() %>% fit_to_width(max_width = 7)
 table1
 
```

```{r table2, fig.width = 8, fig.height = 1, fig.asp = 0.1136364, tab.cap = "Model estimates, standard errors (SE), Satterthwaite degrees of freedom (df) and 95% confidence internals (95% CI) comparing achromatic and chromatic mean differences between Kenyan and Hawaiian lizards for snakes and lizards. Full models are provided and standard errors are corrected by using robust variance estimators."}
  final_T2 <- read.csv(file = "./output/tables/Table2_MS.csv")
  # Table
 table2 <- flextable(final_T2) %>%
            table_style7(.) %>% fit_to_width(max_width = 7)
  
 table2
```

```{r table3, fig.width = 9, fig.height = 1, fig.asp = 0.1136364, tab.cap = "Planned contrasts between mean achromatic and chormatic contrast in Hawaii and Kenya for both predators (snakes and birds). Estimates of the mean difference ebtween Hawaii and Kenya propulations are provided along with their 95% confidence intervals (95% CI lower and upper). Wald tests of contrast significance are provided (F, degrees of freedom (df) and associated p-value).  We also applied a Bonferroni correction to p-value to control for multiple comparisons."}
 contrast <- read.csv(file = "./output/tables/Table3_MS.csv")
 table3 <- flextable(contrast) %>% table_style8() %>% fit_to_width(max_width = 7)
 table3
```


```{r table4, fig.width = 9, fig.height = 1, fig.asp = 0.1136364, tab.cap = "Model estimates (mean and contrasts), standard error (SE), degrees of freedom (df) and 95% confidence intervals (95% CI) for comparing achromatic and chromatic contrast of Hawaiian lizards against their introduced Hawaiian background (intercept) and Hawaiian lizards against their native Kenyan background (Background = Kenya) in both social contexts (Male-male competition and Courtship). Models were fit using robust variance estaimators to correct standard errors for non-independence, and we used a Saitterwaite degrees of freedom. Significance parameter estimates are those where 95% CI does not include zero."}
 tb4 <- read.csv(file = "./output/tables/Table4_MS.csv")
 table4 <- flextable(tb4) %>% table_style9() %>% fit_to_width(max_width = 7)
 table4
```

# Additional Supplemental Results
## Body regions are perceived differently by predators but exhibited similar effect sizes

Chromatic contrast of color signals against the background varied by predator type, population and body region (Figure \@ref(fig:FigS3)B; Table \@ref(tab:tableS3)). Whereas all body regions in Kenyan chameleons showed a reduced contrast against the background for birds there were small differences among populations in how snakes perceived color signals (Figure \@ref(fig:FigS3)A). There were no significant interactions between predator type ('bird' vs 'snake') and either body region or population in achromatic contrast against the background, but a significant population and body region effect (Figure \@ref(fig:FigS3)B; Table \@ref(tab:tableS3)). Effects did not vary by predator type (Table \@ref(tab:tableS3)). Nonetheless, effect sizes across body regions were in the same direction (Figure \@ref(fig:FigS3)B & Table \@ref(tab:tableS4)). Overall, there were significant differences between Kenya and Hawaii in achromatic contrast of the gular and tailbase regions, but not for mid- and top-flank (Table \@ref(tab:tableS5)). In contrast, no significant differences between Kenya and Hawaii existed across any body region, whereas significant differences existed between gular, midflank and tailbase (Table \@ref(tab:tableS6)).

```{r FigS3, fig.align = 'center', fig.width = 12, fig.height = 12, fig.cap = "All four body regions (gular, mid-flank, tailbase and topflank) and their achromatic (B) and chromatic contrast (A) to Hawaiian and Kenyan backgrounds (each population against their own background) are shown averaged across stems and leaves found in their habitat. Just noticable differences (JNDs) are calculated for both bird and snake predators. Mean JNDs are provided along with 95% confidence intervals."}

# Load the data
Predator <- read.table("./data/Predator_2_3.csv", 
                       header=TRUE, sep=",", dec=".", strip.white=TRUE)
 
# Clean up
 Predator <- Predator %>% filter(!BodyRegion == "botflank" & !BodyRegion =='gularbot') %>% as.data.frame() #exclude bottom flank.
Predator$BodyRegion <- factor(Predator$BodyRegion) #updates levels for the variable BodyRegion


# Calculate summary data
summary_data_pred <- Predator %>%
                group_by(Predator, Population, BodyRegion) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>%
                mutate(Predator = if_else(Predator == "bird", "Birds", "Snakes"))

# PLot 
p3 <- ggplot(summary_data_pred, aes(x = Population, y = Mean_dL, group = BodyRegion, color = BodyRegion)) + facet_wrap(~Predator) +
  ylim(8, 30) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Achromatic contrast (JND)") +
  theme_bw() +
  labs(color = "Body Region") + 
  theme(legend.position = c(0.90, 0.85), 
        strip.background = element_blank(),
    strip.text.x = element_text(size = 24, face = "bold"),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 

p4 <- ggplot(summary_data_pred, aes(x = Population, y = Mean_dS, group = BodyRegion, color = BodyRegion)) + facet_wrap(~Predator) +
  ylim(1, 9) + 
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("") + 
  ylab("Chromatic contrast (JND)") +
  labs(colour = "Body Region") + 
  theme_bw() +
  theme(legend.position = c(0.90, 0.85),
    strip.background = element_blank(),
    strip.text.x = element_text(size = 24, face = "bold"),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold"))

plot_grid(p4, p3, nrow = 2, ncol = 1, labels = c("A", "B"), label_size = 30,
  label_fontface = "bold", rel_widths=c(1,1))

```

```{r tableS3, tab.cap = "Wald F tests comparing the significance of model parameters for predator models. Wald F tests were computed using robust variance estimators with a Saitterwaite correction to the degrees of freedom. Interactions were first tested and models refit to test the signifiacnce of main effects"}

fulltableP <- rbind(Wald_table_PredatorAC,
                    Wald_table_PredatorCC)

fulltableP <- fulltableP %>% mutate(JND = c("Achromatic Contrast", rep("",4), "Chromatc Contrast", rep("",4)),
                                            p_val = sapply(p_val, function(x) p_value(x))) %>% 
                                      select(JND, Variable, Fstat, df_num, df_denom, p_val)

S4 <- flextable(fulltableP) %>%
        table_style3(.) %>% fit_to_width(max_width = 7)
S4
```

```{r tableS4, tab.cap = "Estimated model parameters, standard errors (SE), degrees of freedom (df) along with 95% confidence interval for each parameter from linear mixed effects models. Standard errors were corrected using robust variance estimators and Saitterwaite degrees of freedom correction was used for calculated significance"}
robust_sc_pred_table <- rbind(robust_PredatorAC,
                         robust_PredatorCC) %>% 
                    mutate(p_Satt = sapply(p_Satt, function(x) p_value(x)),
                           JND = c("Achromatic Contrast", rep("", 9), 
                                   "Chromatic Contrast", rep("", 9)))

robust_sc_pred_table$parameter <- rownames(robust_sc_pred_table)

robust_sc_pred_table <- robust_sc_pred_table %>% select(JND, parameter, beta, SE, tstat, df, p_Satt)


tableS6 <- flextable(robust_sc_pred_table) %>%  table_style5() %>% fit_to_width(max_width = 7)
tableS6
```

```{r tableS5, tab.cap = "Pairwise comparisons of achormatic contrast between Kenyan and Hawaiian chameleon displays to a snake and bird visual system. Four different body regions ('gular', 'midflank', 'tailbase', topflank') are provided along with pairwise Wald test for contrast significance. Wald test uses a robust variance correction on the standard errors."}

# Split snakes and birds
result5_snake <-  result5[grep("snake", result5$hypothesis), ] %>% mutate(Species = c("Snake", rep("",3)))
 result5_bird <- result5[grep("bird", result5$hypothesis), ] %>% mutate(Species = c("Bird", rep("",3)))

 # Bind together in order
  final_r5 <- rbind(result5_snake,result5_bird)
  
  
  # Clean
  final_r5 <- final_r5 %>% 
              select(-test, -delta, -df_num) %>%
              mutate(hypothesis = gsub("PopBRInt", "", hypothesis),
                     p_val = sapply(p_val, function(x) p_value(x))) %>%
              select(Species, hypothesis, Fstat, df_denom, p_val, p_val_bonfer)


ft5 <- flextable(final_r5) %>%
        table_style(.) %>% fit_to_width(max_width = 7)
  
 ft5

 
```

```{r tableS6, tab.cap = "Pairwise comparisons of achormatic contrast between Kenyan and Hawaiian chameleon displays to a snake and bird visual system. Four different body regions ('gular', 'midflank', 'tailbase', topflank') are provided along with pairwise Wald test for contrast significance. Wald test uses a robust variance correction on the standard errors."}

# Split snakes and birds

result6_snake <- result6[grep("snake", result6$hypothesis), ] %>% mutate(Species = c("Snake", rep("",3)))
 result6_bird <- result6[grep("bird", result6$hypothesis), ] %>% mutate(Species = c("Bird", rep("",3)))

# Bind together in order
 final_r6 <- rbind(result6_snake,result6_bird)

 
# Clean
 final_r6 <- final_r6 %>% 
              select(-test, -delta, -df_num) %>%
              mutate(hypothesis = gsub("PopBRInt", "", hypothesis),
                     p_val = sapply(p_val, function(x) p_value(x))) %>%
              select(Species, hypothesis, Fstat, df_denom, p_val, p_val_bonfer)
 
 # Table
 ft6 <- flextable(final_r6) %>%
        table_style(.) %>% fit_to_width(max_width = 7)
 
 ft6
```

## All body regions exhibit similar contrasts between Kenyan and Hawaiian backgrounds suggesting local adaptation of entire visual signal

We tested whether different body regions of Hawaiian chameleons exhibited different contrasts between Hawaiian habitat background compared to their ancestral, Kenyan background. We started off testing models comparing the interaction between background environment and body region for both chromatic and achromatic contrast. However, for achromatic contrast, these models had poor convergence. Based on the raw data (Figure \@ref(fig:FigS4)B & D) there was also weak evidence that body regions differed in how they changed when viewed by conspecifics against the Hawaiian and Kenyan backgrounds. As such, we simplified models and only present the main effects of body region and background environment for achromatic contrast. However, inspection of the raw data (Figure \@ref(fig:FigS4)A & C) suggested that body regions may differ in how chromatically contrasting they are against the background environment of Hawaii and Kenya. In addition, our main results suggested that predators may deferentially drive chromatic signal conspicuousness, and given different body regions maybe more exposed to bird compared to snake predators, we fit an interaction and main effects model for chromatic contrast. 

The magnitude of chromatic contrast differences between Hawaiian chameleons against their own environment and a Kenyan enviroment did depend on the body region (Male-male display: $F_{`r intearction_CC_Disp$df_num`, `r intearction_CC_Disp$df_denom`}$ = `r intearction_CC_Disp$Fstat`, p = `r p_value(intearction_CC_Disp$p_val)`; Courtship Display: $F_{`r intearction_CC_Court$df_num`, `r intearction_CC_Court$df_denom`}$ = `r intearction_CC_Court$Fstat`, p = `r p_value(intearction_CC_Court$p_val)`, Figure \@ref(fig:FigS4)A & C & Table \@ref(tab:tableS7)). However, in all cases there was a tendeny for all body regions of Hawaiian populations to decrease in average contrast when viewed by a conspecific against a Hawaiian versus Kenyan background (Figure \@ref(fig:FigS4)A & C), and only some body regions showed a significant decrease (Table \@ref(tab:tableS8)). 

The magnitude of achromatic contrast, showed a significant overall decrease in achromatic contrast when viewed by conspevcifics against a Kenyan background (Overall Background Effect: Male-male display, $F_{`r background_AC_Disp$df_num`, `r background_AC_Disp$df_denom`}$ = `r background_AC_Disp$Fstat`, p = `r p_value(background_AC_Disp$p_val)`, Courtship Display, $F_{`r background_AC_Court$df_num`, `r background_AC_Court$df_denom`}$ = `r background_AC_Court$Fstat`, p = `r p_value(background_AC_Court$p_val)`, Figure \@ref(fig:FigS4)B & D along with Table \@ref(tab:tableS7)), and there were significant differences among body regions (Overall Body Region Effect: Male-male display, $F_{`r BodyRegion_AC_Disp$df_num`, `r BodyRegion_AC_Disp$df_denom`}$ = `r BodyRegion_AC_Disp$Fstat`, p = `r p_value(BodyRegion_AC_Disp$p_val)`, Courtship Display, $F_{`r BodyRegion_AC_Court$df_num`, `r BodyRegion_AC_Court$df_denom`}$ = `r BodyRegion_AC_Court$Fstat`, p = `r p_value(BodyRegion_AC_Court$p_val)`, Figure \@ref(fig:FigS4)B & D along with Table \@ref(tab:tableS7)). 

```{r FigS4, fig.align = 'center', fig.width = 13, fig.height = 12, fig.cap = "Local adaptation. All four body regions (gular, mid-flank, tailbase and topflank) are shown averaged across stems and leaves found in their habitat. Mean JNDs are provided along with 95% confidence intervals. A & B represent male-male contest displays whereas C & D represent courtship displays"}
# Courship data

CourtshipBgrd <- read.table("./data/Courtship_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

CourtshipBgrd <- CourtshipBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
CourtshipBgrd$BodyRegion <- factor(CourtshipBgrd$BodyRegion)


# Display data
DisplayBgrd <- read.table("./data/Display_5.csv", 
                        header=TRUE, sep=",", dec=".", strip.white=TRUE)

DisplayBgrd <- DisplayBgrd %>% 
                filter(!BodyRegion == "botflank") %>% 
                mutate(Background_pop = ifelse(Background2 == "own", Population, if_else(Background2 == "other" & Population == "Hawaii", "Kenya", "Hawaii"))) %>% 
                as.data.frame() #exclude bottom flank.
DisplayBgrd$BodyRegion <- factor(DisplayBgrd$BodyRegion) #updates levels for the variable BodyRegion

##########
# Data
##########
courtship_summary <- CourtshipBgrd %>% 
                    group_by(Population, Background_pop, BodyRegion) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>% filter(Population == "Hawaii") %>% as.data.frame() %>% mutate(Social_Context = "Courtship")

display_summary <- DisplayBgrd %>%
                group_by(Population, Background_pop, BodyRegion) %>%
                summarise( Mean_dS = mean(dS, na.rm = T), 
                             SE_dS = sd(dS)/sqrt(length(unique(ID))),
                             Upper_dS = Mean_dS + 1.96*SE_dS,
                             Lower_dS = Mean_dS - 1.96*SE_dS, 
                           Mean_dL = mean(dL, na.rm = T), 
                             SE_dL = sd(dL)/sqrt(length(unique(ID))),
                             Upper_dL = Mean_dL + 1.96*SE_dL,
                             Lower_dL = Mean_dL - 1.96*SE_dL) %>% filter(Population == "Hawaii") %>% as.data.frame() %>% mutate(Social_Context = "Male-male contest")


##########
# Plots
##########

#plots
pS4.1 <- ggplot(courtship_summary, aes(x = Background_pop, y = Mean_dS, color = BodyRegion, group = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Chromatic contrast (JND)") +
  theme_bw() +
  labs(colour = "Body Region") +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 


pS4.2 <- ggplot(courtship_summary, aes(x = Background_pop, y = Mean_dL, color = BodyRegion, group = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Achromatic contrast (JND)") +
  theme_bw() +
  labs(colour = "Body Region") +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 

pS4.3 <- ggplot(display_summary, aes(x = Background_pop, y = Mean_dL, group = BodyRegion, color = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dL, ymax = Upper_dL), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Achromatic contrast (JND)") +
  theme_bw() +
  theme(legend.position = c(0.80, 0.85),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 

pS4.4 <- ggplot(display_summary, aes(x = Background_pop, y = Mean_dS, group = BodyRegion, color = BodyRegion)) +
  geom_point(size = 3, position = position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = Lower_dS, ymax = Upper_dS), position = position_dodge(width=0.5), width = 0) + 
  geom_line(position = position_dodge(width=0.5)) + 
  scale_color_manual(values = wes_palette("Cavalcanti1")) + #Change color palette here see: https://github.com/karthik/wesanderson
  xlab("Background Environment") + 
  ylab("Chromatic contrast (JND)") +
  theme_bw() +
  theme(legend.position = "none",
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text=element_text(size=18),
    axis.title=element_text(size=20,face="bold"),
    legend.text =element_text(size = 12),
    legend.title =element_text(size = 12, face = "bold")) 

#pdf(file="./output/figures/Figure2.pdf", height = 10, width = 18)
plot_grid(pS4.4, pS4.3, pS4.1, pS4.2 , labels = c("A", "B", "C", "D"), label_size = 30,
  label_fontface = "bold", rel_widths=c(1,1))

```

```{r tableS7, tab.cap = "Estimated model parameters, standard errors (SE), degrees of freedom (df) along with 95% confidence interval for each parameter. Main effects and interaction models are presented. Only main effect models are presented for achromatic contrast (see text for details), whereas interaction models are presented for chromatic contrast. Pairwise contrasts are presented for chromatic contrast models (see Table 8) for ease of interpretation."}
table7 <- rbind(robust_localAdapt_DispBgrdAC,
                robust_DispBgrdCC,
                robust_CourtshipAC,
                robust_CourtshipCC) %>% as.data.frame()

table7$Paramater <- rownames(table7)
rownames(table7) <- NULL

table7 <- table7 %>% 
              mutate(Context = c("Male-Male Display", rep("", 12), "Courtship Display", rep("", 12)),
                     JND = c("Achromatic Contrast", rep("", 4), "Chromatic Contrast", rep("", 7), 
                             "Achromatic Contrast", rep("", 4), "Chromatic Contrast", rep("", 7))) %>% 
                      select(Context, JND, Paramater, beta, SE, df, CI_L, CI_U)

Table7 <- flextable(table7) %>% table_style10() %>% fit_to_width(max_width = 7)
Table7
```

```{r tableS8, tab.cap = "Pairwise Wald F tests comparing changes in chromatic contrast between different body regions for Hawaiian lizards against both Hawaiian and Kenyan backgrounds during male-male and courtship displats. F statistic, degrees of freedom (DF) and p-values are provided (p). A bonferroni correction to p-value is also provided to control for multiple testing. See Table 7 for model estimates."}
tab8 <- rbind(result_DisplayBgrd_pop_back_regionCC,
              result_CourtshipBgrd_pop_back_BR_CC) %>%  as.data.frame()

tab8 <- tab8 %>% mutate(Context = c("Male-Male Display", rep("",3), "Courtship Display", rep("",3)),
                        p_val = sapply(p_val, function(x) p_value(x))) %>% 
                        select(Context,c(1:8), -test, -delta, -df_num)

Table8 <- flextable(tab8) %>% table_style11() %>% fit_to_width(max_width = 7)
Table8
```

# References